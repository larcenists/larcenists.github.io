<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="AsciiDoc 8.6.9">
<title>Larceny User Manual</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(1);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Larceny User Manual</h1>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="LarcenyChapter">1. Larceny</h2>
<div class="sectionbody">
<div class="paragraph"><p>Larceny
implements the Scheme programming language
as defined by
the
<a href="#Standards">Red Edition</a> of
the
<a href="#Standards">Revised<sup>7</sup> Report</a>,
while continuing to support
the
<a href="#Standards">Revised<sup>6</sup> Report</a>,
the
<a href="#Standards">Revised<sup>5</sup> Report</a>,
and
<a href="#Standards">IEEE Standard 1178-1990</a>.
Those language standards serve as Larceny&#8217;s primary documentation.</p></div>
<div class="paragraph"><p>This manual describes aspects of Larceny that are not specified
by those standards.
For the most current version of this manual, please see
<a href="http://www.cesura17.net/~larcenists/Nightly/doc/">Larceny&#8217;s
online documentation page</a>.
For links to the Common Larceny User Manual and the Larceny
mailing list, please visit
<a href="http://www.larcenists.org/">Larceny&#8217;s main web page</a>.</p></div>
<div class="paragraph"><p>To report bugs, please send email to the Larceny
developers at <span class="monospaced">&lt;larceny@ccs.neu.edu&gt;</span>, or submit a
bug ticket at Larceny&#8217;s
<a href="https://github.com/larcenists/larceny">GitHub site</a>.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="InstallationChapter">2. Installing Larceny</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="VarietiesSection">2.1. Varieties of Larceny</h3>
<div class="paragraph"><p>There are two main varieties of Larceny.</p></div>
<div class="paragraph"><p>Native Larceny is the fastest and most convenient variety
of Larceny.  It compiles directly to native machine code
for Intel x86 or ARMv7 microprocessors running Linux and
for x86 machines running Apple&#8217;s macOS or Microsoft Windows.</p></div>
<div class="paragraph"><p>Petit Larceny compiles to C instead of machine code.  It
can be made to run on most Unix machines.</p></div>
</div>
<div class="sect2">
<h3 id="SystemRequirementsSection">2.2. System requirements</h3>
<div class="paragraph"><p>Binary distributions of native Larceny are available for
just about any Intel x86-compatible microprocessor
running a Linux, macOS, or Windows operating system,
and for ARMv7 microprocessors running Linux.
Although Larceny still uses 32-bit pointers, it will run
on 64-bit machines provided the appropriate 32-bit
libraries have been installed.</p></div>
<div class="paragraph"><p>Binary distributions of Petit Larceny are available for
x86 machines running Linux.  Petit Larceny requires the <span class="monospaced">gcc</span>
compiler as well as the appropriate 32-bit libraries.</p></div>
<div class="paragraph"><p>Unless you intend to modify Larceny yourself, you do not
need its source code, which is available at
<a href="https://github.com/larcenists/larceny">Larceny&#8217;s GitHub site</a>.</p></div>
<div class="paragraph"><p>For more details, see
<a href="https://github.com/larcenists/larceny/blob/master/doc/HOWTO-INSTALL"><span class="monospaced">doc/HOWTO-INSTALL</span></a>.
If you want to build Larceny or Petit Larceny from source code, see
<a href="http://larceny.ccs.neu.edu/doc/HOWTO-BUILD"><span class="monospaced">doc/HOWTO-BUILD</span></a>.</p></div>
</div>
<div class="sect2">
<h3 id="DownloadingSection">2.3. Downloading</h3>
<div class="paragraph"><p>The current versions of Larceny are available for
download at
<a href="http://www.larcenists.org/">Larceny&#8217;s main web page</a>.</p></div>
<div class="paragraph"><p>Larceny is distributed in two forms: as a precompiled
binary, or as source code that can be used to reconstruct
any of the precompiled binary distributions.
Unless you intend to modify Larceny yourself, you do not
need to download the source code.</p></div>
</div>
<div class="sect2">
<h3 id="InstallationSection">2.4. Installing the programs</h3>
<div class="paragraph"><p>Unpack the distribution files with an appropriate command such
as one of the following, substituting the version number (such
as 1.3) for "X.Y":</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>tar -xzf larceny-X.Y-bin-native-ia32-linux86.tar.gz
tar -xzf larceny-X.Y-bin-native-ia32-macosx.tar.gz
tar -xzf larceny-X.Y-bin-native-ia32-win32.tar.gz
tar -xzf larceny-X.Y-bin-native-armv7l-linux.tar.gz
tar -xzf larceny-X.Y-bin-petit-stdc-linux86.tar.gz
tar -xzf larceny-X.Y-src.tar.gz</pre>
</div></div>
<div class="paragraph"><p>That will create a directory with a similar name (but without
the <span class="monospaced">.tar.gz</span> suffix) in your current working directory.
That is the Larceny root directory, which you may rename
to something shorter, such as <span class="monospaced">larceny</span>; the rest of this
section will refer to it by that name.</p></div>
<div class="paragraph"><p>Assuming you have unpacked a binary distribution for Linux or
macOS, the <span class="monospaced">larceny</span> directory will contain the following files:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>larceny.bin         Run-time system
larceny.heap        Heap image with preloaded libraries and compiler
larceny             Shell script that runs the two files listed above
scheme-script       Shell script that runs Scheme scripts
compile-stale       Scheme script that compiles R7RS/R6RS libraries
compile-larceny     Scheme script that compiles a R7RS/R6RS program
startup.sch         Pathnames for the autoload and require features</pre>
</div></div>
<div class="paragraph"><p>If you unpacked a binary distribution, then you should be able to
run it immediately by making the <span class="monospaced">larceny</span> directory your current
working directory and invoking <span class="monospaced">./larceny</span>.
(If that does not work, you may need to install some 32-bit libraries
on your machine.  See
<a href="http://larceny.ccs.neu.edu/doc/HOWTO-INSTALL"><span class="monospaced">doc/HOWTO-INSTALL</span></a>.)</p></div>
<div class="paragraph"><p>Binary distributions for Windows will include a <span class="monospaced">larceny.bat</span> file
in addition to the files listed above, so you can run Larceny by
invoking <span class="monospaced">larceny</span>.
(If that does not work, you may need to tell the
<a href="http://www.thewindowsclub.com/turn-off-data-execution-prevention-dep">DEP
 feature</a>
to let Larceny opt out.)</p></div>
<div class="paragraph"><p>If you unpacked the source code there will be many other files and
directories, but <span class="monospaced">larceny.bin</span> and <span class="monospaced">larceny.heap</span> will not be present.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>You can reconstruct the <span class="monospaced">larceny.bin</span> and <span class="monospaced">larceny.heap</span> files from their
source code, but that process requires a working version of Larceny.
Unless you&#8217;re porting Larceny or Petit Larceny to a
brand new target architecture, it&#8217;s easier to obtain those
files from a binary distribution of Larceny.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>You may add the <span class="monospaced">larceny</span> directory to your standard path,
or you may install Larceny into a directory that is already
part of your standard path.</p></div>
<div class="paragraph"><p>Suppose, for example, that you want to install Larceny
in <span class="monospaced">/usr/local/bin</span> and <span class="monospaced">/usr/local/lib/larceny</span>.
To do that, move the entire <span class="monospaced">larceny</span> directory to <span class="monospaced">/usr/local/lib/larceny</span>.
Then copy the <span class="monospaced">larceny</span>, <span class="monospaced">scheme-script</span>, <span class="monospaced">compile-stale</span>,
and <span class="monospaced">compile-larceny</span> files to <span class="monospaced">/usr/local/bin</span>.</p></div>
<div class="paragraph"><p>If you are using macOS or some other non-Linux operating system,
you will need to edit the definition of <span class="monospaced">LARCENY_ROOT</span> at the head
of the <span class="monospaced">larceny</span> and <span class="monospaced">scheme-script</span> files to point to the correct
directory:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>LARCENY_ROOT=/usr/local/lib/larceny</pre>
</div></div>
<div class="paragraph"><p>You should now be able to run Larceny from any directory
by typing "<span class="monospaced">larceny</span>" at a prompt.</p></div>
</div>
<div class="sect2">
<h3 id="CompilingStdLibSection">2.5. Compiling the R7RS/R6RS standard libraries</h3>
<div class="paragraph"><p>If you are installing Petit Larceny, then you will have to
compile the R7RS/R6RS runtime and standard libraries before
you can run Larceny in R7RS or R6RS modes.</p></div>
<div class="paragraph"><p>This step is also required if you are building any variety of
Larceny from source code.
With the prebuilt native varieties of Larceny, however, this step
should not be necessary unless you change one of the files in
<span class="monospaced">lib/R7RS</span>, <span class="monospaced">lib/R6RS</span>, or <span class="monospaced">lib/SRFI</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>If the <span class="monospaced">lib/R7RS</span>, <span class="monospaced">lib/R6RS</span>, and <span class="monospaced">lib/SRFI</span> directories are
read-only, you will be less likely to touch, modify, or compile
the standard libraries by accident.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Compiling the R7RS/R6RS runtime and standard libraries is
accomplished as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    $ ./larceny
    Larceny v0.98 "General Ripper" (...)
    &gt; (require 'r7rsmode)
    &gt; (larceny:compile-r7rs-runtime)
    &gt; (exit)</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Compiling the R7RS/R6RS runtime as shown above causes
all previously compiled R7RS/R6RS libraries and top-level
programs to become <a href="#CompilingChapter">stale</a>.  That means
those previously compiled files will need to be recompiled
or removed.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="RunningChapter">3. Running Larceny</h2>
<div class="sectionbody">
<div class="paragraph"><p>For a summary of Larceny&#8217;s command-line options, ask for help:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % larceny --help</pre>
</div></div>
<div class="paragraph"><p>Larceny can run in any of these distinct modes:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>R7RS              R7RS read/eval/print loop or batch execution
R6RS              batch execution of R7RS/R6RS top-level programs
R5RS              R5RS read/eval/print loop or batch execution
Scheme script     batch execution of R7RS/R6RS Scheme scripts</pre>
</div></div>
<div class="paragraph"><p><a href="#R7rsSection">R7RS mode</a>
will run R7RS and R6RS programs,
and allows any combination of R7RS and R6RS libraries
to be imported.</p></div>
<div class="paragraph"><p><a href="#R6rsSection">R6RS mode</a>
is largely redundant with Larceny&#8217;s R7RS mode, because
every reasonable R6RS program could just as well be
executed in R7RS mode.  There is only one difference between
those two modes: R6RS mode enforces many R6RS mandates that,
among other things, forbid read/eval/print loops and most
extensions to R6RS lexical syntax.</p></div>
<div class="paragraph"><p><a href="#R5rsSection">R5RS mode</a>
extends the Scheme language described by the R5RS and
IEEE/ANSI Std 1178 by adding R7RS/R6RS lexical syntax and most
of the procedures described by the newer R6RS and R7RS standards.</p></div>
<div class="paragraph"><p><a href="#SchemeScriptsSection">Scheme scripts</a>
are directly executable R7RS/R6RS programs.</p></div>
<div class="sect2">
<h3 id="R7rsSection">3.1. R7RS mode</h3>
<div class="paragraph"><p>To execute a top-level R7RS/R6RS program that is contained
within a file named <span class="monospaced">pgm</span>, type:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    larceny pgm</pre>
</div></div>
<div class="paragraph"><p>or</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    larceny -r7 pgm</pre>
</div></div>
<div class="paragraph"><p>To interact with Larceny&#8217;s R7RS read/eval/print loop,
type the <span class="monospaced">-r7</span> and omit the program.
You will be presented with a banner message and the
read-eval-print loop&#8217;s prompt:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % larceny -r7
    Larceny vX.Y "&lt;version_name&gt;" (MMM DD YYYY HH:MM:SS, ...)
    larceny.heap, built ...

    &gt;</pre>
</div></div>
<div class="paragraph"><p>You can enter a Scheme expression at the prompt.
After a complete expression has been read, it will
be evaluated and its results printed.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>In native Larceny, the expression is evaluated by
compiling it to native machine code, which is then executed.
In Petit Larceny, the expression is evaluated by
an interpreter because compiling to C, running the
C compiler, and loading the compiled C code would
take too long.  Interpreted code behaves like compiled code,
so most of what this manual says about the compiler is also
true of Petit Larceny&#8217;s interpreter.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">(scheme base)</span> library has already been imported,
but you may want to import other libraries as well.
For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (import (scheme read)
              (scheme write)
              (scheme file)
              (scheme cxr)
              (scheme inexact)
              (scheme complex)
              (scheme char)
              (scheme load))</pre>
</div></div>
<div class="paragraph"><p>If you&#8217;d rather have Larceny import all of the standard R7RS Red
Edition and
R6RS libraries at startup, along with a few Larceny-specific
procedures, you can use the <span class="monospaced">-r7r6</span> option instead of <span class="monospaced">r7</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % larceny -r7r6
    Larceny v1.3 "Grain Alcohol and Rainwater" (...)</pre>
</div></div>
<div class="paragraph"><p>Using the <span class="monospaced">-r7r6</span> option is equivalent to using the <span class="monospaced">-r7</span>
option and then importing the <span class="monospaced">(larceny r7r6)</span> library.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Several name conflicts could not be resolved by adding R7RS extensions
to the conflicting R6RS procedure or syntax.  When the <span class="monospaced">-r7r6</span>
option is used, the <span class="monospaced">bytevector-copy!</span> and <span class="monospaced">remove</span> procedures are
imported with R7RS semantics, and the R6RS versions of those
procedures are renamed to <span class="monospaced">r6rs:bytevector-copy!</span> and
<span class="monospaced">r6rs:remove</span>; the <span class="monospaced">let-syntax</span> and <span class="monospaced">letrec-syntax</span> macros are
imported with R6RS splicing semantics, as with the <span class="monospaced">-r7</span> option,
but non-splicing versions of those macros are imported with the
names <span class="monospaced">r7rs:let-syntax</span> and <span class="monospaced">r7rs:letrec-syntax</span>.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>R7RS programs must import all libraries explicitly.  The <span class="monospaced">-r7</span> and
<span class="monospaced">-r7r6</span> options are therefore equivalent when a program is named
on the command line.  As stated in R7RS section 5.7, the implicit
import of <span class="monospaced">(scheme base)</span> is for convenience and ease of use in a
REPL, but R7RS programs do not have exactly the same semantics as
an R7RS REPL.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Larceny&#8217;s <span class="monospaced">-r7strict</span> option is similar to the <span class="monospaced">-r7</span> option, but
disables several of Larceny&#8217;s extensions to the R7RS that improve
interoperability between R7RS and R6RS libraries and programs.
See the section describing
<a href="#R7rsDeviationsSection">known deviations from the R7RS standard</a>.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>R7RS programs may contain multiple <span class="monospaced">import</span> declarations, but all
of a program&#8217;s <span class="monospaced">import</span> declarations must precede all of the
program&#8217;s commands and definitions.  As of v1.3, Larceny does not
enforce that restriction unless <span class="monospaced">-r7strict</span> is requested, but
Larceny does scan the entire program for <span class="monospaced">import</span> declarations
and invokes the executable code of all imported libraries before
the program itself executes its first command or definition.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">features</span> procedure will return a list of all <span class="monospaced">cond-expand</span>
features, including the names of
<a href="#R7rsPreDefinedSection">libraries currently available</a>
for import.
That procedure reads
the source code for all library files found in your current
<a href="#R7rsLibraryPathSection">Larceny library path</a>, so don&#8217;t be
surprised if it takes a few seconds.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (features)
    (r7rs r6rs larceny larceny-1.3
     exact-closed ratios exact-complex complex ieee-float
     full-unicode full-unicode-strings unicode-7
     ...
     (rnrs arithmetic bitwise (6))
     (rnrs arithmetic fixnums (6))
     (rnrs arithmetic flonums (6))
     (rnrs bytevectors (6))
     ...
     (scheme base)
     (scheme case-lambda)
     (scheme char)
     (scheme complex)
     (scheme cxr)
     ...
     (srfi 1)
     (srfi 1 lists)
     (srfi 2)
     ...)</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="R6rsSection">3.2. R6RS mode</h3>
<div class="paragraph"><p>To execute a top-level R6RS program that is contained
within a file named <span class="monospaced">pgm</span>, type:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    larceny -r6 pgm</pre>
</div></div>
<div class="paragraph"><p>If the program is omitted,
Larceny will read the top-level program from standard
input:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    larceny -r6 &lt; pgm</pre>
</div></div>
<div class="paragraph"><p>If you omit the program and do not redirect
standard input, then Larceny will wait patiently
for you to type a complete top-level program into
standard input, terminating it with an end-of-file.</p></div>
<div class="paragraph"><p>You probably don&#8217;t want to do that.  Had you wanted to
type R6RS code at Larceny, you&#8217;d be using Larceny&#8217;s R7RS
read/eval/print loop instead.</p></div>
</div>
<div class="sect2">
<h3 id="R5rsScriptSection">3.3. R5RS mode</h3>
<div class="paragraph"><p>To start Larceny in R5RS mode, use the <span class="monospaced">-r5</span> option:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % larceny -r5</pre>
</div></div>
<div class="paragraph"><p>Suppose <span class="monospaced">hello.sch</span> contains the following R5RS code:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    (display "Hello world!")
    (newline)
    (exit)</pre>
</div></div>
<div class="paragraph"><p>You can run <span class="monospaced">hello.sch</span> as a script by executing Larceny as
follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % larceny -r5 hello.sch</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="SchemeScriptsSection">3.4. Scheme scripts</h3>
<div class="paragraph"><p>On most Unix systems (including Linux and macOS), Larceny&#8217;s
<span class="monospaced">scheme-script</span> will execute Scheme scripts as described in R6RS
non-normative appendix D, with or without the optional script
header.  To make Scheme scripts executable in their own
right, without executing <span class="monospaced">scheme-script</span> directly, add Larceny&#8217;s
root directory to your path as described in <span class="monospaced">doc/HOWTO-INSTALL</span>,
or edit <span class="monospaced">scheme-script</span> to define <span class="monospaced">LARCENY_ROOT</span> and copy that
edited <span class="monospaced">scheme-script</span> to a directory in your path.</p></div>
<div class="paragraph"><p>Suppose, for example, that <span class="monospaced">/home/myself/hello</span> is an R7RS/R6RS
Scheme script whose first line is the optional script header
shown below:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#!/usr/bin/env scheme-script</pre>
</div></div>
<div class="paragraph"><p>If you do not have execute permission for this script,
or Larceny&#8217;s root directory is not in your path,
you can still run the script from
Larceny&#8217;s root directory as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % ./scheme-script /home/myself/hello</pre>
</div></div>
<div class="paragraph"><p>If you have execute permission for the script, and Larceny&#8217;s
root directory is in your path, you can also run the
script as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % /home/myself/hello</pre>
</div></div>
<div class="paragraph"><p>If, in addition, the directory that contains the script is
in your path, you can run the script as follows:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % hello</pre>
</div></div>
<div class="paragraph"><p>You may also pass command-line arguments to a Scheme script.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>We emphasize that Scheme scripts are not portable.
Scheme scripts are specified only by a non-binding appendix
to the R6RS, not by the R6RS proper.
Other implementations of the R7RS or R6RS may not support Scheme
scripts at all, or may give them a semantics incompatible
with Larceny&#8217;s.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>On Unix systems, standard input and output can be redirected
in the usual way.  In Larceny, standard input corresponds to
the textual port initially returned by <span class="monospaced">current-input-port</span>,
and standard output corresponds to the textual port initially
returned by <span class="monospaced">current-output-port</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>We emphasize that redirection of standard input and output
is non-portable.
Other implementations of the R7RS or R6RS may not allow redirection,
or may identify the standard input and output with ports
other than those initially returned by <span class="monospaced">current-input-port</span>
and <span class="monospaced">current-output-port</span>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="ErrorsSection">3.5. Errors</h3>
<div class="paragraph"><p>In R6RS mode, which is batch-only, errors should result in an
error message followed by a clean exit from the program.</p></div>
<div class="paragraph"><p>If your program encounters an error in an interactive mode
(R5RS or R7RS), it will enter the debugger; this is
believed to be a feature.</p></div>
<div class="paragraph"><p>Despite its crudity, and to some extent because of it,
Larceny&#8217;s debugger works at least as well with optimized
compiled code as with interpreted code.</p></div>
<div class="paragraph"><p>If you type a question mark at the debugger prompt, the
debugger will print a help message.  That message is more
helpful if you understand the Twobit compiler and
Larceny&#8217;s internal representations and invariants, but
this manual is not the place to explain those things.</p></div>
<div class="paragraph"><p>The debugging context is saved so you can exit the debugger
and re-enter it from the main read/eval/print loop&#8217;s prompt:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (debug)</pre>
</div></div>
<div class="paragraph"><p>The debugger is pretty much a prototype; you don&#8217;t need to
tell us how bad it is.</p></div>
</div>
<div class="sect2">
<h3 id="_troubleshooting">3.6. Troubleshooting</h3>
<div class="sect3">
<h4 id="_errors_when_starting_larceny">3.6.1. Errors when starting Larceny</h4>
<div class="paragraph"><p>Although Larceny runs on x86-64 machines, it requires 32-bit
libraries that are not always installed on Linux and macOS
machines.  If those libraries are absent, the operating system
will probably give you a mysterious or misleading error message
when you try to run Larceny.  For example, the operating system&#8217;s
loader may tell you "larceny.bin not found" even though it&#8217;s
perfectly obvious that <span class="monospaced">larceny.bin</span> is present within Larceny&#8217;s
root directory.  To install the necessary 32-bit libraries on
Linux machines with x86-compatible processors, someone with
superuser privileges must incant</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    sudo apt-get install lib32z1
    sudo apt-get install libc6-i386</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The names of those 32-bit packages have changed over time, and
may change again.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>For Macintosh machines, someone with administrative privileges
must install the
<a href="https://developer.apple.com/opensource/">Apple Developer Command Line Tools</a>.</p></div>
<div class="paragraph"><p>When attempting to run an R7RS/R6RS program, you may see
a warning about "<span class="monospaced">loading source in favor of stale
fasl file</span>",
following by a long series of error messages about
syntactic keywords used as a variable, ending with
the kind of error you&#8217;d expect to see when a large
R7RS/R6RS program is fed to a Scheme compiler that was
expecting to see R5RS-compatible code.  That means
the R7RS/R6RS runtime and standard libraries were not
installed correctly, or their source files have been
touched or modified since they were last compiled.
To fix the problem, restore or
<a href="#CompilingStdLibSection">recompile the R7RS standard libraries</a>.</p></div>
<div class="paragraph"><p>The precompiled binary forms of Larceny should run on
most machines that use an appropriate processor and operating
system, but the executable program "<span class="monospaced">larceny.bin</span>" may be
incompatible with very old or with very new versions of
the processor or operating system.  If that appears to be
the case, you should see whether a newer version of Larceny
fixes the problem.  If not, please report the problem
to us at <span class="monospaced">larceny@ccs.neu.edu</span>.
Please report success stories as well.</p></div>
</div>
<div class="sect3">
<h4 id="_errors_when_compiling_the_r7rs_runtime">3.6.2. Errors when compiling the R7RS runtime</h4>
<div class="paragraph"><p>If something goes wrong while
<a href="#CompilingStdLibSection">compiling the R7RS runtime</a>,
make sure you are running the copy of Larceny you think
you are running and have read and write permission
for <span class="monospaced">lib/R7RS</span>, <span class="monospaced">lib/R6RS</span>, <span class="monospaced">lib/SRFI</span>,
and all their subdirectories and files.
If you get an error message about something being
"<span class="monospaced">expanded against a different build of this library</span>",
then one or more of the compiled files in
<span class="monospaced">lib/R7RS</span> or <span class="monospaced">lib/R6RS</span> or <span class="monospaced">lib/SRFI</span>
or its subdirectories has gone
<a href="#CompilingChapter">stale</a>.
Removing all <span class="monospaced">.slfasl</span> files from <span class="monospaced">lib/R6RS</span>, <span class="monospaced">lib/R6RS</span>,
<span class="monospaced">lib/SRFI</span>, and their subdirectories will eliminate the stale file(s).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Don&#8217;t remove the <span class="monospaced">.sch</span>, <span class="monospaced">.scm</span>, <span class="monospaced">.sls</span>, or <span class="monospaced">.sld</span> files.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="AutoLoadErrorsSection">3.6.3. Autoloading errors</h4>
<div class="paragraph"><p>If Larceny attempts to autoload an imported R7RS/R6RS
library but cannot find the library, then the library
may be defined in a file that doesn&#8217;t follow
<a href="#NamingChapter">Larceny&#8217;s standard naming conventions</a>.
Another possibility is that one of the <span class="monospaced">-I</span> or <span class="monospaced">-A</span> options was
omitted or incorrect.</p></div>
<div class="paragraph"><p>If an R7RS/R6RS library is recompiled, then all compiled
libraries and top-level programs that depend upon it must
also be recompiled.  In particular, recompiling the standard
R7RS runtime will invalidate all compiled libraries and
top-level programs.  Larceny&#8217;s <span class="monospaced">compile-stale</span> script
and the
<a href="#compile-stale-libraries"><span class="monospaced">compile-stale-libraries</span></a>
procedure of <span class="monospaced">(larceny compiler)</span> make it convenient
to recompile all of the libraries and top-level
programs within any given directory in an order
consistent with their dependencies.</p></div>
</div>
<div class="sect3">
<h4 id="CrashesSection">3.6.4. Crashes</h4>
<div class="paragraph"><p>Please report all crashes with as much information is possible;
a backtrace from a debugger or a core dump is ideal (but please
do not mail the core dump without contacting us first).
Larceny&#8217;s run-time system is compiled with full debugging
information by default and a debugger like GDB should be able
to provide at least some clues.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="PerformanceSection">3.7. Performance</h3>
<div class="paragraph"><p>By default, Larceny&#8217;s Twobit compiler performs several optimizations
that are fully compatible with the R7RS but may not be fully compatible
with the older R6RS, R5RS, and IEEE-1178 standards.</p></div>
<div class="paragraph"><p>When compiling R5RS code, Larceny&#8217;s Twobit compiler normally
makes several assumptions that allow it to generate faster code;
for example, the compiler assumes Scheme&#8217;s standard
procedures will not be redefined.</p></div>
<div class="paragraph"><p>To obtain strict conformance to R5RS semantics at
the expense of slower code, use R5RS mode and
evaluate the expression</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    (compiler-switches 'standard)</pre>
</div></div>
<div class="paragraph"><p>To make the compiler generate faster code, you can promise not to
redefine standard procedures <em>and</em> not to redefine any top-level
procedure while it is running. To make this promise, evaluate</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>        (compiler-switches 'fast-safe)</pre>
</div></div>
<div class="paragraph"><p>To view the current settings of Twobit&#8217;s numerous compiler switches,
evaluate</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>        (compiler-switches)</pre>
</div></div>
<div class="paragraph"><p>All of Twobit&#8217;s compiler switches are procedures whose setting
can be changed by passing the new value of the switch as an
argument.</p></div>
<div class="paragraph"><p>For more information, evaluate</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>        (help)</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>That <span class="monospaced">help</span> procedure is predefined only in R5RS mode, and
some of the help information that will be printed may be
irrelevant to the heap image you are using.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>To alter the compiler switches from R7RS mode, or
to disable certain compiler optimizations that are
incompatible with the R6RS, see the section that
describes the
<a href="#LarcenyCompilerSection"><span class="monospaced">(larceny compiler)</span> library</a>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="LexicalChapter">4. Lexical syntax</h2>
<div class="sectionbody">
<div class="paragraph"><p>Larceny&#8217;s default lexical syntax extends the lexical syntax
required by the R5RS, R6RS, and R7RS <a href="#Standards">standards</a>.</p></div>
<div class="paragraph"><p>The R6RS forbids most lexical extensions, however, so Larceny
provides several mechanisms for turning its lexical extensions
on and off.</p></div>
<div class="sect2">
<h3 id="FlagsSection">4.1. Flags</h3>
<div class="paragraph"><p>By default, Larceny recognizes several Larceny-specific flags
of the form permitted by the R6RS.  The flag you are most
likely to encounter represents one of Larceny&#8217;s unspecified
values:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    #!unspecified</pre>
</div></div>
<div class="paragraph"><p>Certain other flags have special meanings to Larceny&#8217;s
<span class="monospaced">read</span> and <span class="monospaced">get-datum</span> procedures.  They are described below.</p></div>
</div>
<div class="sect2">
<h3 id="CaseFoldingSection">4.2. Case-sensitivity</h3>
<div class="paragraph"><p>By default, Larceny is case-sensitive.
This global default can be overridden by specifying
<span class="monospaced">--foldcase</span> or <span class="monospaced">--nofoldcase</span> on Larceny&#8217;s command line,
or by changing the value of Larceny&#8217;s <span class="monospaced">case-sensitive?</span> parameter.</p></div>
<div class="paragraph"><p>The case-sensitivity of a particular textual input port
is affected by reading one of the following flags from
the port using the <span class="monospaced">read</span> or <span class="monospaced">get-datum</span> procedures:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    #!fold-case
    #!no-fold-case</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">#!fold-case</span> flag enables case-folding on data read from
the port by the <span class="monospaced">read</span> and <span class="monospaced">get-datum</span> procedures, while
the <span class="monospaced">#!no-fold-case</span> flag disables case-folding.  The behavior
established by one of these flags extends to the next such flag
read from the port by <span class="monospaced">read</span> or <span class="monospaced">get-datum</span>.</p></div>
<div class="paragraph"><p>Both <span class="monospaced">#!fold-case</span> and <span class="monospaced">#!no-fold-case</span> are treated as comments
by Larceny&#8217;s <span class="monospaced">read</span> and <span class="monospaced">get-datum</span> procedures.  (This is a change
from Larceny v0.97.)</p></div>
</div>
<div class="sect2">
<h3 id="LexicalExtensionsSection">4.3. Lexical extensions</h3>
<div class="paragraph"><p>When a port is first opened, the Larceny-specific lexical
extensions that are accepted on the port are determined
by Larceny&#8217;s <a href="#LexicalParametersSection">lexical parameters</a>.</p></div>
<div class="paragraph"><p>The following flags change the case-sensitivity and lexical
extensions on the specific port from which they are read:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    #!r7rs         ; implies #!no-fold-case, enables R7RS syntax
    #!r6rs         ; implies #!no-fold-case, negates other flags
    #!r5rs         ; implies #!fold-case, enables R7RS syntax
    #!err5rs       ; enables R7RS/R6RS syntax with extensions
    #!larceny      ; implies #!no-fold-case and #!err5rs</pre>
</div></div>
<div class="paragraph"><p>All of those flags are treated as comments by Larceny&#8217;s <span class="monospaced">read</span>
and <span class="monospaced">get-datum</span> procedures.  (This is a change from Larceny
v0.97.)</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">#!r6rs</span> flag is the only flag that <em>disables</em> lexical
extensions.  To disable R6RS lexical extensions when new ports
are created, use the
<a href="#LexicalParametersSection"><span class="monospaced">read-r6rs-weirdness?</span> parameter</a>
described below.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="LexicalParametersSection">4.4. Lexical parameters</h3>
<div class="paragraph"><p>When given no argument, these parameters return the current
default for some aspects of the lexical syntax that will be
accepted on newly created input ports or written to newly
created output ports.
When given an argument, these procedures change the default
as specified by the argument.</p></div>
<div class="paragraph"><p>The initial values of these parameters are determined by the
<span class="monospaced">-r7r6</span>, <span class="monospaced">-r7</span>, <span class="monospaced">-r6</span>, or <span class="monospaced">-r5</span> options on Larceny&#8217;s
command line.  The <span class="monospaced">-r6</span> option disables non-R6RS lexical
syntax; the <span class="monospaced">-r7</span>, <span class="monospaced">-r7</span>, and <span class="monospaced">-r5</span> options allow both
R7RS and R6RS syntax.</p></div>
<div class="paragraph"><p><anchor id="case-sensitive?" xreflabel="case-sensitive?"></anchor>
<em>Procedure <var>case-sensitive?</var></em>
<br />
<code>(case-sensitive? <em></em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="case-sensitive?" xreflabel="case-sensitive?"></anchor>
<code>(case-sensitive? <em>boolean</em>) </code>
<br /></p></div>
<div class="paragraph"><p>If true, newly created textual input ports behave as though they
began with <span class="monospaced">#!fold-case</span>.  If false, newly created textual input
ports behave as though they began with <span class="monospaced">#!no-fold-case</span>.</p></div>
<div class="paragraph"><p><anchor id="read-r6rs-flags?" xreflabel="read-r6rs-flags?"></anchor>
<em>Procedure <var>read-r6rs-flags?</var></em>
<br />
<code>(read-r6rs-flags? <em></em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="read-r6rs-flags?" xreflabel="read-r6rs-flags?"></anchor>
<code>(read-r6rs-flags? <em>boolean</em>) </code>
<br /></p></div>
<div class="paragraph"><p>If true, allows flags other than <span class="monospaced">#!r6rs</span> to be read from
newly created ports.
If false, flags other than <span class="monospaced">#!r6rs</span> raise exceptions when
read.</p></div>
<div class="paragraph"><p><anchor id="read-r7rs-weirdness?" xreflabel="read-r7rs-weirdness?"></anchor>
<em>Procedure <var>read-r7rs-weirdness?</var></em>
<br />
<code>(read-r7rs-weirdness? <em></em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="read-r7rs-weirdness?" xreflabel="read-r7rs-weirdness?"></anchor>
<code>(read-r7rs-weirdness? <em>boolean</em>) </code>
<br /></p></div>
<div class="paragraph"><p>If true, newly created textual input ports behave as though they
began with <span class="monospaced">#!r7rs</span>, and R7RS lexical syntax will be used when
writing external representations to newly created textual output
ports.
If false, R7RS-specific extensions to R5RS/R6RS lexical syntax
may raise exceptions.</p></div>
<div class="paragraph"><p><anchor id="read-r6rs-weirdness?" xreflabel="read-r6rs-weirdness?"></anchor>
<em>Procedure <var>read-r6rs-weirdness?</var></em>
<br />
<code>(read-r6rs-weirdness? <em></em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="read-r6rs-weirdness?" xreflabel="read-r6rs-weirdness?"></anchor>
<code>(read-r6rs-weirdness? <em>boolean</em>) </code>
<br /></p></div>
<div class="paragraph"><p>If true, allows all R6RS lexical syntax on newly created ports
without disabling other lexical syntax on those ports (so
newly created textual input ports <em>do not</em> behave as though
they began with <span class="monospaced">#!r6rs</span>).
If false, R6RS-specific extensions to R5RS/R7RS lexical syntax
may raise exceptions.</p></div>
<div class="paragraph"><p>If <span class="monospaced">read-r6rs-weirdness?</span> is true and <span class="monospaced">read-r7rs-weirdness?</span>
is false, then the R6RS bytevector syntax will be used when
writing to newly opened textual output ports.  If neither
or both are true, then R7RS bytevector syntax will be used.</p></div>
<div class="paragraph"><p><anchor id="read-larceny-weirdness?" xreflabel="read-larceny-weirdness?"></anchor>
<em>Procedure <var>read-larceny-weirdness?</var></em>
<br />
<code>(read-larceny-weirdness? <em></em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="read-larceny-weirdness?" xreflabel="read-larceny-weirdness?"></anchor>
<code>(read-larceny-weirdness? <em>boolean</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Determines whether newly created textual ports allow
Larceny&#8217;s usual extensions to R5RS lexical syntax.
In addition, this parameter determines whether newly created
ports allow <span class="monospaced">#</span> as an insignificant digit, which is
required by the R5RS but disallowed by the R6RS and not
required by the R7RS.</p></div>
<div class="paragraph"><p><anchor id="read-traditional-weirdness?" xreflabel="read-traditional-weirdness?"></anchor>
<em>Procedure <var>read-traditional-weirdness?</var></em>
<br />
<code>(read-traditional-weirdness? <em></em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="read-traditional-weirdness?" xreflabel="read-traditional-weirdness?"></anchor>
<code>(read-traditional-weirdness? <em>boolean</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Determines whether newly created textual ports allow
certain lexical extensions that are deprecated in Larceny.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The semantics of &#8216;read-larceny-weirdness?` and
<span class="monospaced">read-traditional-weirdness?</span> will change over time as
deprecated misfeatures are added or dropped in response to
popular demand or apathy.
For the current semantics of these parameters, please consult
the Larceny developers&#8217; web page that describes
<a href="https://github.com/larcenists/larceny/wiki/LexicalConversion">Larceny&#8217;s
lexical syntax</a>.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="LibrariesChapter">5. R7RS/R6RS Libraries</h2>
<div class="sectionbody">
<div class="paragraph"><p>The R6RS standard added a <span class="monospaced">library</span> mechanism for batch programs.
The R7RS standard added a similar <span class="monospaced">define-library</span> syntax with
several new features, and allowed libraries to be used within
interactive read/eval/print loops as well as batch programs.</p></div>
<div class="paragraph"><p>The libraries discussed within this chapter cannot be used in
Larceny&#8217;s R5RS mode.</p></div>
<div class="sect2">
<h3 id="_interactive_computing">5.1. Interactive computing</h3>
<div class="paragraph"><p>Larceny&#8217;s <span class="monospaced">-r7</span> command-line option automatically imports the
<span class="monospaced">(scheme base)</span> library.  The <span class="monospaced">-r7r6</span> command-line option imports
all of the R7RS Red Edition and R6RS standard libraries, including
those deprecated by Larceny.</p></div>
</div>
<div class="sect2">
<h3 id="R7rsAutomaticLoadingSection">5.2. Automatic loading</h3>
<div class="paragraph"><p>As an extension to the R7RS and R6RS, Larceny attempts to load
libraries automatically when they are first imported.
Autoloading makes interactive development and
<a href="#CompilingChapter">separate compilation</a>
much more convenient.</p></div>
<div class="paragraph"><p>All of Larceny&#8217;s
<a href="#R7rsPreDefinedSection">predefined libraries</a>
can be autoloaded.</p></div>
<div class="paragraph"><p>To enable autoloading of other R7RS/R6RS libraries,
including libraries you&#8217;ve written yourself, you can:</p></div>
<div class="ulist"><ul>
<li>
<p>
use the <a href="#R7rsLibraryPathSection"><span class="monospaced">-I</span> or <span class="monospaced">-A</span> command-line options</a>
</p>
</li>
<li>
<p>
use the <a href="#R7rsLibraryPathSection"><span class="monospaced">LARCENY_LIBPATH</span></a> environment variable
</p>
</li>
<li>
<p>
use <a href="#current-require-path"><span class="monospaced">current-require-path</span></a>
</p>
</li>
<li>
<p>
edit <span class="monospaced">startup.sch</span> in Larceny&#8217;s root directory
</p>
</li>
<li>
<p>
add the libraries to Larceny&#8217;s <span class="monospaced">lib</span> directory
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="R7rsDynamicLoadingSection">5.3. Explicit loading</h3>
<div class="paragraph"><p>Larceny automatically loads R7RS/R6RS libraries when
they are first imported.  This is usually the most
convenient way to load a library, but autoloading
can&#8217;t be used to load a top-level program into an
interactive session.  Explicit
loading is needed for top-level programs, for libraries
that don&#8217;t reside in Larceny&#8217;s
<a href="#current-require-path"><span class="monospaced">current-require-path</span></a>,
and for libraries that are defined in files whose names
do not follow Larceny&#8217;s
<a href="#NamingChapter">standard naming conventions</a>.</p></div>
<div class="paragraph"><p>In theory, explicit loading is the only portable way for R7RS
programs to load a library.
<a href="#LibraryResolutionSection">There is no portable way for R6RS programs to load or import libraries</a>,
so R6RS programs must rely upon implementation-specific
mechanisms such as Larceny&#8217;s autoloading.</p></div>
<div class="paragraph"><p>For explicit loading of nonstandard libraries, top-level
programs, or unadorned R5RS-style code from a file, you
must first import a suitable load procedure:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (import (scheme load))</pre>
</div></div>
<div class="paragraph"><p>Loading a library does not automatically import it.
To use the variables and syntax that are exported by a
library, you must import that library explicitly:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (load "lib/R6RS/larceny/benchmarking.sls")
    &gt; (import (larceny benchmarking))
    &gt; (time (vector-for-each + (make-vector 1000000 0)))
    Words allocated: 3053286
    Elapsed time...: 25 ms (User: 25 ms; System: 0 ms)
    Elapsed GC time: 3 ms (CPU: 2 in 2 collections (1 minor).)</pre>
</div></div>
<div class="paragraph"><p>In Larceny, you may omit the call to <span class="monospaced">load</span> because the
<span class="monospaced">(larceny benchmarking)</span> library will be autoloaded when
it is imported.  In other implementations of the R7RS, you
may have to load all of the nonstandard libraries that will
be imported by a top-level program or library before you
load that top-level program or library.</p></div>
</div>
<div class="sect2">
<h3 id="R7rsPreDefinedSection">5.4. Predefined libraries</h3>
<div class="paragraph"><p>Larceny predefines several nonstandard libraries in addition
to the standard R7RS and R6RS libraries, and autoloads them
for your convenience.  The predefined, autoloadable libraries
include:</p></div>
<div class="paragraph"><p>Composite library:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(larceny r7r6)                         ; all R7RS/R6RS standard libraries</pre>
</div></div>
<div class="paragraph"><p><a href="../r7rs.pdf">R7RS (small)</a> standard libraries:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(scheme base)
(scheme case-lambda)
(scheme char)
(scheme complex)
(scheme cxr)
(scheme eval)
(scheme file)
(scheme inexact)
(scheme lazy)
(scheme load)
(scheme process-context)
(scheme r5rs)
(scheme read)
(scheme repl)
(scheme time)
(scheme write)</pre>
</div></div>
<div class="paragraph"><p><a href="http://trac.sacrideo.us/wg/wiki/RedEdition">R7RS Red Edition</a> libraries:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(scheme box)                           ; SRFI 111
(scheme charset)                       ; SRFI 14
(scheme comparator)                    ; SRFI 128
(scheme ephemeron)                     ; SRFI 124
(scheme generator)                     ; SRFI 121
(scheme hash-table)                    ; SRFI 125 (partially deprecated)
(scheme ideque)                        ; SRFI 134
(scheme ilist)                         ; SRFI 116
(scheme list)                          ; SRFI 1
(scheme list-queue)                    ; SRFI 117
(scheme lseq)                          ; SRFI 127
(scheme rlist)                         ; SRFI 101 (systematically renamed)
(scheme set)                           ; SRFI 113
(scheme sort)                          ; SRFI 132
(scheme stream)                        ; SRFI 41
(scheme text)                          ; SRFI 135
(scheme vector)                        ; SRFI 133</pre>
</div></div>
<div class="paragraph"><p><a href="http://www.r6rs.org/">R6RS</a> standard libraries:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(rnrs base (6))                        ; R6RS chapter 9
(rnrs unicode (6))                     ; R6RS library chapter 1
(rnrs bytevectors (6))                 ; R6RS library chapter 2
(rnrs lists (6))                       ; R6RS library chapter 3
(rnrs sorting (6))                     ; R6RS library chapter 4
(rnrs control (6))                     ; R6RS library chapter 5
(rnrs exceptions (6))                  ; R6RS library section 7.1
(rnrs conditions (6))                  ; R6RS library sections 7.2 and 7.3
(rnrs io ports (6))                    ; R6RS library sections 8.1 and 8.2
(rnrs io simple (6))                   ; R6RS library sections 8.1 and 8.3
(rnrs files (6))                       ; R6RS library chapter 9
(rnrs programs (6))                    ; R6RS library chapter 10
(rnrs arithmetic fixnums (6))          ; R6RS library section 11.2
(rnrs arithmetic flonums (6))          ; R6RS library section 11.3
(rnrs arithmetic bitwise (6))          ; R6RS library section 11.4
(rnrs syntax-case (6))                 ; R6RS library chapter 12
(rnrs hashtables (6))                  ; R6RS library chapter 13
(rnrs enums)                           ; R6RS library chapter 14
(rnrs (6))                             ; R6RS library chapter 15
(rnrs eval (6))                        ; R6RS library chapter 16
(rnrs mutable-pairs (6))               ; R6RS library chapter 17
(rnrs mutable-strings (6))             ; R6RS library chapter 18
(rnrs r5rs (6))                        ; R6RS library chapter 19</pre>
</div></div>
<div class="paragraph"><p>R6RS standard libraries that are autoloadable but deprecated in Larceny
because they have been superseded by the R7RS and SRFI 99 record
facilities:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(rnrs records procedural (6))          ; R6RS library section 6.3
(rnrs records inspection (6))          ; R6RS library section 6.4
(rnrs records syntactic (6))           ; R6RS library section 6.2</pre>
</div></div>
<div class="paragraph"><p><a href="http://srfi.schemers.org/">SRFI</a> libraries:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(srfi 1 lists)                         ; list library
(srfi 2 and-let*)                      ; extended `and` and `let*`
(srfi 5 let)                           ; extended version of `let`
(srfi 6 basic-string-ports)            ; basic string ports
(srfi 8 receive)                       ; binding to multiple values
(srfi 9 records)                       ; defining record types
(srfi 11 let-values)                   ; syntax for multiple values
(srfi 13 strings)                      ; string libraries
(srfi 14 char-sets)                    ; character-set library (default)
(srfi 14 unicode)                      ;   for all Unicode characters
(srfi 14 bmp)                          ;   for the Basic Multilingual Plane
(srfi 14 latin-1)                      ;   for ISO 8859-1 (Latin-1)
(srfi 16 case-lambda)                  ; syntax for variable arity
(srfi 17 generalized-set!)             ; generalized set!
(srfi 19 time)                         ; time data types and procedures
(srfi 23 error)                        ; error reporting mechanism
(srfi 25 multi-dimensional-arrays)     ; multi-dimensional array primitives
(srfi 26 cut)                          ; specializing without currying
(srfi 27 random-bits)                  ; sources of random bits
(srfi 28 basic-format-strings)         ; basic format strings
(srfi 29 localization)                 ; localization
(srfi 31 rec)                          ; `rec` syntax
(srfi 37)                              ; program argument processor
(srfi 38 with-shared-structure)        ; i/o for data with shared structure
(srfi 39 parameters)                   ; parameter objects
(srfi 41 streams)                      ; streams
(srfi 42 eager-comprehensions)         ; eager comprehensions
(srfi 45 lazy)                         ; iterative lazy algorithms
(srfi 48 intermediate-format-strings)  ; format
(srfi 51 rest-values)                  ; rest values hackery
(srfi 54 cat)                          ; still more formatting
(srfi 59 vicinities)                   ; vicinity
(srfi 61 cond)                         ; a more general cond clause
(srfi 63 arrays)                       ; homogeneous, heterogeneous arrays
(srfi 64 testing)                      ; an API for test suites
(srfi 67 compare-procedures)           ; three-way comparison procedures
(srfi 78 lightweight-testing)          ; lightweight testing
(srfi 87 case)                         ; a more general case clause
(srfi 98 os-environment-variables)     ; environment variables
(srfi 99 records)                      ; (composite library)
(srfi 99 records procedural)           ; (procedural API)
(srfi 99 records inspection)           ; (inspection API)
(srfi 99 records syntactic)            ; (syntactic API)
(srfi 101 random-access-lists)         ; fast and purely functional lists
(srfi 111 boxes)                       ; boxes
(srfi 112)                             ; environment inquiry
(srfi 113 sets)                        ; sets and bags
(srfi 115 regexp)                      ; regular expressions
(srfi 116 ilists)                      ; immutable lists
(srfi 117)                             ; queues based on lists
(srfi 121)                             ; generators
(srfi 123)                             ; generic accessor/modifier operators
(srfi 124)                             ; ephemerons
(srfi 126)                             ; R6RS-based hashtables
(srfi 127)                             ; lazy sequences
(srfi 128)                             ; comparators (reduced)
(srfi 129)                             ; titlecase procedures
(srfi 131)                             ; ERR5RS record syntax (reduced)
(srfi 134)                             ; immutable deques
(srfi 138)                             ; compiling top-level programs
(srfi 141)                             ; integer division
(srfi 143)                             ; fixnums
(srfi 144)                             ; flonums
(srfi 145)                             ; assumptions
(srfi 146)                             ; mappings
(srfi 151)                             ; bitwise operations
(srfi 152)                             ; string library (reduced)</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>For backward compatibility,
<span class="monospaced">(srfi 1 lists)</span> through <span class="monospaced">(srfi 101 random-access-lists)</span> are also
available with the SRFI 97 naming convention in which the number is
preceded by a colon, as in <span class="monospaced">(srfi :1 lists)</span>.
With the more liberal R7RS syntax, that SRFI 97 naming convention
is now unnecessary.
Larceny has extended the R6RS <span class="monospaced">library</span> syntax to allow R6RS libraries
to import R7RS libraries that follow the R7RS naming convention shown
in the list above.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>SRFI libraries that are autoloadable but deprecated in Larceny,
usually because they have been superseded in whole or in part by
R7RS or R6RS or other SRFI libraries or syntax (shown in parentheses):</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(srfi 0)                               ; cond-expand (scheme base)
(srfi 30)                              ; nested multi-line comments (#| |#)
(srfi 34)                              ; exception handling (scheme base)
(srfi 43 vectors)                      ; vector library (scheme vector)
(srfi 55)                              ; require-extension (import)
(srfi 60 integer-bits)                 ; (rnrs arithmetic bitwise)
(srfi 62)                              ; S-expression comments ( #; )
(srfi 66 octet-vectors)                ; (scheme base)
(srfi 69 basic-hash-tables)            ; (scheme hash-table), (srfi 126)
(srfi 71 let)                          ; extensions of let, let*, letrec
(srfi 74 blobs)                        ; (rnrs bytevectors)
(srfi 95 sorting-and-merging)          ; (scheme sorting)
(srfi 114 comparators)                 ; (scheme comparator)
(srfi 125)                             ; (scheme hash-table)
(srfi 130)                             ; (scheme text)
(srfi 132)                             ; (scheme sorting)
(srfi 133)                             ; (scheme vector)
(srfi 135)                             ; (scheme text)
(srfi 136)                             ; record types (srfi 99), (srfi 131)
(srfi 137)                             ; unique types (srfi 99), (srfi 131)
(srfi 142)                             ; bitwise operations (srfi 151)
(srfi 147)                             ; macro transformers (scheme base)</pre>
</div></div>
<div class="paragraph"><p>ERR5RS libraries that are autoloadable but deprecated in Larceny
because they have been superseded by the R7RS, SRFI 99, and SRFI 131
record facilities:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(err5rs records procedural)            ; ERR5RS records (procedural API)
(err5rs records inspection)            ; ERR5RS records (inspection API)
(err5rs records syntactic)             ; ERR5RS records (syntactic API)
(err5rs load)                          ; ERR5RS load procedure</pre>
</div></div>
<div class="paragraph"><p>Other autoloadable libraries:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(larceny load)                         ; extension of (err5rs load)
(larceny compiler)                     ; separate compilation (R7RS/R6RS)
(larceny benchmarking)                 ; timing facilities
(larceny profiling)                    ; profiling of Scheme code
(larceny r7r6)                         ; all R7RS/R6RS standard libraries
(larceny records printer)              ; custom printing of records
(larceny shivers-syntax)               ; syntax favored by Olin Shivers
(r5rs)                                 ; approximates the R5RS top level
(explicit-renaming)                    ; macros with explicit renaming</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="R7rsLibraryPathSection">5.5. Library path</h3>
<div class="paragraph"><p>Larceny&#8217;s autoload feature locates R7RS/R6RS libraries
by performing a
<a href="#LibraryTranslationSection">depth-first search</a>
of the directories that belong to Larceny&#8217;s
<a href="#current-require-path"><span class="monospaced">current-require-path</span></a>.
Libraries will not be autoloaded unless they are defined
in files whose names follow
<a href="#NamingChapter">Larceny&#8217;s standard conventions</a>.</p></div>
<div class="paragraph"><p>The
<a href="#current-require-path"><span class="monospaced">current-require-path</span></a>
is initialized by the <span class="monospaced">startup.sch</span> file in Larceny&#8217;s root
directory.</p></div>
<div class="paragraph"><p><a href="#R7rsLibraryPathSection">Larceny&#8217;s <span class="monospaced">-I</span> and <span class="monospaced">-A</span> command-line options</a>
adds one or more directories to the directories in the
<a href="#current-require-path"><span class="monospaced">current-require-path</span></a>.
The <span class="monospaced">-I</span> option specifies directories to be searched before the
standard directories; the <span class="monospaced">-A</span> option specifies directories to
be searched after the standard directories.</p></div>
<div class="paragraph"><p>You can specify those options more than once on the command line.
On most systems, you can also specify multiple directories
by separating them with a colon; under Windows, use a
semicolon as separator instead.  The first directory
listed will be searched first.</p></div>
<div class="paragraph"><p>The <span class="monospaced">LARCENY_LIBPATH</span>
environment variable can also be used to add one or more directories
to the directories in the
<a href="#current-require-path"><span class="monospaced">current-require-path</span></a>,
to be searched before the standard directories.
Multiple directories should be specified as with the <span class="monospaced">-I</span> option.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>If you have a set of portable libraries that run under more than
one implementation of the R7RS, and you want to have a special
version of some of those libraries for Larceny, you can put all
your portable versions in one directory and the Larceny-specific
versions in another.  When you run Larceny, use the <span class="monospaced">-I</span>
option and specify the Larceny-specific directory first.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">-I</span> and <span class="monospaced">-A</span> options cannot be used by Scheme scripts,
because command-line options are passed along to the Scheme
script without being interpreted by the <span class="monospaced">scheme-script</span> processor.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>We emphasize that these extensions are non-portable.
Other implementations of the R7RS or R6RS may not provide
anything comparable to Larceny&#8217;s command-line options or
<span class="monospaced">LARCENY_LIBPATH</span> environment variable.
Even if they do, their mappings from library names
to file names may be incompatible with Larceny&#8217;s.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="DefiningLibrariesSection">5.6. Defining libraries</h3>
<div class="paragraph"><p>As an extension to the R7RS and R6RS, Larceny allows a top-level
program or Scheme script to define R7RS/R6RS libraries within
the file that contains the top-level program or Scheme
script, before the import form that begins the top-level
program.  These libraries must be arranged so that no
library depends upon libraries that come later in the
file.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>We emphasize that this extension is non-portable.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="R7rsPrimitivesSection">5.7. Importing procedures from Larceny&#8217;s underlying R5RS system</h3>
<div class="paragraph"><p>Any of Larceny&#8217;s R5RS-mode top-level procedures can be imported
into an R7RS or R6RS library or program by using an import
declaration with a <span class="monospaced">primitives</span> clause that names the R5RS
procedures to be imported.  For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    (import (primitives random current-seconds
                        getenv setenv system
                        current-directory file-modification-time)
            (scheme time))</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This feature is highly non-portable.
Other implementations of the R7RS or R6RS may not even
have an underlying implementation of the R5RS.</p></div>
</td>
</tr></table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="NamingChapter">6. File Naming Conventions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="SuffixSection">6.1. Suffixes</h3>
<div class="paragraph"><p>In Larceny, file names generally follow Unix conventions,
even on Windows.  The following suffixes have special
meanings to some components of Larceny.</p></div>
<div class="hdlist"><table>
<tr>
<td class="hdlist1">
<span class="monospaced">.sld</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the preferred suffix for files that contain libraries
defined by the R7RS <span class="monospaced">define-library</span> syntax.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.sls</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the preferred suffix for files that contain libraries
defined by the R6RS <span class="monospaced">library</span> syntax.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.sps</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the preferred suffix for files that contain R7RS/R6RS
top-level programs (which consist of an <span class="monospaced">import</span> declaration
followed by definitions and expressions).
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.scm</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the preferred suffix for files that contain R7RS/R5RS
definitions and expressions but don&#8217;t contain any <span class="monospaced">import</span>
declarations and don&#8217;t define any R7RS/R6RS libraries.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.sch</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is an alternative to <span class="monospaced">.scm</span> used by Larceny developers.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.slfasl</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the suffix for files that contain the compiled form of
a <span class="monospaced">.sld</span>, <span class="monospaced">.sls</span>, or <span class="monospaced">.sps</span> file.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.fasl</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the suffix for files that contain the compiled form of
R5RS source code (usually <span class="monospaced">.scm</span> or <span class="monospaced">.sch</span>).
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.mal</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the preferred suffix for files that contain MacScheme
assembly language in symbolic form.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.lap</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the suffix for files that contain MacScheme assembly language.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.lop</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the suffix for files that contain machine code
segments in the form expected by Larceny&#8217;s heap linker.
</p>
</td>
</tr>
<tr>
<td class="hdlist1">
<span class="monospaced">.heap</span>
<br>
</td>
<td class="hdlist2">
<p style="margin-top: 0;">
is the suffix for files that contain an executable heap
image (must be combined with the
<a href="#InstallationSection"><span class="monospaced">larceny.bin</span></a> runtime).
</p>
</td>
</tr>
</table></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>In Larceny, R7RS <span class="monospaced">define-library</span> and R6RS <span class="monospaced">library</span> syntaxes
are mostly interchangeable.  The <span class="monospaced">define-library</span> syntax is more
versatile because of its <span class="monospaced">include</span> and <span class="monospaced">cond-expand</span> features,
and because it allows the name of the library being defined to
contain exact integers as well as identifiers.
For new code, we recommend the R7RS <span class="monospaced">define-library</span> syntax.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Although the R7RS <span class="monospaced">define-library</span> syntax allows <span class="monospaced">export</span> and
<span class="monospaced">import</span> declarations to be placed anywhere at the top level of
the syntax, it is standard practice to use only one <span class="monospaced">export</span>
declaration per library, placed immediately following the name
of the library, and to use only one <span class="monospaced">import</span> declaration per
library, placed immediately following the <span class="monospaced">export</span> declaration.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Some of Larceny&#8217;s compilation tools rely upon the convention
described within the note above, and may not work if that
convention is not followed.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>An R7RS library definition may be split into two or more files,
with the primary <span class="monospaced">.sld</span> file containing one or more <span class="monospaced">include</span>
declarations that include <span class="monospaced">.scm</span> files.  If <span class="monospaced">foo.sld</span> is the
primary file, then the included file is ordinarily named
<span class="monospaced">foo.body.scm</span> and placed within the same directory as <span class="monospaced">foo.sld</span>.
If more than one <span class="monospaced">.scm</span> file is included, we recommend
<span class="monospaced">foo.body1.scm</span>, <span class="monospaced">foo.body2.scm</span>, and so on.  A Larceny-specific
version of <span class="monospaced">foo.body2.scm</span> that&#8217;s conditionally included using
the <span class="monospaced">cond-expand</span> feature might be named <span class="monospaced">foo.body2.larceny.scm</span>.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Portable source code can be tailored to Larceny and other
implementations of the R7RS by combining implementation-specific
mechanisms such as Larceny&#8217;s <span class="monospaced">-I</span> option with the <span class="monospaced">include</span>
and <span class="monospaced">cond-expand</span> features of R7RS libraries.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="DirectorySection">6.2. Directories</h3>
<div class="paragraph"><p>Larceny&#8217;s root directory should contain the following
files:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    larceny
    scheme-script
    larceny.bin
    larceny.heap
    startup.sch</pre>
</div></div>
<div class="paragraph"><p>The following subdirectories are also essential for correct
operation of some features of some modes in some varieties of
Larceny:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    include
    lib
    lib/Base
    lib/Debugger
    lib/Ffi
    lib/MzScheme
    lib/R6RS
    lib/SRFI
    lib/Standard
    lib/TeachPacks</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">include</span> subdirectory is used when compiling files with
Petit Larceny.</p></div>
<div class="paragraph"><p>The <span class="monospaced">startup.sch</span> file tells Larceny&#8217;s <span class="monospaced">require</span> procedure to
search some of the <span class="monospaced">lib</span> subdirectories for libraries that are
loaded dynamically.</p></div>
</div>
<div class="sect2">
<h3 id="LibraryResolutionSection">6.3. Resolving references to libraries</h3>
<div class="paragraph"><p>The R7RS and R6RS standards do not specify any mapping from
library names to files or other locations at which the code
for a library might be found.</p></div>
<div class="paragraph"><p>R6RS non-normative appendix E emphasizes the arbitrariness of
such mappings:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Implementations may take radically different approaches to
storing source code for libraries, among them: files in the
file system where each file contains an arbitrary number of
library forms, files in the file system where each file
contains exactly one library form, records in a database,
and data structures in memory.</p></div>
<div class="paragraph"><p>Similarly, programs and scripts may be stored in a variety of
formats. Platform constraints may restrict the choices available
to an implementation, which is why the report neither mandates
nor recommends a specific method for storage.</p></div>
<div class="paragraph"><p>Implementations may provide a means for importing libraries&#8230;.</p></div>
<div class="paragraph"><p>Similarly, implementations may provide a means for executing a
program represented as a UTF-8 text file containing its source
code&#8230;.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>To put it more starkly:</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Although implementations of the R6RS <em>may</em> "provide a means for
importing libraries" or "executing a program", they don&#8217;t have
to.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>R7RS section 5.1 urges implementations to be reasonable:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Implementations which store libraries in files should document
the mapping from the name of a library to its location in the
file system.</p></div>
</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>Fortunately, <em>de facto</em> standards have been emerging.
Larceny supports those <em>de facto</em> standards by providing these
Larceny-specific mechanisms:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
R7RS/R6RS standard libraries may be imported.
Their code is located automagically.
</p>
</li>
<li>
<p>
Nonstandard libraries, such as <span class="monospaced">(larceny compiler)</span>,
may be placed in one of the directories searched
by Larceny&#8217;s
<a href="#R7rsLibraryPathSection">autoload</a> feature, provided
those libraries are located in files that follow Larceny&#8217;s
standard naming conventions as described in
<a href="#LibraryTranslationSection">the next section</a>.
</p>
</li>
<li>
<p>
R7RS/R6RS top-level programs may use
<a href="#R7rsLibraryPathSection">Larceny&#8217;s <span class="monospaced">-I</span> and <span class="monospaced">-A</span> options</a>
to specify directories that contain other libraries
the program may import, provided those libraries are
located in files that follow Larceny&#8217;s standard naming
conventions as described in
<a href="#LibraryTranslationSection">the next section</a>.
</p>
</li>
<li>
<p>
R7RS/R6RS top-level programs may use
<a href="#R7rsLibraryPathSection">Larceny&#8217;s <span class="monospaced">LARCENY_LIBPATH</span> environment variable</a>
to specify directories that contain other libraries
the program may import, provided those libraries are
located in files that follow Larceny&#8217;s standard naming
conventions as described in
<a href="#LibraryTranslationSection">the next section</a>.
</p>
</li>
<li>
<p>
R7RS/R6RS top-level programs and Scheme scripts may
<a href="#DefiningLibrariesSection">define their own libraries</a>
in the same file that contains the top-level program or
Scheme script.
</p>
</li>
</ol></div>
<div class="paragraph"><p>R7RS programs may use any of those five mechanisms,
and may also use a sixth mechanism:
An R7RS program can be written as a little configuration
program that loads the program&#8217;s libraries from files
before any libraries are imported.  This sixth mechanism
appears to be portable, but is not available to
R6RS programs executing in Larceny&#8217;s R6RS mode because
it mixes execution with macro expansion, which is
explicitly forbidden by one of the R6RS standard&#8217;s
"absolute requirements".</p></div>
</div>
<div class="sect2">
<h3 id="LibraryTranslationSection">6.4. Mapping library names to files (R7RS/R6RS)</h3>
<div class="paragraph"><p>Suppose Larceny&#8217;s <span class="monospaced">-I</span> option is used to specify
a certain <em>directory</em>, and the program imports a
nonstandard library whose name is of the form
<span class="monospaced">(<em>name1</em> <em>name2</em> &#8230; <em>lastname</em>)</span>.
Larceny will search for that library in the following
files:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>/&#8230;/<em>lastname</em>.larceny.slfasl</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>/&#8230;/<em>lastname</em>.larceny.sld</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>/&#8230;/<em>lastname</em>.larceny.sls</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>/&#8230;/<em>lastname</em>.slfasl</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>/&#8230;/<em>lastname</em>.sld</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>/&#8230;/<em>lastname</em>.sls</span>
</p>
</li>
<li>
<p>
&#8230;
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>.larceny.slfasl</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>.larceny.sld</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>.larceny.sls</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>.slfasl</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>.sld</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>/<em>name2</em>.sls</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>.larceny.slfasl</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>.larceny.sld</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>.larceny.sls</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>.slfasl</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>.sld</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>directory</em>/<em>name1</em>.sls</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>The search starts with the first of those file names,
continues with the following file names in order,
and ends when a file with one of those names is found.
The imported library <em>must</em> be one of the libraries
defined within the first file found by this search,
since the search is not continued after that first file
is found (except as noted in the next paragraph).</p></div>
<div class="paragraph"><p>If the search ends by finding a file whose name ends
with <span class="monospaced">.slfasl</span>, then Larceny checks to see whether
there is a file in the same directory with the same
root name but ending with <span class="monospaced">.sld</span> or <span class="monospaced">.sls</span> instead of <span class="monospaced">.slfasl</span>.
If the <span class="monospaced">.sld</span> or <span class="monospaced">.sls</span> file has been modified since the <span class="monospaced">.slfasl</span>
file was last modified, then a warning is printed and
the <span class="monospaced">.sld</span> or <span class="monospaced">.sls</span> file is loaded instead of the <span class="monospaced">.slfasl</span> file.
Otherwise the <span class="monospaced">.slfasl</span> file is loaded.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The R6RS allows arbitrary mappings from library names to library
code.  Larceny takes advantage of this by ignoring version
numbers when mapping library names to files, and by (virtually)
rewriting any version number that may be specified in the
definition of a library so it matches any version specification
that appears within the <span class="monospaced">import</span> form.  Furthermore Larceny
allows different versions of the same library to be imported,
but Larceny&#8217;s algorithm for resolving library references
ensures that the different versions of a library will be
identical except for their version numbers, which have no
meaningful semantics.  Although Larceny&#8217;s treatment of versions
conforms to the R6RS specification, it should be clear that
version numbers serve no purpose in Larceny.  Since the R6RS
version feature has no usefully portable semantics and has
been ignored by most implementations of the R6RS, it is
deprecated.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="RequireLibraryTranslationSection">6.5. Mapping library names to files (R5RS)</h3>
<div class="paragraph"><p>In R5RS mode, Larceny&#8217;s <span class="monospaced">-I</span> and <span class="monospaced">-A</span> options
and <span class="monospaced">LARCENY_LIBPATH</span> environment variable
may be used to
specify directories to be searched by the <span class="monospaced">require</span>
procedure, which takes a single symbol <em>libname</em> as
its argument.
The <span class="monospaced">require</span> procedure will search for the following
files in every directory that is part of the current
require path, starting with the directories specified
by LARCENY_LIBPATH and the <span class="monospaced">-I</span> and <span class="monospaced">-A</span> options:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced"><em>libname</em>.fasl</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>libname</em>.sch</span>
</p>
</li>
<li>
<p>
<span class="monospaced"><em>libname</em>.scm</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>These files are expected to contain R5RS code, not
library definitions.  Otherwise the search proceeds
much the same as when searching for an R7RS/R6RS
library.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">require</span> path is specified by <span class="monospaced">startup.sch</span> in Larceny&#8217;s
root directory, but may be changed dynamically using the
<span class="monospaced">current-require-path</span> parameter.  Changing the <span class="monospaced">require</span> path
is not recommended, however, because Larceny relies on the
<span class="monospaced">require</span> path for dynamic loading of libraries used by several
important features of Larceny, notably R7RS and R6RS modes.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><anchor id="require" xreflabel="require"></anchor>
<em>Procedure <var>require</var></em>
<br />
<code>(require <em>libname</em>) </code>
<br /></p></div>
<div class="paragraph"><p><em>libname</em> must be a symbol that names an R5RS-compatible
library within the current require path.</p></div>
<div class="paragraph"><p>If the library has not already been loaded, then it is
located and loaded.  If the library is found and loaded
successfully, then <span class="monospaced">require</span> returns true; otherwise an
error is signalled.</p></div>
<div class="paragraph"><p>If the library has already been loaded, then <span class="monospaced">require</span>
returns false without loading the library a second time.</p></div>
<div class="paragraph"><p><anchor id="current-require-path" xreflabel="current-require-path"></anchor>
<em>Procedure <var>current-require-path</var></em>
<br />
<code>(current-require-path <em></em>)  =&gt; <em>stringlist</em></code>
<br />
<anchor id="current-require-path" xreflabel="current-require-path"></anchor>
<code>(current-require-path <em>stringlist</em>) </code>
<br /></p></div>
<div class="paragraph"><p>The optional argument is a list of directory names
(without slashes at the end) that should be searched
by <a href="#require"><span class="monospaced">require</span></a> and (in R7RS/R6RS modes)
by Larceny&#8217;s <a href="#R7rsLibraryPathSection">autoload</a>
feature.
Returns the list of directory names that will be
searched.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CompilingChapter">7. Compiling Files and Libraries</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter explains how you can use Larceny to compile
Scheme source code to native machine code.</p></div>
<div class="paragraph"><p>The native varieties of Larceny have a just-in-time
compiler that compiles to native code automatically
whenever you evaluate an expression, load a source
file, or import a source library.  Even so, files
will load faster if they are compiled ahead of time.</p></div>
<div class="paragraph"><p>Petit Larceny does not have a just-in-time compiler,
so compiling ahead of time is the only way to enjoy
the speed of native machine code in Petit Larceny.</p></div>
<div class="paragraph"><p>The main disadvantage of compiling files and libraries
is that compiled code goes <em>stale</em> when its original
source code is changed or when a library on which
the compiled code depends is changed or recompiled.
Stale compiled code can be dangerously inconsistent
with libraries on which it depends, so Larceny checks
for staleness and refuses to execute a stale library
or program.</p></div>
<div class="sect2">
<h3 id="CompilingToExecutable">7.1. Compiling an R7RS/R6RS program into directly executable form</h3>
<div class="paragraph"><p>On Unix machines, the <span class="monospaced">compile-larceny</span> script can be used to
compile an R7RS/R6RS program named <span class="monospaced">pgm.sps</span> or <span class="monospaced">pgm.scm</span> into
an executable file named <span class="monospaced">pgm</span>:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % compile-larceny pgm.sps</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">compile-larceny</span> script satisfies the
<a href="http://srfi.schemers.org/srfi-138">SRFI 138</a> specification
of <span class="monospaced">compile-r7rs</span> scripts, so it accepts Larceny&#8217;s <span class="monospaced">-I</span>, <span class="monospaced">-A</span>,
and <span class="monospaced">-D</span> options, and also recognizes an option of the form
<span class="monospaced">-o pgm</span>, which can be used to specify a name other than <span class="monospaced">pgm</span>
for the executable file.</p></div>
<div class="paragraph"><p>The executable <span class="monospaced">pgm</span> file will be a shell script that calls <span class="monospaced">larceny</span>
on a <span class="monospaced">pgm.slfasl</span> file produced by <span class="monospaced">compile-larceny</span>, passing the
same <span class="monospaced">-I</span>, <span class="monospaced">-A</span>, and <span class="monospaced">-D</span> options that had been passed to
<span class="monospaced">compile-larceny</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>If any libraries used by the program are changed, touched, or
moved, the program will need to be re-compiled.  That means you
should compile all of the libraries the program uses before you
compile the program.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="CompilingR7rsSection">7.2. Compiling R7RS/R6RS libraries</h3>
<div class="paragraph"><p>To compile individual files, use the <span class="monospaced">compile-file</span> or
<span class="monospaced">compile-library</span> procedures that are exported by
<a href="#LarcenyCompilerSection"><span class="monospaced">(larceny compiler)</span></a>.</p></div>
<div class="paragraph"><p>To compile specific files while also compiling any stale
or as-yet-un-compiled libraries on which they may depend,
use the
<span class="monospaced">compile-stale-cautiously</span>,
<span class="monospaced">compile-stale-regardless</span>, or
<span class="monospaced">compile-stale-recklessly</span> procedures exported by
<a href="#LarcenyCompilerSection"><span class="monospaced">(larceny compiler)</span></a>.</p></div>
<div class="paragraph"><p>On Unix machines, the <span class="monospaced">compile-larceny</span> script can sometimes
be used to compile all of the R7RS/R6RS libraries within
one or more directories.  The following example compiles
all libraries found within <span class="monospaced">mydir1</span> and its subdirectories,
and then compiles all libraries found within <span class="monospaced">/tmp/mydir2</span>
and its subdirectories:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % compile-larceny -I mydir1 -I /tmp/mydir2</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>When <span class="monospaced">compile-larceny</span> is used to compile all libraries within
one or more directories as in the above example, it respects
import dependencies within each directory given on its command
line, but it does not respect import dependences between libraries
located in two different directories on its command line.
For the general case, in which some of the libraries in each
directory import libraries located in one of the other
directories, use procedures exported by
<a href="#LarcenyCompilerSection"><span class="monospaced">(larceny compiler)</span></a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>On Unix machines, a convenient way to compile
a group of R7RS/R6RS libraries and top-level programs
that are all located within a single directory
is to use the <span class="monospaced">compile-stale</span> script in Larceny&#8217;s root
directory.
If Larceny&#8217;s root directory is in your execution path,
then there are just two steps:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Use <span class="monospaced">cd</span> to change to the directory that contains
the R7RS/R6RS files you want to compile.  (Files
that lie within subdirectories of that directory will
be compiled also.)
</p>
</li>
<li>
<p>
Run the <span class="monospaced">compile-stale</span> script.
</p>
</li>
</ol></div>
<div class="paragraph"><p>The <span class="monospaced">compile-stale</span> script accepts Larceny&#8217;s <span class="monospaced">-I</span>, <span class="monospaced">-A</span>,
and <span class="monospaced">-D</span> options, which will be necessary if any of the
files to be compiled import from libraries located outside
of Larceny&#8217;s usual library search path.  For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % cd /tmp/mydir2
    % compile-stale -I mydir1 -I /tmp/mydir2</pre>
</div></div>
<div class="paragraph"><p>On non-Unix machines, you can accomplish the same thing
using Larceny&#8217;s R7RS mode and the <span class="monospaced">(larceny compiler)</span>
library:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    % pushd /tmp/mydir2
    % larceny -r7 -I mydir1 -I /tmp/mydir2
    Larceny v1.3

    &gt; (import (larceny compiler))

    &gt; (compile-stale-libraries)</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">compile-stale</span> script also accepts file names,
in which case it behaves like the
<a href="#compile-stale-cautiously"><span class="monospaced">compile-stale-cautiously</span></a> procedure
exported by
<a href="#LarcenyCompilerSection"><span class="monospaced">(larceny compiler)</span></a>.</p></div>
</div>
<div class="sect2">
<h3 id="CompilingR5rsSection">7.3. Compiling R5RS source files</h3>
<div class="paragraph"><p><anchor id="compile-file" xreflabel="compile-file"></anchor>
<em>Procedure <var>compile-file</var></em>
<br />
<code>(compile-file <em>sourcefile</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Compiles <em>sourcefile</em>, which must be a string naming
a file that contains R5RS source code.
If <em>faslfile</em> is supplied as a second argument,
then it must be a string naming the file that will
contain the compiled code; otherwise the name of
the compiled file is obtained from <em>sourcefile</em>
by replacing the "<span class="monospaced">.sch</span>" or "<span class="monospaced">.scm</span>" suffix with
"<span class="monospaced">.fasl</span>".</p></div>
<div class="paragraph"><p>For R7RS/R6RS libraries and top-level programs,
<a href="#CompilingR7rsSection">see above</a>.</p></div>
</div>
<div class="sect2">
<h3 id="LoadingR5intoR7Section">7.4. Loading compiled R5RS files into an R7RS session</h3>
<div class="paragraph"><p>When a file is compiled, the compiler must make assumptions
about the meanings of its free identifiers.</p></div>
<div class="paragraph"><p>When R5RS code is compiled, Larceny&#8217;s compiler assumes all
free identifiers refer to the flat global naming environment
prescribed by the R5RS standard.</p></div>
<div class="paragraph"><p>When an R7RS/R6RS library or top-level program is compiled,
Larceny&#8217;s compiler assumes all free identifiers refer to
identifiers imported from other libraries.  That assumption
is checked at both compile time and at run time.  At compile
time, the compiler refuses to compile a library if one or
more of its free identifiers is not imported.  The compiler
also records the current versions of all imported libraries,
so Larceny&#8217;s import mechanism can check at run time to make
sure all of the imported libraries are still consistent with
the libraries imported at compile time.</p></div>
<div class="paragraph"><p>The facts stated above imply compiled R5RS code can only be
loaded into the flat global environment provided by Larceny&#8217;s
underlying R5RS layer, and compiled R7RS/R6RS code can only
be imported by or loaded into an R7RS/R6RS program or
interactive session.</p></div>
<div class="paragraph"><p>R5RS source code can be loaded into an interactive R7RS
session, but it will be loaded as though it were R7RS code
rather than R5RS code.  That means loading R5RS source code
into an interactive R7RS session behaves differently from
loading compiled R5RS code into an interactive R7RS session.</p></div>
<div class="paragraph"><p>When compiled R5RS code is loaded into an interactive R7RS
session, it is loaded into Larceny&#8217;s underlying R5RS layer.
The procedures it defines can then be imported into
the R7RS session using Larceny&#8217;s
<a href="#R7rsPrimitivesSection">primitives</a>
extension to <span class="monospaced">import</span> syntax.</p></div>
<div class="paragraph"><p>When R5RS source code is loaded into an interactive R7RS
session, however, it will behave as though the source code
had been typed interactively.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="R7rsChapter">8. R7RS Standard Libraries</h2>
<div class="sectionbody">
<div class="paragraph"><p>The R7RS standard libraries are described by the
<a href="#Standards">R7RS (small)</a> standard approved in 2013
and by the
<a href="#Standards">R7RS Red Edition</a> standard approved in 2016.
The
<a href="#R7rsPreDefinedSection">Predefined libraries</a> section
of this manual lists the names of those libraries.</p></div>
<div class="paragraph"><p>Larceny provides all of the R7RS standard libraries,
supports the full numeric tower, and can represent all
Unicode characters.</p></div>
<div class="paragraph"><p>Binary releases of Larceny also support Unicode strings.
(When built from source code, Larceny can be configured to
use Latin-1 strings instead of Unicode.)</p></div>
<div class="paragraph"><p>When Larceny is invoked with the <span class="monospaced">-r7r6</span> option on its
command line, and no program is given on the command line,
all of the standard R7RS and R6RS libraries
are imported at startup.  When invoked with the <span class="monospaced">-r7</span>
option and no program, only <span class="monospaced">(scheme base)</span> is imported at startup.
When a program is given, the <span class="monospaced">-r7r6</span> and <span class="monospaced">-r7</span> options
are equivalent: both imply the R7RS mode of execution,
but the program is responsible for importing all libraries
it uses, which makes it possible to write R7RS programs
that do not import <span class="monospaced">(scheme base)</span>.</p></div>
<div class="sect2">
<h3 id="R7rsDeviationsSection">8.1. Known deviations from the R7RS standard</h3>
<div class="paragraph"><p>To simplify interoperability with R6RS libraries and
programs, and to improve the performance of flonum and
complex arithemetic, the <span class="monospaced">integer?</span>, <span class="monospaced">rational?</span>, and <span class="monospaced">real?</span>
procedures exported by <span class="monospaced">(scheme base)</span> have R6RS semantics.
It is not clear whether that is fully compatible with the
R7RS (small) standard, because the R7RS specification of
those procedures appears to contradict itself.</p></div>
<div class="paragraph"><p>To simplify interoperability with R6RS libraries and programs,
<span class="monospaced">let-syntax</span> and <span class="monospaced">letrec-syntax</span> have R6RS semantics.  The R6RS
standard requires <span class="monospaced">let-syntax</span> and <span class="monospaced">letrec-syntax</span> to splice
their macro-expanded bodies into their context instead of
introducing a new contour.  That R6RS behavior is not explicitly
forbidden by the R7RS, but archives of the working group that
developed the R7RS standard record a deliberate decision to break
backward compatibility with R6RS by requiring <span class="monospaced">let-syntax</span> and
<span class="monospaced">letrec-syntax</span> to introduce a new contour.  Although the R7RS
(small) standard fails to mention this significant change in
semantics, that must have been an oversight.  Programs that
depend upon having <span class="monospaced">let-syntax</span> and <span class="monospaced">letrec-syntax</span> introduce
new contours can be run in Larceny&#8217;s <span class="monospaced">-r7strict</span> mode, which
will also disable several other generally desirable extensions
and enhancements Larceny has made to the R7RS.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>If some library or program depends upon <span class="monospaced">-r7strict</span>, it can be
<a href="#CompilingR7rsSection">compiled separately</a> with <span class="monospaced">-r7strict</span> in effect,
allowing its compiled form to interoperate with libraries and
programs that use extensions disabled by <span class="monospaced">-r7strict</span>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>If any other R7RS feature is missing or incompatible with
the R7RS (small) standard, it&#8217;s a bug.</p></div>
<div class="paragraph"><p>As of Larceny v1.3, the known deviations from the R7RS (small)
standard are:</p></div>
<div class="ulist"><ul>
<li>
<p>
Libraries with names of the form <span class="monospaced">(primitives x ...)</span> cannot be imported.
(Larceny v1.3 reserves <a href="#R7rsPrimitivesSection">primitives</a>
as a keyword for importing identifiers from the R5RS global
environment.)
</p>
</li>
<li>
<p>
<span class="monospaced">include</span> and <span class="monospaced">include-ci</span> are allowed only as library declarations,
and are not allowed in expression contexts.
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="R6rsChapter">9. R6RS Standard Libraries</h2>
<div class="sectionbody">
<div class="paragraph"><p>This chapter explains which features of the R6RS standard
libraries are available in each of Larceny&#8217;s major modes
of execution.</p></div>
<div class="paragraph"><p>Larceny was the first substantially complete implementation
of the R6RS.  Any R6RS features that are missing from
Larceny&#8217;s R6RS mode
are missing because of bugs or because the features are
deprecated in Larceny.</p></div>
<div class="paragraph"><p>Larceny is R6RS-compatible but not R6RS-conforming.
When Larceny is said to support a feature of the R6RS,
that means the feature is present and will behave as
specified by the R6RS so long as no exception is raised
or expected.
Larceny does not always raise the specific conditions
specified by the R6RS, and does not perform all of the
checking for portability problems that is mandated by
the R6RS.  These deviations do not affect the execution
of production code, and do not compromise Larceny&#8217;s
traditional safety.</p></div>
<div class="paragraph"><p>For example, Larceny has extended the R6RS <span class="monospaced">library</span> syntax to
allow R6RS libraries to import R7RS libraries even when the
names of those imported libraries use the more liberal R7RS
syntax.</p></div>
<div class="paragraph"><p>Furthermore, Larceny has extended several R6RS procedures so
they behave as specified by the newer R7RS (small) standard.
In Larceny, for example, the <span class="monospaced">utf8-&gt;string</span> procedure
accepts one, two, or three arguments,
and the <span class="monospaced">finite?</span> procedure accepts any object as its argument.
According to the R6RS, <span class="monospaced">utf8-&gt;string</span> <em>must</em> raise an
exception when passed more than one argument, and
<span class="monospaced">finite?</span> <em>must</em> raise an exception if it detects an
argument that is not a real number.  Although the R6RS
says these exceptions are "absolute requirements", they
interfere with interoperability between R6RS and R7RS code,
and are best honored in the breach.</p></div>
<div class="sect2">
<h3 id="R6rsBaseSection">9.1. Base library</h3>
<div class="paragraph"><p>R7RS and R6RS modes support all procedures and syntaxes
exported by the <span class="monospaced">(rnrs base)</span> library.</p></div>
<div class="paragraph"><p>Larceny&#8217;s R5RS mode does not support <span class="monospaced">library</span>, <span class="monospaced">import</span>, or
<span class="monospaced">identifier-syntax</span>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>As of v0.99, Larceny ignores the R6RS <span class="monospaced">for</span> and <span class="monospaced">meta</span> keywords
of R6RS <span class="monospaced">library</span> syntax, which were intended to enforce proper
phasing in libraries and programs that define <span class="monospaced">syntax-case</span> macros.
Several other implementations of the R6RS have been ignoring those
keywords, and there is growing consensus that they are unnecessary
and unhelpful.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The semantics of <span class="monospaced">quasiquote</span>, <span class="monospaced">let-syntax</span>, and <span class="monospaced">letrec-syntax</span>
differ between the R5RS, R6RS, and R7RS.  Larceny&#8217;s R5RS mode
still supports the R5RS semantics.  R7RS and R6RS modes support
the R6RS semantics.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="R6rsUnicodeSection">9.2. Unicode</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the <span class="monospaced">(rnrs unicode)</span>
library.</p></div>
<div class="paragraph"><p>Larceny v1.3 conforms to
<a href="#Standards">The Unicode Standard</a>, Version 7.0.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsBytevectorsSection">9.3. Bytevectors</h3>
<div class="paragraph"><p>R7RS and R6RS modes support all procedures and syntaxes
exported by <span class="monospaced">(rnrs bytevectors)</span>, but the <span class="monospaced">endianness</span>
syntax is deprecated because it is redundant with <span class="monospaced">quote</span>.
Larceny&#8217;s R5RS mode does not support <span class="monospaced">endianness</span>.</p></div>
<div class="paragraph"><p>In Larceny, any symbol names a supported endianness.
The symbols <span class="monospaced">big</span> and <span class="monospaced">little</span> have their expected meanings.
All other symbols mean <span class="monospaced">(native-endianness)</span> with respect
to integer operations, but mean the opposite of
<span class="monospaced">(native-endianness)</span> with respect to
<a href="#Standards">IEEE-754</a> operations.
For string operations, the endianness must be the symbol
<span class="monospaced">big</span> or the symbol <span class="monospaced">little</span>.  All of these extensions are
permitted by the R6RS standard.</p></div>
<div class="paragraph"><p>Larceny&#8217;s <span class="monospaced">utf16-&gt;string</span> and <span class="monospaced">utf32-&gt;string</span> accept one,
two, or three arguments.  The R6RS specification of these
procedures does not allow them to accept a single argument,
but that is believed to be an error in the R6RS.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsListsSection">9.4. Lists</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<span class="monospaced">(rnrs lists)</span> library.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsSortingSection">9.5. Sorting</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<span class="monospaced">(rnrs sorting)</span> library.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsControlSection">9.6. Control</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<span class="monospaced">(rnrs control)</span> library.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsRecordsSection">9.7. Records</h3>
<div class="paragraph"><p>R7RS and R6RS modes support all procedures and syntaxes
exported by
<span class="monospaced">(rnrs records procedural)</span>,
<span class="monospaced">(rnrs records inspection)</span>, and
<span class="monospaced">(rnrs records syntactic)</span>.</p></div>
<div class="paragraph"><p>Those libraries are deprecated, however;
the <span class="monospaced">make-record-constructor-descriptor</span> procedure does
not simplify unusually complex cases enough to justify
the complexity it adds to typical cases, and
the entire syntactic layer is gratuitously incompatible
with the procedural layer.</p></div>
<div class="paragraph"><p>Larceny extends the R7RS <span class="monospaced">define-record-type</span> syntax exported
by <span class="monospaced">(scheme base)</span> to accept the deprecated R6RS syntax, and
extends the deprecated <span class="monospaced">define-record-type</span> syntax exported
by <span class="monospaced">(rnrs records syntactic)</span> to accept R7RS syntax.
Larceny&#8217;s unification of the two syntaxes within a single
implementation of <span class="monospaced">define-record-type</span> allows libraries and
programs to import both <span class="monospaced">(scheme base)</span> and <span class="monospaced">(rnrs)</span> without
having to rename one version of <span class="monospaced">define-record-type</span>.</p></div>
<div class="paragraph"><p>Larceny also extends its unified R7RS/R6RS <span class="monospaced">define-record-type</span>
to support all features of <span class="monospaced">(srfi :99 records syntactic)</span> and
<span class="monospaced">(srfi 131)</span>.
So long as the deprecated R6RS syntax is not used, Larceny&#8217;s
<span class="monospaced">define-record-type</span> is fully compatible with the procedural
layers defined by <span class="monospaced">(srfi :99 records procedural)</span> and by
<span class="monospaced">(rnrs records procedural)</span>.</p></div>
<div class="paragraph"><p>Larceny&#8217;s R5RS mode supports all features of the deprecated
<span class="monospaced">(rnrs records procedural)</span> and <span class="monospaced">(rnrs records inspection)</span>
libraries.  R5RS mode does not support <span class="monospaced">(rnrs records syntactic)</span>.</p></div>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<a href="#Err5rsRecordsProceduralSection"><span class="monospaced">(err5rs records procedural)</span></a>
and
<a href="#Err5rsRecordsInspectionSection"><span class="monospaced">(err5rs records inspection)</span></a>
libraries.  R7RS and R6RS modes also support the
<a href="#Err5rsRecordsSyntacticSection"><span class="monospaced">(err5rs records syntactic)</span></a>
library.
These libraries are equivalent to the
<span class="monospaced">(srfi :99 records procedural)</span>,
<span class="monospaced">(srfi :99 records inspection)</span>, and
<span class="monospaced">(srfi :99 records syntactic)</span> libraries.</p></div>
<div class="paragraph"><p>The record definition syntax of
<a href="http://srfi.schemers.org/srfi-9/">SRFI 9</a>
is a proper subset
of the syntax provided by the <span class="monospaced">(err5rs records syntactic)</span>
library.  In R5RS mode, SRFI 9 can be loaded dynamically
using the
<a href="#require"><span class="monospaced">require</span></a> procedure:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (require 'srfi-9)</pre>
</div></div>
<div class="paragraph"><p>We recommend the R7RS, SRFI 9, and/or SRFI 131 libraries be used instead
of the corresponding R6RS libraries.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The R6RS spouts some tendentious nonsense about procedural
records being slower than syntactic records, but this is not
true of Larceny&#8217;s records, and is unlikely to be true of other
implementations either.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Larceny continues to support its old-style
records, which are almost but not quite compatible
with R7RS and R6RS records.  This can be confusing,
since some of Larceny&#8217;s procedures have the same names
as R6RS procedures.  That has made it necessary to overload
those procedures to work with both old-style and R6RS
records.  We apologize for the mess.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="R6rsConditionsSection">9.8. Exceptions and conditions</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<span class="monospaced">(rnrs exceptions)</span> and <span class="monospaced">(rnrs conditions)</span> libraries.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsIoSection">9.9. Input and output</h3>
<div class="paragraph"><p>R7RS and R6RS modes support all names exported by the
<span class="monospaced">(rnrs io ports)</span>, <span class="monospaced">(rnrs io simple)</span>, and
<span class="monospaced">(rnrs files)</span> libraries.</p></div>
<div class="paragraph"><p>The <span class="monospaced">buffer-mode</span>, <span class="monospaced">eol-style</span>, and <span class="monospaced">error-handling-mode</span>
syntaxes are deprecated because they are redundant
with <span class="monospaced">quote</span>.  Larceny may provide these deprecated syntaxes
in the form of procedures rather than syntax, but this
deviation from R6RS semantics cannot be detected by
portable R6RS programs.</p></div>
<div class="paragraph"><p>Larceny&#8217;s R5RS mode supports all non-deprecated features
of those libraries.</p></div>
<div class="paragraph"><p>Larceny supports four distinct buffer modes: <span class="monospaced">none</span>,
<span class="monospaced">line</span>, <span class="monospaced">datum</span>, and <span class="monospaced">block</span>.  The R6RS requires
the <span class="monospaced">buffer-mode</span> syntax to raise an exception for the
<span class="monospaced">datum</span> buffer mode, which is the buffer mode Larceny
uses for interactive output ports.</p></div>
<div class="paragraph"><p>In Larceny, any symbol names a supported end-of-line
style.  All end-of-line and error-handling-mode symbols
whose meanings are not described by the R6RS have
locale-dependent meanings, which is an extension
permitted by the R6RS standard.</p></div>
<div class="paragraph"><p>Although Larceny supports the UTF-16 codec, it is not
really useful on Windows machines (where it should be
most useful) because Larceny&#8217;s low-level file system
mimics a byte-oriented Unix file system even on
Windows.  This problem should be addressed in some
future version of Larceny.</p></div>
<div class="paragraph"><p>The most up-to-date list of known deviations from R6RS
io semantics can be found on the web page
that describes the current status of
<a href="https://github.com/larcenists/larceny/wiki/DargoMode">Larceny&#8217;s R6RS-compatible mode</a>.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsProgramsSection">9.10. Programs</h3>
<div class="paragraph"><p>R7RS and R6RS modes support the <span class="monospaced">(rnrs programs)</span> library.</p></div>
<div class="paragraph"><p>Larceny&#8217;s R5RS mode provides the <span class="monospaced">exit</span> procedure but
not the <span class="monospaced">command-line</span> procedure of that library.
Larceny&#8217;s traditional <span class="monospaced">command-line-arguments</span> procedure
can be used to implement an approximation to <span class="monospaced">command-line</span>.
For a definition, see <span class="monospaced">lib/R6RS/rnrs/programs.sls</span>.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsArithmeticSection">9.11. Arithmetic</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<span class="monospaced">(rnrs arithmetic fixnums)</span>,
<span class="monospaced">(rnrs arithmetic flonums)</span>, and
<span class="monospaced">(rnrs arithmetic bitwise)</span>
libraries.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>R6RS fixnum and flonum operations may be slower than the
corresponding generic operations, since the fixnum and flonum
operations are required to check their arguments and may also
have to check their results.
Isolated operations in small micro-benchmarks are likely to
be slower than groups of similar operations in larger programs,
however, because Larceny&#8217;s compiler removes redundant checks
and propagates type information.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="R6rsSyntaxCaseSection">9.12. Syntax-case</h3>
<div class="paragraph"><p>R7RS and R6RS modes support the <span class="monospaced">(rnrs syntax-case)</span> library.
Larceny&#8217;s R5RS mode does not.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsHashtablesSection">9.13. Hashtables</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<span class="monospaced">(rnrs hashtables)</span> library.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Larceny&#8217;s traditional <span class="monospaced">make-hashtable</span> procedure has been
renamed to <span class="monospaced">make-oldstyle-hashtable</span>.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>When you use Larceny&#8217;s R5RS or R7RS mode to dump a heap image
that contains <span class="monospaced">eq?</span> or <span class="monospaced">eqv?</span> hashtables you have created, they
are automatically reset so they will
rehash themselves whenever you begin a new session with the
dumped heap.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="R6rsEnumerationsSection">9.14. Enumeration sets</h3>
<div class="paragraph"><p>R7RS and R6RS modes support the <span class="monospaced">(rnrs enums)</span> library.
Larceny&#8217;s R5RS mode provides all of the procedures exported by
<span class="monospaced">(rnrs enums)</span> but does not provide the <span class="monospaced">define-enumeration</span>
syntax.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsEvalSection">9.15. Eval</h3>
<div class="paragraph"><p>R7RS and R6RS modes support the <span class="monospaced">(rnrs eval)</span> library.
Larceny&#8217;s R5RS mode provides an R5RS-compatible eval procedure,
not an R6RS-compatible eval procedure, and does not provide the
<span class="monospaced">environment</span> procedure.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsMutableStringsSection">9.16. Mutable pairs and strings</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<span class="monospaced">(rnrs mutable-pairs)</span> and <span class="monospaced">(rnrs mutable-strings)</span> libraries.</p></div>
</div>
<div class="sect2">
<h3 id="R6rsR5rsSection">9.17. R5RS</h3>
<div class="paragraph"><p>All of Larceny&#8217;s modes support all features of the
<span class="monospaced">(rnrs r5rs)</span> library.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="LarcenyErr5rsLibrariesChapter">10. Larceny&#8217;s R7RS/R6RS Libraries</h2>
<div class="sectionbody">
<div class="paragraph"><p>Larceny provides libraries for compiling
R7RS/R6RS libraries and for timing benchmarks.</p></div>
<div class="sect2">
<h3 id="LarcenyLoadSection">10.1. Load</h3>
<div class="paragraph"><p>The <span class="monospaced">(larceny load)</span> library exports both the
<span class="monospaced">load</span> procedure of <span class="monospaced">(scheme load)</span>
and Larceny&#8217;s <span class="monospaced">r5rs:require</span> procedure, which is a renaming of
the <a href="#require"><span class="monospaced">require</span></a> procedure used by
Larceny&#8217;s R5RS mode.</p></div>
<div class="paragraph"><p>In Larceny&#8217;s R7RS mode,
the <span class="monospaced">load</span> procedure can load
R5RS libraries and programs as well as R7RS/R6RS
libraries.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>Loading an R5RS source file into an R7RS session is not equivalent
to loading the compiled form of that file.  For explanation, see
the previous section on
<a href="#LoadingR5intoR7Section">loading compiled R5RS files into an R7RS session</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The <span class="monospaced">r5rs:require</span> procedure should be used only for dynamic loading of
R5RS libraries into Larceny&#8217;s underlying R5RS system.  The
variables defined by that library can be imported into
an R7RS session or R7RS/R6RS library or program using a
<a href="#R7rsPrimitivesSection"><span class="monospaced">primitives</span></a>
clause in an <span class="monospaced">import</span> form.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>These procedures should be used only at an interactive top
level and in files that will be loaded into an interactive top
level.  Calls to these procedures have no effect at compile
time, and should not appear in files that will be compiled
separately; use the <span class="monospaced">define-library</span> and <span class="monospaced">import</span> syntaxes
instead.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="LarcenyCompilerSection">10.2. Compiler</h3>
<div class="paragraph"><p>The <span class="monospaced">(larceny compiler)</span> library exports the
<span class="monospaced">load</span> and <span class="monospaced">r5rs:require</span> procedures of <span class="monospaced">(larceny load)</span>,
the
<a href="#current-require-path"><span class="monospaced">current-require-path</span></a> and
<a href="#current-directory"><span class="monospaced">current-directory</span></a>
parameters, the
<a href="#compile-file"><span class="monospaced">compile-file</span></a>,
<a href="#compile-library"><span class="monospaced">compile-library</span></a>,
<a href="#compile-stale-libraries"><span class="monospaced">compile-stale-libraries</span></a>,
<a href="#compile-stale-cautiously"><span class="monospaced">compile-stale-cautiously</span></a>,
<a href="#compile-stale-regardless"><span class="monospaced">compile-stale-regardless</span></a>, and
<a href="#compile-stale-recklessly"><span class="monospaced">compile-stale-recklessly</span></a>
procedures described below,
and the
<a href="#compiler-switches"><span class="monospaced">compiler-switches</span></a> procedure.</p></div>
<div class="paragraph"><p>These procedures can be used to compile R7RS/R6RS
libraries and top-level programs before they are imported
or executed.
This is especially important for Petit Larceny, which
would otherwise use an interpreter.  For native Larceny,
whose just-in-time compiler generates native machine code
as source libraries and programs are loaded, imported, or
executed, the main advantage of separate compilation is
that compiled libraries and programs will load much
faster than source libraries and programs.</p></div>
<div class="paragraph"><p>The main disadvantage of separate compilation is that
compiled libraries and programs go <em>stale</em> when their
source code is changed or when a library on which they
depend is changed or recompiled.  Stale libraries and
programs can be dangerously inconsistent with libraries
on which they depend, so Larceny checks for staleness
and refuses to execute a stale library or program.
The
<a href="#compile-stale-libraries"><span class="monospaced">compile-stale-libraries</span></a>,
<a href="#compile-stale-cautiously"><span class="monospaced">compile-stale-cautiously</span></a>,
<a href="#compile-stale-regardless"><span class="monospaced">compile-stale-regardless</span></a>, and
<a href="#compile-stale-recklessly"><span class="monospaced">compile-stale-recklessly</span></a>,
procedures make it easier to recompile stale
libraries and programs.</p></div>
<div class="paragraph"><p><anchor id="compile-file" xreflabel="compile-file"></anchor>
<em>Procedure <var>compile-file</var></em>
<br />
<code>(compile-file <em>sourcefile</em> <em>[slfaslfile]</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Compiles <em>sourcefile</em>, which must be a string naming
a file that contains source code for one or more
R7RS/R6RS libraries or a top-level program.
If <em>slfaslfile</em> is supplied as a second argument,
then it must be a string naming the file that will
contain the compiled code; otherwise the name of
the compiled file is obtained from <em>sourcefile</em>
by replacing the "<span class="monospaced">.sld</span>" or "<span class="monospaced">.sls</span>" suffix with "<span class="monospaced">.slfasl</span>".</p></div>
<div class="paragraph"><p><anchor id="compile-library" xreflabel="compile-library"></anchor>
<em>Procedure <var>compile-library</var></em>
<br />
<code>(compile-library <em>sourcefile</em> <em>[slfaslfile]</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Compiles <em>sourcefile</em>, which must be a string naming
a file that contains source code for one or more
R7RS/R6RS libraries.
Apart from its unwillingness to compile top-level
programs, <span class="monospaced">compile-library</span> behaves the same as
<span class="monospaced">compile-file</span> above.</p></div>
<div class="paragraph"><p><anchor id="compile-stale-libraries" xreflabel="compile-stale-libraries"></anchor>
<em>Procedure <var>compile-stale-libraries</var></em>
<br />
<code>(compile-stale-libraries <em></em>) </code>
<br />
<anchor id="compile-stale-libraries" xreflabel="compile-stale-libraries"></anchor>
<code>(compile-stale-libraries <em>changedfile</em>) </code>
<br /></p></div>
<div class="paragraph"><p>If no argument is supplied, then all "<span class="monospaced">.sld</span>" and "<span class="monospaced">.sls</span>" files that
lie within the current directory or a subdirectory are
recompiled.</p></div>
<div class="paragraph"><p>If <em>changedfile</em> is supplied, then it must be a string
giving the absolute pathname of a file.
(In typical usage, <em>changedfile</em> is a source file that
has been modified, making it necessary to recompile all
files that depend upon it.)
Compiles all R7RS/R6RS library files that lie within
the same directory as <em>changedfile</em> or a subdirectory,
and have not yet been compiled or whose compiled files
are older than <em>changedfile</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>In future versions of Larceny, <span class="monospaced">compile-stale-libraries</span>
might compile only the source files that depend upon
<em>changedfile</em>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><anchor id="compile-stale-recklessly" xreflabel="compile-stale-recklessly"></anchor>
<em>Procedure <var>compile-stale-recklessly</var></em>
<br />
<code>(compile-stale-recklessly <em>sourcefile &#8230;</em>) </code>
<br />
<anchor id="compile-stale-regardless" xreflabel="compile-stale-regardless"></anchor>
<em>Procedure <var>compile-stale-regardless</var></em>
<br />
<code>(compile-stale-regardless <em>sourcefile &#8230;</em>) </code>
<br />
<anchor id="compile-stale-cautiously" xreflabel="compile-stale-cautiously"></anchor>
<em>Procedure <var>compile-stale-cautiously</var></em>
<br />
<code>(compile-stale-cautiously <em>sourcefile &#8230;</em>) </code>
<br /></p></div>
<div class="paragraph"><p>All three of these procedures attempt to compile the given
source files together with all of the files they depend upon
that have not yet been compiled or have been compiled but
gone stale.  They differ in how they behave when one of the
files to be compiled lies outside the current directory or
when one of the files to be compiled is imported, directly
or indirectly, by a file that is neither passed as an argument
nor relied upon by one of the files passed as an argument.</p></div>
<div class="paragraph"><p>The <span class="monospaced">compile-recklessly</span> procedure compiles the given files
along with all of the files on which they depend that have
not yet been compiled or have gone stale or import a library
from one of the files that will be compiled.
If there are available libraries that depend upon one of the
files to be compiled but are not imported (directly or
indirectly) by one of the given files, then they too will
need to be re-compiled; the <span class="monospaced">compile-recklessly</span> procedure
does not re-compile those libraries, but it does print a
message listing them.</p></div>
<div class="paragraph"><p>The <span class="monospaced">compile-regardless</span> procedure behaves the same as the
<span class="monospaced">compile-recklessly</span> procedure when all of the files to be
compiled and all of the other files that would need to be
re-compiled are located within the current directory.  If
not, <span class="monospaced">compile-regardless</span> does not compile any files but
does print a message telling how to compile all of the
files using <span class="monospaced">compile-file</span>.</p></div>
<div class="paragraph"><p>The <span class="monospaced">compile-cautiously</span> procedure behaves the same as the
<span class="monospaced">compile-regardless</span> procedure when all of the files can be
compiled without affecting any available libraries that will
not be compiled.  If compiling the files would make it
necessary to re-compile some other library, <span class="monospaced">compile-cautiously</span>
does not compile any files but does print a message telling
how to compile all of the files using <span class="monospaced">compile-file</span>.</p></div>
<div class="paragraph"><p>Suppose, for example, that <span class="monospaced">/tmp/Foo</span> and <span class="monospaced">/tmp/Bar</span> contain
these four files:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>% cat /tmp/Foo/foo.sps
(import (scheme base)
        (scheme write)
        (foo)
        (bar))
(write (list y x)) (newline)
% cat /tmp/Foo/foo.sld
(define-library (foo)
  (export x)
  (import (scheme base)
          (bar))
  (begin (define x 97)))
% cat /tmp/Bar/bar.sps
(import (scheme base)
        (scheme write)
        (foo)
        (bar))
(write (list x y)) (newline)
% cat /tmp/Bar/bar.sld
(define-library (bar)
  (export y)
  (import (scheme base))
  (begin (define y 98)))</pre>
</div></div>
<div class="paragraph"><p>The two programs can be run without compiling any of those files:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>% larceny -I /tmp/Foo -I /tmp/Bar /tmp/Foo/foo.sps
(98 97)
% larceny -I /tmp/Foo -I /tmp/Bar /tmp/Bar/bar.sps
(97 98)</pre>
</div></div>
<div class="paragraph"><p>The <span class="monospaced">compile-stale-cautiously</span> and <span class="monospaced">compile-stale-regardless</span>
procedures refuse to compile the <span class="monospaced">bar.sps</span> program because it
imports a library located in another directory that has not been
compiled.  The <span class="monospaced">compile-stale-recklessly</span> procedure goes ahead
and compiles that library even though it is located in a different
directory:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>% larceny -I /tmp/Foo -I /tmp/Bar -r7
Larceny v1.3

&gt; (import (larceny compiler))

&gt; (parameterize ((current-directory "/tmp/Bar"))
    (compile-stale-cautiously "bar.sps"))

Libraries and programs to be compiled:

    (bar)
    (foo)
    (#(program) 1)

Minimal files to be compiled:

    "/tmp/Bar/bar.sld"
    "/tmp/Foo/foo.sld"
    "/tmp/Bar/bar.sps"

NO FILES WERE COMPILED

    because some files to be compiled are outside current directory

To force compilation, import (larceny compiler) and evaluate

(for-each
  compile-file
  '("/tmp/Bar/bar.sld"
    "/tmp/Foo/foo.sld"
    "/tmp/Bar/bar.sps"))

NO FILES WERE COMPILED

&gt; (parameterize ((current-directory "/tmp/Bar"))
    (compile-stale-recklessly "bar.sps"))

Libraries and programs to be compiled:

    (bar)
    (foo)
    (#(program) 1)

Minimal files to be compiled:

    "/tmp/Bar/bar.sld"
    "/tmp/Foo/foo.sld"
    "/tmp/Bar/bar.sps"

Compiling /tmp/Bar/bar.sld
Compiling /tmp/Foo/foo.sld
Compiling /tmp/Bar/bar.sps

% larceny -I /tmp/Foo -I /tmp/Bar /tmp/Bar/bar.sps.slfasl
(97 98)</pre>
</div></div>
<div class="paragraph"><p><anchor id="compiler-switches" xreflabel="compiler-switches"></anchor>
<em>Procedure <var>compiler-switches</var></em>
<br />
<code>(compiler-switches <em></em>) </code>
<br />
<anchor id="compiler-switches" xreflabel="compiler-switches"></anchor>
<code>(compiler-switches <em>mode</em>) </code>
<br /></p></div>
<div class="paragraph"><p>If no argument is supplied, then the current settings
of all compiler switches are displayed.  Each of those
switches is itself a parameter that is exported by the
<span class="monospaced">(larceny compiler)</span> library.  Calling any individual
compiler switch with no arguments will return its current
setting.  Calling any individual compiler switch with an
argument (usually a boolean) will change its setting to
that argument.</p></div>
<div class="paragraph"><p>The <span class="monospaced">compiler-switches</span> procedure may also be called with
one of the following symbols as its argument:</p></div>
<div class="paragraph"><p><span class="monospaced">default</span>
sets most compiler switches to their default settings.</p></div>
<div class="paragraph"><p><span class="monospaced">fast-safe</span>
enables all optimizations but continues to generate
code to perform all run-time type and range checks that
are needed for safety
(in the traditional sense, not the R6RS sense).</p></div>
<div class="paragraph"><p><span class="monospaced">fast-unsafe</span>
enables all optimizations and also disables type and
range checking.  This setting is deprecated because it
compromises safety (in the traditional sense).</p></div>
<div class="paragraph"><p><span class="monospaced">slow</span>
turns off all optimizations.</p></div>
<div class="paragraph"><p><span class="monospaced">standard</span>
sets compiler switches for maximal conformance to the
R5RS and R6RS standards.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">standard</span> setting is deprecated because it generates
very slow code (because the R5RS makes it difficult to
inline standard procedures), disables most compile-time
checking (because the R6RS forbids rejection of programs
with obvious errors unless the R6RS classifies the errors
as syntactic), and may also compromise the portability or
interoperability of R7RS/R6RS libraries and programs
(because the R6RS outlaws several extensions that Larceny
uses to improve its compatibility with other implementations
of the R5RS, R6RS, and R7RS as well as interoperability between
Larceny&#8217;s own R5RS and R7RS/R6RS modes).</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="paragraph"><p>Selective toggling of compiler switches is almost always
better than using the <span class="monospaced">standard</span> setting.
To improve R5RS conformance without sacrificing too much
performance, set the <span class="monospaced">benchmark-mode</span> switch to false and
set the <span class="monospaced">integrate-procedures</span> switch to false only when
compiling files that need to be sensitive to redefinitions
of standard procedures.
For R6RS libraries and programs, setting the <span class="monospaced">benchmark-mode</span>
and <span class="monospaced">global-optimization</span> switches to false will eliminate a
couple of minor conformance issues with only a small loss
of performance and without sacrificing compile-time checking
or portability.
For R7RS libraries and programs, the compiler&#8217;s default settings
already conform to the R7RS.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="LarcenyBenchmarkingSection">10.3. Benchmarking</h3>
<div class="paragraph"><p>The <span class="monospaced">(larceny benchmarking)</span> library exports the
<span class="monospaced">time</span> syntax and <span class="monospaced">run-benchmark</span> procedure described
below.</p></div>
<div class="paragraph"><p><em>Syntax time</em></p></div>
<div class="paragraph"><p><span class="monospaced">(time expression)</span></p></div>
<div class="paragraph"><p>Evaluates <em>expression</em> and returns its result
after printing approximations to the storage
allocated and time taken during evaluation of
<em>expression</em>.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (time (fib 30))
    Words allocated: 0
    Words reclaimed: 0
    Elapsed time...: 49 ms (User: 48 ms; System: 0 ms)
    Elapsed GC time: 0 ms (CPU: 0 in 0 collections.)
    832040</pre>
</div></div>
<div class="paragraph"><p><anchor id="run-benchmark" xreflabel="run-benchmark"></anchor>
<em>Procedure <var>run-benchmark</var></em>
<br />
<code>(run-benchmark <em>name iterations thunk predicate</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Given the <em>name</em> of a benchmark, the number of
<em>iterations</em> to be performed, a zero-argument
procedure <em>thunk</em> that runs the benchmark,
and a unary <em>predicate</em> that checks the result
of <em>thunk</em>, prints approximations to the storage
allocated and time taken by <em>iterations</em> calls
to <em>thunk</em>.</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (run-benchmark "fib30"
                     100
                     (lambda () (fib 30))
                     (lambda (x) (= x 832040)))

    --------------------------------------------------------
    fib30
    Words allocated: 0
    Words reclaimed: 0
    Elapsed time...: 4828 ms (User: 4824 ms; System: 4 ms)
    Elapsed GC time: 0 ms (CPU: 0 in 0 collections.)</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="RecordsPrinterSection">10.4. Records printer</h3>
<div class="paragraph"><p>The <span class="monospaced">(larceny records printer)</span> library exports the
two procedures described below.  These procedures
can be used to override Larceny&#8217;s usual printing
of records and opaque types that were defined using
the records libraries.</p></div>
<div class="paragraph"><p><anchor id="rtd-printer" xreflabel="rtd-printer"></anchor>
<em>Procedure <var>rtd-printer</var></em>
<br />
<code>(rtd-printer <em>rtd</em>)  =&gt; <em>maybe-procedure</em></code>
<br /></p></div>
<div class="paragraph"><p>Given a record type descriptor, returns its custom
print procedure, or returns false if the rtd has no
custom print procedure.</p></div>
<div class="paragraph"><p><anchor id="rtd-printer-set!" xreflabel="rtd-printer-set!"></anchor>
<em>Procedure <var>rtd-printer-set!</var></em>
<br />
<code>(rtd-printer-set! <em>rtd printer</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Given a record type descriptor <em>rtd</em> and a
<em>printer</em> for instances of that rtd, installs
<em>printer</em> as a custom print procedure for <em>rtd</em>.
The <em>printer</em> should be a procedure that,
given an instance of the rtd and a textual
output port, writes a representation of the
instance to the port.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Err5rsChapter">11. ERR5RS Standard Libraries</h2>
<div class="sectionbody">
<div class="paragraph"><p><a href="#Standards">ERR5RS</a> has been superseded by the R7RS, so the
libraries described below are now deprecated.</p></div>
<div class="sect2">
<h3 id="Err5rsLoadSection">11.1. Load</h3>
<div class="paragraph"><p>The <span class="monospaced">(err5rs load)</span> library has been superseded by the
<span class="monospaced">(scheme load)</span> library, and continues to exist only for
backward compatibility.</p></div>
<div class="paragraph"><p><anchor id="load" xreflabel="load"></anchor>
<em>Procedure <var>load</var></em>
<br />
<code>(load <em>filename</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Loads ERR5RS code from <em>filename</em>, evaluating each form
as though it had been entered at the interactive
read/eval/print loop.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The <span class="monospaced">load</span> procedure should be used only at an interactive top
level and in files that will be loaded into an interactive top
level.  Calls to the <span class="monospaced">load</span> procedure have no effect at compile
time, and should not appear in files that will be compiled
separately; use the <span class="monospaced">library</span> and <span class="monospaced">import</span> syntaxes instead.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="Err5rsRecordsSection">11.2. Records</h3>
<div class="paragraph"><p>The ERR5RS record facility described below incorporates all
optional features of SRFI 99 and is otherwise identical to
the facilities described by SRFI 99.
SRFI 99 is itself an extension of SRFI 9, whose
<span class="monospaced">define-record-type</span> syntax is identical to that defined by
the R7RS.</p></div>
<div class="paragraph"><p>When a procedure is said to be equivalent to an R6RS
procedure, the equivalence holds only when all arguments
have the properties required of them by the R6RS
specification.  ERR5RS does not mandate R6RS exception
semantics for programs that violate the specification.</p></div>
<div class="sect3">
<h4 id="Err5rsRecordsProceduralSection">11.2.1. Procedural layer</h4>
<div class="paragraph"><p>This section describes the <span class="monospaced">(err5rs records procedural)</span> library.</p></div>
<div class="paragraph"><p><anchor id="make-rtd" xreflabel="make-rtd"></anchor>
<em>Procedure <var>make-rtd</var></em>
<br />
<code>(make-rtd <em>name fieldspecs</em>) </code>
<br />
<anchor id="make-rtd" xreflabel="make-rtd"></anchor>
<code>(make-rtd <em>name fieldspecs parent-rtd</em>) </code>
<br />
<anchor id="make-rtd" xreflabel="make-rtd"></anchor>
<code>(make-rtd <em>name fieldspecs parent-rtd option &#8230;</em>) </code>
<br /></p></div>
<div class="paragraph"><p><em>name</em> is a symbol, which matters only to the
<a href="#rtd-name"><span class="monospaced">rtd-name</span></a> procedure of the inspection layer.
<em>fieldspecs</em> is a vector of field specifiers, where
each field specifier is one of</p></div>
<div class="ulist"><ul>
<li>
<p>
a symbol naming the (mutable) field;
</p>
</li>
<li>
<p>
a list of the form <span class="monospaced">(mutable <em>name</em>)</span>,
where <em>name</em> is a symbol naming the mutable field;
</p>
</li>
<li>
<p>
a list of the form <span class="monospaced">(immutable <em>name</em>)</span>,
where <em>name</em> is a symbol naming the immutable field.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The optional parent is an rtd or <span class="monospaced">#f</span>. It is an error for
any of the symbols in fieldspecs to name more than one
of the fields specified by fieldspecs, but the field names
in fieldspecs may shadow field names in the parent rtd.</p></div>
<div class="paragraph"><p><a href="#make-rtd"><span class="monospaced">make-rtd</span></a> returns an R6RS-compatible record-type
descriptor.</p></div>
<div class="paragraph"><p>Larceny allows the following optional arguments to follow
the optional <em>parent-rtd</em> argument:</p></div>
<div class="ulist"><ul>
<li>
<p>
the symbol <span class="monospaced">sealed</span> means the new rtd cannot be used
as the parent of other rtds;
</p>
</li>
<li>
<p>
the symbol <span class="monospaced">opaque</span> means the <a href="#record?"><span class="monospaced">record?</span></a> predicate
will not recognize instances of the new rtd;
</p>
</li>
<li>
<p>
the symbol <span class="monospaced">uid</span>, followed by another symbol <em>id</em>,
means the new rtd is non-generative with uid <em>id</em>; the
semantics of this extension is the same as in the R6RS.
</p>
</li>
</ul></div>
<div class="paragraph"><p>These Larceny-specific options may be used in any
combination, giving Larceny&#8217;s ERR5RS records the same
expressive power as R6RS records, with which they are
fully interoperable.</p></div>
<div class="paragraph"><p><anchor id="rtd?" xreflabel="rtd?"></anchor>
<em>Procedure <var>rtd?</var></em>
<br />
<code>(rtd? <em>obj</em>) </code>
<br /></p></div>
<div class="paragraph"><p>This predicate returns true if and only if its argument
is a record-type descriptor.
<span class="monospaced">rtd?</span> is equivalent to the <span class="monospaced">record-type-descriptor?</span>
procedure of the R6RS.</p></div>
<div class="paragraph"><p><anchor id="rtd-constructor" xreflabel="rtd-constructor"></anchor>
<em>Procedure <var>rtd-constructor</var></em>
<br />
<code>(rtd-constructor <em>rtd</em>) </code>
<br />
<anchor id="rtd-constructor" xreflabel="rtd-constructor"></anchor>
<code>(rtd-constructor <em>rtd fieldspecs</em>) </code>
<br /></p></div>
<div class="paragraph"><p><em>rtd</em> is a record-type descriptor, and <em>fieldspecs</em> is
an optional vector of symbols.</p></div>
<div class="paragraph"><p>If no <em>fieldspecs</em> argument is supplied,
then <span class="monospaced">rtd-constructor</span> returns a procedure that expects
one argument for each field of the record-type described
by <em>rtd</em> and returns an instance of that record-type
with its fields initialized to the corresponding
arguments.
Arguments that correspond to the fields of the
record-type&#8217;s parent (if any) come first.</p></div>
<div class="paragraph"><p>If <em>fieldspecs</em> is supplied, then <span class="monospaced">rtd-constructor</span>
returns a procedure that expects one argument for each
element of <em>fieldspecs</em> and returns an instance of the
record-type described by <em>rtd</em> with the named fields
initialized to the corresponding arguments.</p></div>
<div class="paragraph"><p>It is an error if some symbol occurs more than once in
<em>fieldspecs</em>.  Fields of a derived record-type shadow
fields of the same name in its parent; the <em>fieldspecs</em>
argument cannot be used to initialize a shadowed field.</p></div>
<div class="paragraph"><p><anchor id="rtd-predicate" xreflabel="rtd-predicate"></anchor>
<em>Procedure <var>rtd-predicate</var></em>
<br />
<code>(rtd-predicate <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to the <span class="monospaced">record-predicate</span> procedure of the R6RS.</p></div>
<div class="paragraph"><p><anchor id="rtd-accessor" xreflabel="rtd-accessor"></anchor>
<em>Procedure <var>rtd-accessor</var></em>
<br />
<code>(rtd-accessor <em>rtd field</em>) </code>
<br /></p></div>
<div class="paragraph"><p><em>field</em> is a symbol that names a field of the
record-type described by the record-type descriptor <em>rtd</em>.
Returns a unary procedure that accepts instances of <em>rtd</em>
(or any record-type that inherits from <em>rtd</em>) and
returns the current value of the named field.</p></div>
<div class="paragraph"><p>Fields in derived record-types shadow fields of the same
name in a parent record-type.</p></div>
<div class="paragraph"><p><anchor id="rtd-mutator" xreflabel="rtd-mutator"></anchor>
<em>Procedure <var>rtd-mutator</var></em>
<br />
<code>(rtd-mutator <em>rtd field</em>) </code>
<br /></p></div>
<div class="paragraph"><p><em>field</em> is a symbol that names a field of the
record-type described by the record-type descriptor <em>rtd</em>.
Returns a binary procedure that accepts instances of <em>rtd</em>
(or any record-type that inherits from <em>rtd</em>) and a new
value to be stored into the named field, performs that
side effect, and returns an unspecified value.</p></div>
<div class="paragraph"><p>Fields in derived record-types shadow fields of the same
name in a parent record-type.</p></div>
</div>
<div class="sect3">
<h4 id="Err5rsRecordsInspectionSection">11.2.2. Inspection layer</h4>
<div class="paragraph"><p>This section describes the <span class="monospaced">(err5rs records inspection)</span> library.</p></div>
<div class="paragraph"><p><anchor id="record?" xreflabel="record?"></anchor>
<em>Procedure <var>record?</var></em>
<br />
<code>(record? <em>obj</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to its R6RS namesake.</p></div>
<div class="paragraph"><p><anchor id="record-rtd" xreflabel="record-rtd"></anchor>
<em>Procedure <var>record-rtd</var></em>
<br />
<code>(record-rtd <em>record</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to its R6RS namesake.</p></div>
<div class="paragraph"><p><anchor id="rtd-name" xreflabel="rtd-name"></anchor>
<em>Procedure <var>rtd-name</var></em>
<br />
<code>(rtd-name <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to the <span class="monospaced">record-type-name</span> procedure of the R6RS.</p></div>
<div class="paragraph"><p><anchor id="rtd-parent" xreflabel="rtd-parent"></anchor>
<em>Procedure <var>rtd-parent</var></em>
<br />
<code>(rtd-parent <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to the <span class="monospaced">record-type-parent</span> procedure of the R6RS.</p></div>
<div class="paragraph"><p><anchor id="rtd-field-names" xreflabel="rtd-field-names"></anchor>
<em>Procedure <var>rtd-field-names</var></em>
<br />
<code>(rtd-field-names <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to the <span class="monospaced">record-type-field-names</span> procedure of the R6RS.
(That is, it returns a vector of the symbols that name the fields
of the record-type represented by <em>rtd</em>, excluding the fields of
parent record-types.)</p></div>
<div class="paragraph"><p><anchor id="rtd-all-field-names" xreflabel="rtd-all-field-names"></anchor>
<em>Procedure <var>rtd-all-field-names</var></em>
<br />
<code>(rtd-all-field-names <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a vector of the symbols that name the fields of
the record-type represented by <em>rtd</em>, including the fields
of its parent record-types, if any, with the fields of
parent record-types coming before the fields of its children,
with each subsequence in the same order as in the vectors
that would be returned by calling <a href="#rtd-field-names"><span class="monospaced">rtd-field-names</span></a>
on <em>rtd</em> and on all its ancestral record-type descriptors.</p></div>
<div class="paragraph"><p><anchor id="rtd-field-mutable?" xreflabel="rtd-field-mutable?"></anchor>
<em>Procedure <var>rtd-field-mutable?</var></em>
<br />
<code>(rtd-field-mutable? <em>rtd field</em>) </code>
<br /></p></div>
<div class="paragraph"><p><em>rtd</em> is a record-type descriptor, and <em>field</em> is a
symbol naming a field of the record-type described by <em>rtd</em>.
Returns <span class="monospaced">#t</span> if the named field is mutable; otherwise returns <span class="monospaced">#f</span>.</p></div>
</div>
<div class="sect3">
<h4 id="Err5rsRecordsSyntacticSection">11.2.3. Syntactic layer</h4>
<div class="paragraph"><p>This section describes the <span class="monospaced">(err5rs records syntactic)</span> library.</p></div>
<div class="paragraph"><p>The syntactic layer consists of
<a href="http://srfi.schemers.org/srfi-9/">SRFI 9</a>
extended with single inheritance and (optional) implicit naming.</p></div>
<div class="paragraph"><p>All ERR5RS record-type definitions are generative (unless
Larceny&#8217;s optional <span class="monospaced">uid</span> feature is used), but
ERR5RS drops the SRFI 9 restriction to top level, mainly
because the R6RS allows generative definitions wherever
a definition may appear.</p></div>
<div class="paragraph"><p>The syntax of an ERR5RS record-type definition is</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &lt;definition&gt;
      -&gt; &lt;record type definition&gt;           ; addition to 7.1.6 in R5RS

    &lt;record type definition&gt;
      -&gt; (define-record-type &lt;type spec&gt;
           &lt;constructor spec&gt;
           &lt;predicate spec&gt;
           &lt;field spec&gt; ...)

    &lt;type spec&gt;  -&gt; &lt;type name&gt;
                 -&gt; (&lt;type name&gt; &lt;parent&gt;)

    &lt;constructor spec&gt;
                 -&gt; #f
                 -&gt; #t
                 -&gt; &lt;constructor name&gt;
                 -&gt; (&lt;constructor name&gt; &lt;field name&gt; ...)

    &lt;predicate spec&gt;
                 -&gt; #f
                 -&gt; #t
                 -&gt; &lt;predicate name&gt;

    &lt;field spec&gt; -&gt; &lt;field name&gt;
                 -&gt; (&lt;field name&gt;)
                 -&gt; (&lt;field name&gt; &lt;accessor name&gt;)
                 -&gt; (&lt;field name&gt; &lt;accessor name&gt; &lt;mutator name&gt;)

    &lt;parent&gt;           -&gt; &lt;expression&gt;

    &lt;type name&gt;        -&gt; &lt;identifier&gt;
    &lt;constructor name&gt; -&gt; &lt;identifier&gt;
    &lt;predicate name&gt;   -&gt; &lt;identifier&gt;
    &lt;accessor name&gt;    -&gt; &lt;identifier&gt;
    &lt;mutator name&gt;     -&gt; &lt;identifier&gt;
    &lt;field name&gt;       -&gt; &lt;identifier&gt;</pre>
</div></div>
<div class="paragraph"><p>The semantics of a record type definition is the same
as in SRFI 9: the record type definition macro-expands
into a cluster of definitions that</p></div>
<div class="ulist"><ul>
<li>
<p>
defines the <span class="monospaced">&lt;type name&gt;</span> as the record-type descriptor
for the new record-type;
</p>
</li>
<li>
<p>
defines a constructor for instances of the new
record-type (unless the constructor spec is <span class="monospaced">#f</span>);
</p>
</li>
<li>
<p>
defines a predicate that recognizes instances of the
new record-type and its subtypes (unless the predicate spec is <span class="monospaced">#f</span>);
</p>
</li>
<li>
<p>
defines an accessor for each field name;
</p>
</li>
<li>
<p>
defines a mutator for each mutable field name.
</p>
</li>
</ul></div>
<div class="paragraph"><p>An ERR5RS record type definition extends SRFI 9 with the
following additional options:</p></div>
<div class="ulist"><ul>
<li>
<p>
If a <span class="monospaced">&lt;parent&gt;</span> expression is specified, then it must
evaluate to an rtd that serves as the parent record-type
for the record-type being defined.
</p>
</li>
<li>
<p>
If <span class="monospaced">#f</span> is specified for the constructor or predicate,
then no constructor or predicate procedure is defined.
(This is useful when the record-type being defined will
be used as an abstract base class.)
</p>
</li>
<li>
<p>
If <span class="monospaced">#t</span> is specified for the constructor or predicate,
then the name of the constructor is the type name prefixed
by <span class="monospaced">make-</span>, and the name of the predicate is the type name
followed by a question mark (<span class="monospaced">?</span>).
</p>
</li>
<li>
<p>
If the constructor name is specified as <span class="monospaced">#t</span> or as an
identifier, then the constructor&#8217;s arguments correspond
to the fields of the parent (if any) followed by the new
fields added by this record-type definition.
</p>
</li>
<li>
<p>
If a field spec consists of a single identifier, then
</p>
<div class="ulist"><ul>
<li>
<p>
the field is immutable;
</p>
</li>
<li>
<p>
the name of its accessor is the type name followed by
a hyphen (<span class="monospaced">-</span>) followed by the field name.
</p>
</li>
</ul></div>
</li>
<li>
<p>
If a field spec consists of a list of one identifier, then
</p>
<div class="ulist"><ul>
<li>
<p>
the field is mutable;
</p>
</li>
<li>
<p>
the name of its accessor is the type name followed
by a hyphen (<span class="monospaced">-</span>) followed by the field name;
</p>
</li>
<li>
<p>
the name of its mutator is the type name followed by
a hyphen (<span class="monospaced">-</span>) followed by the field name followed by <span class="monospaced">-set!</span>.
</p>
</li>
</ul></div>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="RecordIdentitySection">11.2.4. Record identity</h4>
<div class="paragraph"><p>Two ERR5RS records with fields are <span class="monospaced">eqv?</span> if and only if
they were created by the same (dynamic) call to some
record constructor.
Two ERR5RS records are <span class="monospaced">eq?</span> if and only if they are <span class="monospaced">eqv?</span>.</p></div>
<div class="paragraph"><p>Apart from the usual constraint that equivalence according
to <span class="monospaced">eqv?</span> implies equivalence according to <span class="monospaced">equal?</span>, the
behavior of <span class="monospaced">equal?</span> on ERR5RS records is unspecified.
(This is compatible with the R6RS.)</p></div>
<div class="paragraph"><p>A <span class="monospaced">define-record-type</span> form macro-expands into code that
calls <a href="#make-rtd"><span class="monospaced">make-rtd</span></a> each time the expanded record-type
definition is executed.
Two ERR5RS record-type descriptors are <span class="monospaced">eqv?</span> if and only if
they were created by the same (dynamic) call to
<a href="#make-rtd"><span class="monospaced">make-rtd</span></a>.</p></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="LarcenyR5rsLibrariesChapter">12. Larceny&#8217;s R5RS Libraries</h2>
<div class="sectionbody">
<div class="paragraph"><p>The procedures described in this chapter are nonstandard.
Some are deprecated after being rendered obsolete by R7RS
or R6RS standard libraries.
Others still provide useful capabilities that the standard
libraries don&#8217;t.</p></div>
<div class="sect2">
<h3 id="_strings">12.1. Strings</h3>
<div class="paragraph"><p>Larceny provides Unicode strings with
<a href="http://www.scheme-reports.org/">R7RS</a>
and
<a href="http://www.r6rs.org/">R6RS</a>
semantics.</p></div>
<div class="paragraph"><p>The <span class="monospaced">string-downcase</span> and <span class="monospaced">string-upcase</span> procedures
perform Unicode-compatible case folding, which can result
in a string whose length is different from that of the original.</p></div>
<div class="paragraph"><p>Larceny may still provide <span class="monospaced">string-downcase!</span> and <span class="monospaced">string-upcase!</span>
procedures, but they are deprecated.</p></div>
</div>
<div class="sect2">
<h3 id="_bytevectors">12.2. Bytevectors</h3>
<div class="paragraph"><p>A <em>bytevector</em> is a data structure that stores bytes&#8201;&#8212;&#8201;exact
8-bit unsigned integers. Bytevectors are useful in constructing
system interfaces and other low-level programming. In Larceny,
many bytevector-like structures&#8201;&#8212;&#8201;bignums, for example&#8201;&#8212;&#8201;are implemented in terms of a
lower-level <em>bytevector-like</em> data type. The operations on
generic bytevector-like structures are particularly fast but
useful largely in code that manipulates Larceny&#8217;s data
representations.</p></div>
<div class="paragraph"><p>The <span class="monospaced">(scheme base)</span> and <span class="monospaced">(rnrs bytevectors)</span> libraries now
provide a large set of procedures that, in Larceny, are
defined using the procedures described below.</p></div>
<div class="paragraph"><p><anchor id="make-bytevector" xreflabel="make-bytevector"></anchor>
<em>Procedure <var>make-bytevector</var></em>
<br />
<code>(make-bytevector <em>length</em>)  =&gt; <em>bytevector</em></code>
<br />
<anchor id="make-bytevector" xreflabel="make-bytevector"></anchor>
<code>(make-bytevector <em>length fill</em>)  =&gt; <em>bytevector</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a bytevector of the desired length.
If no second argument is given, then the bytevector has not
been initialized and most likely contains garbage.</p></div>
<div class="paragraph"><p><em>Operations on bytevector structures</em></p></div>
<div class="paragraph"><p><anchor id="bytevector?" xreflabel="bytevector?"></anchor>
<code>(bytevector? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-length" xreflabel="bytevector-length"></anchor>
<code>(bytevector-length <em>bytevector</em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-ref" xreflabel="bytevector-ref"></anchor>
<code>(bytevector-ref <em>bytevector offset</em>)  =&gt; <em>byte</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-set!" xreflabel="bytevector-set!"></anchor>
<code>(bytevector-set! <em>bytevector offset byte</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-equal?" xreflabel="bytevector-equal?"></anchor>
<code>(bytevector-equal? <em>bytevector1 bytevector2</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-fill!" xreflabel="bytevector-fill!"></anchor>
<code>(bytevector-fill! <em>bytevector byte</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-copy" xreflabel="bytevector-copy"></anchor>
<code>(bytevector-copy <em>bytevector</em>)  =&gt; <em>bytevector</em></code>
<br /></p></div>
<div class="paragraph"><p>These procedures do what you expect.
All are integrable, except <span class="monospaced">bytevector-equal?</span> and <span class="monospaced">bytevector-copy</span>.
The <span class="monospaced">bytevector-equal?</span> name is deprecated, since the
R6RS calls it <span class="monospaced">bytevector=?</span>.</p></div>
<div class="paragraph"><p><em>Operations on bytevector-like structures</em></p></div>
<div class="paragraph"><p><anchor id="bytevector-like?" xreflabel="bytevector-like?"></anchor>
<code>(bytevector-like? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-like-length" xreflabel="bytevector-like-length"></anchor>
<code>(bytevector-like-length <em>bytevector</em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-like-ref" xreflabel="bytevector-like-ref"></anchor>
<code>(bytevector-like-ref <em>bytevector offset</em>)  =&gt; <em>byte</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-like-set!" xreflabel="bytevector-like-set!"></anchor>
<code>(bytevector-like-set! <em>bytevector offset byte</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-like-equal?" xreflabel="bytevector-like-equal?"></anchor>
<code>(bytevector-like-equal? <em>bytevector1 bytevector2</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="bytevector-like-copy" xreflabel="bytevector-like-copy"></anchor>
<code>(bytevector-like-copy <em>bytevector</em>)  =&gt; <em>bytevector</em></code>
<br /></p></div>
<div class="paragraph"><p>A bytevector-like structure is a low-level representation
for indexed arrays of uninterpreted bytes.  Bytevector-like
structures are used to represent types such as bignums and
flonums.</p></div>
<div class="paragraph"><p>There is no way to construct a "generic" bytevector-like
structure; use the constructors for specific bytevector-like
types.</p></div>
<div class="paragraph"><p>The bytevector-like operations operate on all bytevector-like
structures.  All are integrable, except <span class="monospaced">bytevector-like-equal?</span>
and <span class="monospaced">bytevector-like-copy</span>.  All are deprecated because they
violate abstraction barriers and make your code
representation-dependent; they are useful mainly to
Larceny developers, who might otherwise be tempted to
write some low-level operations in C or assembly language.</p></div>
</div>
<div class="sect2">
<h3 id="_vectors">12.3. Vectors</h3>
<div class="paragraph"><p>The <span class="monospaced">(scheme vector)</span> library now
provides a set of procedures that may supersede some
of the procedures described below.
If one of Larceny&#8217;s procedures duplicates the semantics of
an R7RS procedure whose name is different, then Larceny&#8217;s
name is deprecated.</p></div>
<div class="paragraph"><p><anchor id="vector-copy" xreflabel="vector-copy"></anchor>
<em>Procedure <var>vector-copy</var></em>
<br />
<code>(vector-copy <em>vector</em>)  =&gt; <em>vector</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a shallow copy of its argument.</p></div>
<div class="paragraph"><p><em>Operations on vector-like structures</em></p></div>
<div class="paragraph"><p><anchor id="vector-like?" xreflabel="vector-like?"></anchor>
<code>(vector-like? <em>object</em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="vector-like-length" xreflabel="vector-like-length"></anchor>
<code>(vector-like-length <em>vector-like</em>)  =&gt; <em>fixnum</em></code>
<br />
<anchor id="vector-like-ref" xreflabel="vector-like-ref"></anchor>
<code>(vector-like-ref <em>vector-like k</em>)  =&gt; <em>object</em></code>
<br />
<anchor id="vector-like-set!" xreflabel="vector-like-set!"></anchor>
<code>(vector-like-set! <em>vector-like k object</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>A vector-like structure is a low-level representation
for indexed arrays of Scheme objects.  Vector-like
structures are used to represent types such as vectors,
records, symbols, and ports.</p></div>
<div class="paragraph"><p>There is no way to construct a "generic" vector-like structure;
use the constructors for specific data types.</p></div>
<div class="paragraph"><p>The vector-like operations operate on all vector-like structures.
All are integrable.
All are deprecated because they
violate abstraction barriers and make your code
representation-dependent; they are useful mainly to
Larceny developers, who might otherwise be tempted to
write some low-level operations in C or assembly language.</p></div>
</div>
<div class="sect2">
<h3 id="_procedures">12.4. Procedures</h3>
<div class="paragraph"><p><em>Operations on procedures</em></p></div>
<div class="paragraph"><p><anchor id="make-procedure" xreflabel="make-procedure"></anchor>
<code>(make-procedure <em>length</em>)  =&gt; <em>procedure</em></code>
<br />
<anchor id="procedure-length" xreflabel="procedure-length"></anchor>
<code>(procedure-length <em>procedure</em>)  =&gt; <em>fixnum</em></code>
<br />
<anchor id="procedure-ref" xreflabel="procedure-ref"></anchor>
<code>(procedure-ref <em>procedure offset</em>)  =&gt; <em>object</em></code>
<br />
<anchor id="procedure-set!" xreflabel="procedure-set!"></anchor>
<code>(procedure-set! <em>procedure offset object</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>These procedures operate on the representations of procedures and
allow user programs to construct, inspect, and alter procedures.</p></div>
<div class="paragraph"><p><anchor id="procedure-copy" xreflabel="procedure-copy"></anchor>
<em>Procedure <var>procedure-copy</var></em>
<br />
<code>(procedure-copy <em>procedure</em>)  =&gt; <em>procedure</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a shallow copy of the procedure.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The procedures above are deprecated because they
violate abstraction barriers and make your code
representation-dependent; they are useful mainly to
Larceny developers, who might otherwise be tempted to
write some low-level operations in C or assembly language.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The rest of this section describes some procedures that
reach through abstraction barriers in a more controlled way
to extract heuristic information from procedures for debugging
purposes.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The following
text is copied from a straw proposal authored by Will Clinger and sent
to rrr-authors on 09 May 1996. The text has been edited lightly. See
the end for notes about the Larceny implementation.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The procedures that extract heuristic information from procedures are
permitted to return any result whatsoever. If the type of a result is
not among those listed below, then the result represents an
implementation-dependent extension to this interface, which may safely
be interpreted as though no information were available from the
procedure. Otherwise the result is to be interpreted as described
below.</p></div>
<div class="paragraph"><p><anchor id="procedure-arity" xreflabel="procedure-arity"></anchor>
<em>Procedure <var>procedure-arity</var></em>
<br />
<code>(procedure-arity <em>proc</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns information about the arity of <em>proc</em>. If the result is <span class="monospaced">#f</span>,
then no information is available. If the result is an exact
non-negative integer <em>k</em>, then <em>proc</em> requires exactly <em>k</em>
arguments. If the result is an inexact non-negative integer <em>n</em>, then
<em>proc</em> requires <em>n</em> or more arguments. If the result is a pair, then
it is a list of non-negative integers, each of which indicates a
number of arguments that will be accepted by <em>proc</em>; the list is not
necessarily exhaustive.</p></div>
<div class="paragraph"><p><anchor id="procedure-documentation-string" xreflabel="procedure-documentation-string"></anchor>
<em>Procedure <var>procedure-documentation-string</var></em>
<br />
<code>(procedure-documentation-string <em>proc</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns general information about <em>proc</em>. If the result is <span class="monospaced">#f</span>, then no
information is available. If the result is a string, then it is to be
interpreted as a "documentation string" (see Common Lisp).</p></div>
<div class="paragraph"><p><anchor id="procedure-name" xreflabel="procedure-name"></anchor>
<em>Procedure <var>procedure-name</var></em>
<br />
<code>(procedure-name <em>proc</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns information about the name of <em>proc</em>. If the result is <span class="monospaced">#f</span>,
then no information is available. If the result is a symbol or string,
then it represents a name. If the result is a pair, then it is a list
of symbols and/or strings representing a path of names; the first
element represents an outer name and the last element represents an
inner name.</p></div>
<div class="paragraph"><p><anchor id="procedure-source-file" xreflabel="procedure-source-file"></anchor>
<em>Procedure <var>procedure-source-file</var></em>
<br />
<code>(procedure-source-file <em>proc</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns information about the name of a file that contains the source
code for <em>proc</em>. If the result is <span class="monospaced">#f</span>, then no information is
available. If the result is a string, then the string is the name of a
file.</p></div>
<div class="paragraph"><p><anchor id="procedure-source-position" xreflabel="procedure-source-position"></anchor>
<em>Procedure <var>procedure-source-position</var></em>
<br />
<code>(procedure-source-position <em>proc</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns information about the position of the source code for <em>proc</em>
whithin the source file specified by procedure-source-file. If the
result is <span class="monospaced">#f</span>, then no information is available. If the result is an
exact integer <em>k</em>, then <em>k</em> characters precede the opening parenthesis
of the source code for <em>proc</em> within that source file.</p></div>
<div class="paragraph"><p><anchor id="procedure-expression" xreflabel="procedure-expression"></anchor>
<em>Procedure <var>procedure-expression</var></em>
<br />
<code>(procedure-expression <em>proc</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns information about the source code for <em>proc</em>. If the result is
<span class="monospaced">#f</span>, then no information is available. If the result is a pair, then it
is a lambda expression in the traditional representation of a list.</p></div>
<div class="paragraph"><p><anchor id="procedure-environment" xreflabel="procedure-environment"></anchor>
<em>Procedure <var>procedure-environment</var></em>
<br />
<code>(procedure-environment <em>proc</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns information about the environment of <em>proc</em>. If the result is
<span class="monospaced">#f</span>, then no information is available. In any case the result may be
passed to any of the <a href="#SectionEnvironments">environment inquiry functions</a>.</p></div>
<div class="paragraph"><p><strong>Notes on the Larceny implementation</strong></p></div>
<div class="paragraph"><p>Twobit does not yet produce data for all of these functions, so some
of them always return <span class="monospaced">#f</span>.</p></div>
</div>
<div class="sect2">
<h3 id="_pairs_and_lists">12.5. Pairs and Lists</h3>
<div class="paragraph"><p>The <span class="monospaced">(scheme list)</span> and <span class="monospaced">(rnrs lists)</span> libraries now
provide a set of procedures that may supersede some
of the procedures described below.
If one of Larceny&#8217;s procedures duplicates the semantics of
an R7RS or R6RS procedure whose name is different, then Larceny&#8217;s
name is deprecated.</p></div>
<div class="paragraph"><p><anchor id="append!" xreflabel="append!"></anchor>
<em>Procedure <var>append!</var></em>
<br />
<code>(append! <em>list1 list2 &#8230; obj</em>)  =&gt; <em>object</em></code>
<br /></p></div>
<div class="paragraph"><p><span class="monospaced">append!</span> destructively appends its arguments, which must be lists, and
returns the resulting list. The last argument can be any object. The
argument lists are appended by changing the cdr of the last pair of
each argument except the last to point to the next argument.</p></div>
<div class="paragraph"><p><anchor id="every?" xreflabel="every?"></anchor>
<em>Procedure <var>every?</var></em>
<br />
<code>(every? <em>procedure list1 list2 &#8230;</em>)  =&gt; <em>object</em></code>
<br /></p></div>
<div class="paragraph"><p>If the lists have different lengths, they are in effect converted
to the length of the shortest list.  Element tuples are formed as
by applying <span class="monospaced">map</span> to the <span class="monospaced">list</span> procedure and the given lists.
<span class="monospaced">every?</span> applies <em>procedure</em> to each of those element tuples in
first-to-last order, and returns <span class="monospaced">#f</span> as soon as <em>procedure</em> returns
<span class="monospaced">#f</span>. If <em>procedure</em> does not return <span class="monospaced">#f</span> for any element tuple,
then the value returned by <em>procedure</em> for the last element
tuple is returned.</p></div>
<div class="paragraph"><p><anchor id="last-pair" xreflabel="last-pair"></anchor>
<em>Procedure <var>last-pair</var></em>
<br />
<code>(last-pair <em>list-structure</em>)  =&gt; <em>pair</em></code>
<br /></p></div>
<div class="paragraph"><p><span class="monospaced">last-pair</span> returns the last pair of the <em>list structure</em>, which must be
a sequence of pairs linked through the cdr fields.</p></div>
<div class="paragraph"><p><anchor id="list-copy" xreflabel="list-copy"></anchor>
<em>Procedure <var>list-copy</var></em>
<br />
<code>(list-copy <em>list-copy</em>)  =&gt; <em>list</em></code>
<br /></p></div>
<div class="paragraph"><p><span class="monospaced">list-copy</span> makes a shallow copy of the <em>list</em> and returns that copy.</p></div>
<div class="paragraph"><p><anchor id="remove" xreflabel="remove"></anchor>
<em>Procedure <var>remove</var></em>
<br />
<code>(remove <em>key list</em>)  =&gt; <em>list</em></code>
<br />
<anchor id="remq" xreflabel="remq"></anchor>
<em>Procedure <var>remq</var></em>
<br />
<code>(remq <em>key list</em>)  =&gt; <em>list</em></code>
<br />
<anchor id="remv" xreflabel="remv"></anchor>
<em>Procedure <var>remv</var></em>
<br />
<code>(remv <em>key list</em>)  =&gt; <em>list</em></code>
<br />
<anchor id="remp" xreflabel="remp"></anchor>
<em>Procedure <var>remp</var></em>
<br />
<code>(remp <em>pred? list</em>)  =&gt; <em>list</em></code>
<br /></p></div>
<div class="paragraph"><p>Each of these procedures returns a new list which contains all the
elements of <em>list</em> in the original order, except that those elements of
the original list that were equal to <em>key</em> (or that satisfy <em>pred?</em>) are
not in the new list. Remove uses <span class="monospaced">equal?</span> as the equivalence predicate;
<span class="monospaced">remq</span> uses <span class="monospaced">eq?</span>, and <span class="monospaced">remv</span> uses <span class="monospaced">eqv?</span>.</p></div>
<div class="paragraph"><p><anchor id="remove!" xreflabel="remove!"></anchor>
<em>Procedure <var>remove!</var></em>
<br />
<code>(remove! <em>key list</em>)  =&gt; <em>list</em></code>
<br />
<anchor id="remq!" xreflabel="remq!"></anchor>
<em>Procedure <var>remq!</var></em>
<br />
<code>(remq! <em>key list</em>)  =&gt; <em>list</em></code>
<br />
<anchor id="remv!" xreflabel="remv!"></anchor>
<em>Procedure <var>remv!</var></em>
<br />
<code>(remv! <em>key list</em>)  =&gt; <em>list</em></code>
<br />
<anchor id="remp!" xreflabel="remp!"></anchor>
<em>Procedure <var>remp!</var></em>
<br />
<code>(remp! <em>pred? list</em>)  =&gt; <em>list</em></code>
<br /></p></div>
<div class="paragraph"><p>These procedures are like <span class="monospaced">remove</span>, <span class="monospaced">remq</span>, <span class="monospaced">remv</span>, and <span class="monospaced">remp</span>,
except they modify <em>list</em> instead of returning a fresh list.</p></div>
<div class="paragraph"><p><anchor id="reverse!" xreflabel="reverse!"></anchor>
<em>Procedure <var>reverse!</var></em>
<br />
<code>(reverse! <em>list</em>)  =&gt; <em>list</em></code>
<br /></p></div>
<div class="paragraph"><p><span class="monospaced">reverse!</span> destructively reverses its argument and returns the reversed
list.</p></div>
<div class="paragraph"><p><anchor id="some?" xreflabel="some?"></anchor>
<em>Procedure <var>some?</var></em>
<br />
<code>(some? <em>procedure list1 list2 &#8230;</em>)  =&gt; <em>object</em></code>
<br /></p></div>
<div class="paragraph"><p>If the lists have different lengths, they are in effect converted
to the length of the shortest list.  Element tuples are formed as
by applying <span class="monospaced">map</span> to the <span class="monospaced">list</span> procedure and the given lists.
<span class="monospaced">some?</span> applies <em>procedure</em> to each of those element tuples in
first-to-last order, and returns the first non-false value returned by
<em>procedure.</em> If <em>procedure</em> does not return a true value for any
element tuple, then some? returns <span class="monospaced">#f</span>.</p></div>
</div>
<div class="sect2">
<h3 id="_sorting">12.6. Sorting</h3>
<div class="paragraph"><p>The <span class="monospaced">(scheme sort)</span> and <span class="monospaced">(rnrs sorting)</span> libraries now
provide procedures that supersede those described below.
All of the procedures described below are therefore
deprecated.</p></div>
<div class="paragraph"><p><em>Procedures sort and sort!</em></p></div>
<div class="paragraph"><p><anchor id="sort" xreflabel="sort"></anchor>
<code>(sort <em>list less?</em>)  =&gt; <em>list</em></code>
<br />
<anchor id="sort" xreflabel="sort"></anchor>
<code>(sort <em>vector less?</em>)  =&gt; <em>vector</em></code>
<br />
<anchor id="sort!" xreflabel="sort!"></anchor>
<code>(sort! <em>list less?</em>)  =&gt; <em>list</em></code>
<br />
<anchor id="sort!" xreflabel="sort!"></anchor>
<code>(sort! <em>vector less?</em>)  =&gt; <em>vector</em></code>
<br /></p></div>
<div class="paragraph"><p>These procedures sort their argument (a list or a vector) according to
the predicate <em>less?</em>, which must implement a total order on the
elements in the data structures that are sorted.</p></div>
<div class="paragraph"><p><span class="monospaced">sort</span> returns a fresh data structure containing the sorted data;
<span class="monospaced">sort!</span> sorts the data structure in-place.</p></div>
</div>
<div class="sect2">
<h3 id="_records">12.7. Records</h3>
<div class="paragraph"><p>The <span class="monospaced">(scheme base)</span>, <span class="monospaced">(srfi 9)</span>, <span class="monospaced">(srfi 99)</span>, <span class="monospaced">(srfi 131)</span>,
<span class="monospaced">(rnrs records procedural)</span>, and <span class="monospaced">(rnrs records inspection)</span>
libraries now
provide facilities that supersede all
of the procedures described below.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Larceny&#8217;s records have been extended to implement all SRFI 99
and
<a href="http://www.r6rs.org/">R6RS</a>
procedures from</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(srfi 99 records procedural)
(srfi 99 records inspection)
(srfi 131)
(rnrs records procedural)
(rnrs records inspection)</pre>
</div></div>
<div class="paragraph"><p>We recommend that Larceny programmers use the SRFI 99 or 131 APIs instead
of the R6RS APIs.  This should entail no loss of portability, since
the standard reference implementations of SRFI 99 and SRFI 131 records
should run
efficiently in any implementation of the R7RS/R6RS that permits new
libraries to defined at all.</p></div>
<div class="paragraph"><p>Larceny now has two kinds of records: old-style and R7RS/R6RS/SRFI99/ERR5RS.
Old-style records cannot be created in R6RS-conforming mode, so
our extension of R6RS procedures to accept old-style records does
not affect R6RS conformance.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>The following specification describes Larceny&#8217;s old-style record API,
which is now deprecated.  It
is based on a proposal posted by Pavel Curtis to
rrrs-authors on 10 Sep 1989, and later re-posted by Norman Adams to
comp.lang.scheme on 5 Feb 1992. The authorship and copyright status of
the original text are unknown to me.</p></div>
<div class="paragraph"><p>This document differs from the original proposal in that its record
types are extensible, and that it specifies the type of record-type
descriptors.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_specification">12.7.1. Specification</h4>
<div class="paragraph"><p><anchor id="make-record-type" xreflabel="make-record-type"></anchor>
<em>Procedure <var>make-record-type</var></em>
<br />
<code>(make-record-type <em>type-name field-names</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a "record-type descriptor", a value representing a new data
type, disjoint from all others. The <em>type-name</em> argument must be a
string, but is only used for debugging purposes (such as the printed
representation of a record of the new type). The <em>field-names</em>
argument is a list of symbols naming the "fields" of a record of the
new type. It is an error if the list contains any duplicates.</p></div>
<div class="paragraph"><p>If the <em>parent-rtd</em> argument is provided, then the new type will be a
subtype of the type represented by <em>parent-rtd</em>, and the field names
of the new type will include all the field names of the parent
type. It is an error if the complete list of field names contains any
duplicates.</p></div>
<div class="paragraph"><p>Record-type descriptors are themselves records. In particular,
record-type descriptors have a field printer that is either <span class="monospaced">#f</span> or a
procedure. If the value of the field is a procedure, then the
procedure will be called to print records of the type represented by
the record-type descriptor. The procedure must accept two arguments:
the record object to be printed and an output port.</p></div>
<div class="paragraph"><p><anchor id="record-constructor" xreflabel="record-constructor"></anchor>
<em>Procedure <var>record-constructor</var></em>
<br />
<code>(record-constructor <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a procedure for constructing new members of the type
represented by <em>rtd.</em> The returned procedure accepts exactly as many
arguments as there are symbols in the given list, <em>field-names</em>; these
are used, in order, as the initial values of those fields in a new
record, which is returned by the constructor procedure. The values of
any fields not named in that list are unspecified. The field-names
argument defaults to the list of field-names in the call to
make-record-type that created the type represented by <em>rtd</em>; if the
<em>field-names</em> argument is provided, it is an error if it contains any
duplicates or any symbols not in the default list.</p></div>
<div class="paragraph"><p><anchor id="record-predicate" xreflabel="record-predicate"></anchor>
<em>Procedure <var>record-predicate</var></em>
<br />
<code>(record-predicate <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a procedure for testing membership in the type represented by
<em>rtd.</em> The returned procedure accepts exactly one argument and returns
a true value if the argument is a member of the indicated record type
or one of its subtypes; it returns a false value otherwise.</p></div>
<div class="paragraph"><p><anchor id="record-accessor" xreflabel="record-accessor"></anchor>
<em>Procedure <var>record-accessor</var></em>
<br />
<code>(record-accessor <em>rtd field-name</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a procedure for reading the value of a particular field of a
member of the type represented by <em>rtd.</em> The returned procedure
accepts exactly one argument which must be a record of the appropriate
type; it returns the current value of the field named by the symbol
<em>field-name</em> in that record. The symbol field-name must be a member of
the list of field-names in the call to make-record-type that created
the type represented by <em>rtd</em>, or a member of the field-names of the
parent type of the type represented by <em>rtd.</em></p></div>
<div class="paragraph"><p><anchor id="record-updater" xreflabel="record-updater"></anchor>
<em>Procedure <var>record-updater</var></em>
<br />
<code>(record-updater <em>rtd field-name</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a procedure for writing the value of a particular field of a
member of the type represented by <em>rtd.</em> The returned procedure
accepts exactly two arguments: first, a record of the appropriate
type, and second, an arbitrary Scheme value; it modifies the field
named by the symbol <em>field-name</em> in that record to contain the given
value. The returned value of the updater procedure is unspecified. The
symbol <em>field-name</em> must be a member of the list of field-names in the
call to make-record-type that created the type represented by <em>rtd</em>,
or a member of the field-names of the parent type of the type
represented by <em>rtd.</em></p></div>
<div class="paragraph"><p><anchor id="record?" xreflabel="record?"></anchor>
<code>(record? <em>obj</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a true value if <em>obj</em> is a record of any type and a false value
otherwise. Note that <span class="monospaced">record?</span> may be true of any Scheme value; of
course, if it returns true for some particular value, then
<span class="monospaced">record-type-descriptor</span> is applicable to that value and returns an
appropriate descriptor.</p></div>
<div class="paragraph"><p><anchor id="record-type-descriptor" xreflabel="record-type-descriptor"></anchor>
<em>Procedure <var>record-type-descriptor</var></em>
<br />
<code>(record-type-descriptor <em>record</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a record-type descriptor representing the type of the given
record. That is, for example, if the returned descriptor were passed
to record-predicate, the resulting predicate would return a true value
when passed the given record. Note that it is not necessarily the case
that the returned descriptor is the one that was passed to
record-constructor in the call that created the constructor procedure
that created the given record.</p></div>
<div class="paragraph"><p><anchor id="record-type-name" xreflabel="record-type-name"></anchor>
<em>Procedure <var>record-type-name</var></em>
<br />
<code>(record-type-name <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns the type-name associated with the type represented by <em>rtd.</em>
The returned value is eqv? to the type-name argument given in the call
to make-record-type that created the type represented by rtd.</p></div>
<div class="paragraph"><p><anchor id="record-type-field-names" xreflabel="record-type-field-names"></anchor>
<em>Procedure <var>record-type-field-names</var></em>
<br />
<code>(record-type-field-names <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a list of the symbols naming the fields in members of the type
represented by <em>rtd.</em></p></div>
<div class="paragraph"><p><anchor id="record-type-parent" xreflabel="record-type-parent"></anchor>
<em>Procedure <var>record-type-parent</var></em>
<br />
<code>(record-type-parent <em>rtd</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a record-type descriptor for the parent type of the type
represented by <em>rtd</em>, if that type has a parent type, or a false value
otherwise. The type represented by <em>rtd</em> has a parent type if the call
to make-record-type that created <em>rtd</em> provided the <em>parent-rtd</em>
argument.</p></div>
<div class="paragraph"><p><anchor id="record-type-extends?" xreflabel="record-type-extends?"></anchor>
<em>Procedure <var>record-type-extends?</var></em>
<br />
<code>(record-type-extends? <em>rtd1 rtd2</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Returns a true value if the type represented by <em>rtd1</em> is a subtype of
the type represented by <em>rtd2</em> and a false value otherwise. A type <em>s</em>
is a subtype of a type <em>t</em> if <em>s=t</em> or if the parent type of <em>s</em>, if
it exists, is a subtype of <em>t.</em></p></div>
</div>
<div class="sect3">
<h4 id="_implementation">12.7.2. Implementation</h4>
<div class="paragraph"><p>The R6RS spouts some tendentious nonsense about procedural
records being slower than syntactic records, but this is not
true of Larceny&#8217;s records, and is unlikely to be true of other
implementations either.
Larceny&#8217;s procedural records are fairly efficient already,
and will become even more efficient in future versions as
interlibrary optimizations are added.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_input_output_and_files">12.8. Input, Output, and Files</h3>
<div class="paragraph"><p>The <span class="monospaced">(scheme base)</span>, <span class="monospaced">(scheme file)</span>, <span class="monospaced">(rnrs io ports)</span>,
and <span class="monospaced">(rnrs files)</span> libraries now
provide a set of procedures that may supersede some
of the procedures described below.
If one of Larceny&#8217;s procedures duplicates the semantics of
an R7RS or R6RS procedure whose name is different, then Larceny&#8217;s
name is deprecated.</p></div>
<div class="paragraph"><p><anchor id="close-open-files" xreflabel="close-open-files"></anchor>
<em>Procedure <var>close-open-files</var></em>
<br />
<code>(close-open-files <em></em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Closes all open files.</p></div>
<div class="paragraph"><p><anchor id="console-input-port" xreflabel="console-input-port"></anchor>
<em>Procedure <var>console-input-port</var></em>
<br />
<code>(console-input-port <em></em>)  =&gt; <em>input-port</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a character input port such that no read from the port has
signalled an error or returned the end-of-file object.</p></div>
<div class="paragraph"><p><em>Rationale:</em> console-input-port and console-output-port are artifacts
of Unix interactive I/O conventions, where an interactive end-of-file
does not mean "quit" but rather "done here". Under these conventions
the console port should be reset following an end-of-file. Resetting
conflicts with the semantics of ports in Scheme, so console-input-port
and console-output-port return a new port if the current port is
already at end-of-file.</p></div>
<div class="paragraph"><p>Since it is convenient to handle errors in the same manner as
end-of-file, these procedures also return a new port if an error has
been signalled during an I/O operation on the port.</p></div>
<div class="paragraph"><p>Console-input-port and console-output-port simply call the port
generators installed in the parameters console-input-port-factory and
console-output-port-factory, which allow user programs to install
their own console port generators.</p></div>
<div class="paragraph"><p><anchor id="console-output-port" xreflabel="console-output-port"></anchor>
<em>Procedure <var>console-output-port</var></em>
<br />
<code>(console-output-port <em></em>)  =&gt; <em>output-port</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a character output port such that no write to the port has
signalled an error.</p></div>
<div class="paragraph"><p>See console-input-port for a full explanation.</p></div>
<div class="paragraph"><p><a id="console-input-port-factory"></a>

<em>Parameter console-input-port-factory</em></p></div>
<div class="paragraph"><p>The value of this parameter is a procedure that returns a character
input port such that no read from the port has signalled an error or
returned the end-of-file object.</p></div>
<div class="paragraph"><p>See console-input-port for a full explanation.</p></div>
<div class="paragraph"><p><a id="console-output-port-factory"></a>

<em>Parameter console-output-port-factory</em></p></div>
<div class="paragraph"><p>The value of this parameter is a procedure that returns a character
output port such that no write to the port has signalled an error.</p></div>
<div class="paragraph"><p>See console-input-port for a full explanation.</p></div>
<div class="paragraph"><p><a id="current-input-port"></a>

<em>Parameter current-input-port</em></p></div>
<div class="paragraph"><p>The value of this parameter is a character input port.</p></div>
<div class="paragraph"><p><a id="current-output-port"></a>

<em>Parameter current-output-port</em></p></div>
<div class="paragraph"><p>The value of this parameter is a character output port.</p></div>
<div class="paragraph"><p><anchor id="delete-file" xreflabel="delete-file"></anchor>
<em>Procedure <var>delete-file</var></em>
<br />
<code>(delete-file <em>filename</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Deletes the named file. No error is signalled if the file does not
exist.</p></div>
<div class="paragraph"><p><anchor id="eof-object" xreflabel="eof-object"></anchor>
<em>Procedure <var>eof-object</var></em>
<br />
<code>(eof-object <em></em>)  =&gt; <em>end-of-file object</em></code>
<br /></p></div>
<div class="paragraph"><p><em>Eof-object</em> returns an end-of-file object.</p></div>
<div class="paragraph"><p><anchor id="file-exists?" xreflabel="file-exists?"></anchor>
<em>Procedure <var>file-exists?</var></em>
<br />
<code>(file-exists? <em>filename</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>File-exists? returns #t if the named file exists at the time the
procedure is called.</p></div>
<div class="paragraph"><p><anchor id="file-modification-time" xreflabel="file-modification-time"></anchor>
<em>Procedure <var>file-modification-time</var></em>
<br />
<code>(file-modification-time <em>filename</em>)  =&gt; <em>vector or #f</em></code>
<br /></p></div>
<div class="paragraph"><p>File-modification-time returns the time of last modification of the
file as a vector, or #f if the file does not exist. The vector has six
elements: year, month, day, hour, minute, second, all of which are
exact nonnegative integers. The time returned is relative to the local
timezone.</p></div>
<div class="paragraph"><p><span class="monospaced">     (file-modification-time "larceny") &#8658; #(1997 2 6 12 51 13)</span></p></div>
<div class="paragraph"><p><span class="monospaced">     (file-modification-time "geekdom") &#8658; #f</span></p></div>
<div class="paragraph"><p><anchor id="flush-output-port" xreflabel="flush-output-port"></anchor>
<em>Procedure <var>flush-output-port</var></em>
<br />
<code>(flush-output-port <em></em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="flush-output-port" xreflabel="flush-output-port"></anchor>
<code>(flush-output-port <em>port</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Write any buffered data in the port to the underlying output medium.</p></div>
<div class="paragraph"><p><anchor id="get-output-string" xreflabel="get-output-string"></anchor>
<em>Procedure <var>get-output-string</var></em>
<br />
<code>(get-output-string <em>string-output-port</em>)  =&gt; <em>string</em></code>
<br /></p></div>
<div class="paragraph"><p>Retrieve the output string from the given string output port.</p></div>
<div class="paragraph"><p><anchor id="open-input-string" xreflabel="open-input-string"></anchor>
<em>Procedure <var>open-input-string</var></em>
<br />
<code>(open-input-string <em>string</em>)  =&gt; <em>input-port</em></code>
<br /></p></div>
<div class="paragraph"><p>Creates an input port that reads from <em>string</em>. The string may be
shared with the caller. A string input port does not need to be
closed, although closing it will prevent further reads from it.</p></div>
<div class="paragraph"><p><anchor id="open-output-string" xreflabel="open-output-string"></anchor>
<em>Procedure <var>open-output-string</var></em>
<br />
<code>(open-output-string <em></em>)  =&gt; <em>output-port</em></code>
<br /></p></div>
<div class="paragraph"><p>Creates an output port where any output is written to a string. The
accumulated string can be retrieved with
<a href="#get-output-string">[get-output-string]</a> at any time.</p></div>
<div class="paragraph"><p><anchor id="port?" xreflabel="port?"></anchor>
<em>Procedure <var>port?</var></em>
<br />
<code>(port? <em>object</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Tests whether its argument is a port.</p></div>
<div class="paragraph"><p><anchor id="port-name" xreflabel="port-name"></anchor>
<em>Procedure <var>port-name</var></em>
<br />
<code>(port-name <em>port</em>)  =&gt; <em>string</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the name associated with the port; for file ports, this is the file name.</p></div>
<div class="paragraph"><p><anchor id="port-position" xreflabel="port-position"></anchor>
<em>Procedure <var>port-position</var></em>
<br />
<code>(port-position <em>port</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the number of characters that have been read from or written to the port.</p></div>
<div class="paragraph"><p><anchor id="rename-file" xreflabel="rename-file"></anchor>
<em>Procedure <var>rename-file</var></em>
<br />
<code>(rename-file <em>from to</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Renames the file <em>from</em> and gives it the name <em>to</em>. No error is
signalled if <em>from</em> does not exist or <em>to</em> exists.</p></div>
<div class="paragraph"><p><anchor id="reset-output-string" xreflabel="reset-output-string"></anchor>
<em>Procedure <var>reset-output-string</var></em>
<br />
<code>(reset-output-string <em>port</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Given a <em>port</em> created with <em>open-output-string</em>, deletes from the
port all the characters that have been output so far.</p></div>
<div class="paragraph"><p><anchor id="with-input-from-port" xreflabel="with-input-from-port"></anchor>
<em>Procedure <var>with-input-from-port</var></em>
<br />
<code>(with-input-from-port <em>input-port thunk</em>)  =&gt; <em>object</em></code>
<br /></p></div>
<div class="paragraph"><p>Calls <em>thunk</em> with current input bound to <em>input-port</em> in the dynamic
extent of <em>thunk</em>. Returns whatever value was returned from <em>thunk</em>.</p></div>
<div class="paragraph"><p><anchor id="with-output-to-port" xreflabel="with-output-to-port"></anchor>
<em>Procedure <var>with-output-to-port</var></em>
<br />
<code>(with-output-to-port <em>output-port thunk</em>)  =&gt; <em>object</em></code>
<br /></p></div>
<div class="paragraph"><p>Calls <em>thunk</em> with current output bound to <em>output-port</em> in the
dynamic extent of <em>thunk</em>. Returns whatever value was returned from
<em>thunk</em>.</p></div>
</div>
<div class="sect2">
<h3 id="_operating_system_interface">12.9. Operating System Interface</h3>
<div class="paragraph"><p><anchor id="command-line-arguments" xreflabel="command-line-arguments"></anchor>
<em>Procedure <var>command-line-arguments</var></em>
<br />
<code>(command-line-arguments <em></em>)  =&gt; <em>vector</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a vector of strings: the arguments supplied to the program by
the user or the operating system.</p></div>
<div class="paragraph"><p><anchor id="dump-heap" xreflabel="dump-heap"></anchor>
<em>Procedure <var>dump-heap</var></em>
<br />
<code>(dump-heap <em>filename procedure</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Dump a heap image to the named file that will start up with the
supplied procedure. Before <em>procedure</em> is called, command line
arguments will be parsed and any init procedures registered with
<span class="monospaced">add-init-procedure!</span>  will be called.</p></div>
<div class="paragraph"><p><em>Note: Currently, heap dumping is only available with the
stop-and-copy collector (<span class="monospaced">-stopcopy</span> command line option), although the
heap image can be used with all the other collectors.</em></p></div>
<div class="paragraph"><p><anchor id="dump-interactive-heap" xreflabel="dump-interactive-heap"></anchor>
<em>Procedure <var>dump-interactive-heap</var></em>
<br />
<code>(dump-interactive-heap <em>filename</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Dump a heap image to the named file that will start up with the
standard read-eval-print loop. Before the read-eval-print loop is
called, command line arguments will be parsed and any init procedures
registered with <span class="monospaced">add-init-procedure!</span>
will be called.</p></div>
<div class="paragraph"><p><em>Note: Currently, heap dumping is only available with the
stop-and-copy collector (<span class="monospaced">-stopcopy</span> command line option), although the
heap image can be used with all the other collectors.</em></p></div>
<div class="paragraph"><p><anchor id="getenv" xreflabel="getenv"></anchor>
<em>Procedure <var>getenv</var></em>
<br />
<code>(getenv <em>key</em>)  =&gt; <em>string or #f</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the operating system environment mapping for the string <em>key</em>,
or <span class="monospaced">#f</span> if there is no mapping for <em>key</em>.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>This is now a synonym for the <span class="monospaced">get-environment-variable</span>
exported by the <span class="monospaced">(scheme process-context)</span> library.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><anchor id="setenv" xreflabel="setenv"></anchor>
<em>Procedure <var>setenv</var></em>
<br />
<code>(setenv <em>key val</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Sets the operating system environment mapping for the string <em>key</em>
to <em>val</em>.</p></div>
<div class="paragraph"><p><anchor id="system" xreflabel="system"></anchor>
<em>Procedure <var>system</var></em>
<br />
<code>(system <em>command</em>)  =&gt; <em>status</em></code>
<br /></p></div>
<div class="paragraph"><p>Send the <em>command</em> to the operating system&#8217;s command processor and
return the <span class="monospaced">system</span> command&#8217;s exit status. On Unix, <em>command</em> is a
string and <em>status</em> is an exact integer.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>If the <em>command</em> returns a nonzero exit status, then the exit
status returned by <span class="monospaced">system</span> is 256 times the exit status returned
by the <em>command</em>.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="FixnumPrimitives">12.10. Fixnum primitives</h3>
<div class="paragraph"><p>Fixnums are small exact integers that are likely to be
represented without heap
allocation. Larceny never represents a number that can be
represented as a fixnum any other way, so programs that can use
fixnums will do so automatically. However, operations that work only
on fixnums can sometimes be substantially faster than generic
operations, and the following primitives are provided for use in those
programs that need especially good performance.</p></div>
<div class="paragraph"><p>The <span class="monospaced">(rnrs arithmetic fixnums)</span> library now
provides a large set of procedures, some of them similar to
the procedures described below.
If one of Larceny&#8217;s procedures duplicates the semantics of
an R6RS procedure whose name is different, then Larceny&#8217;s
name is deprecated within R7RS/R6RS code.</p></div>
<div class="paragraph"><p>All arguments to the following procedures must be fixnums.</p></div>
<div class="paragraph"><p><anchor id="fixnum?" xreflabel="fixnum?"></anchor>
<em>Procedure <var>fixnum?</var></em>
<br />
<code>(fixnum? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if its argument is a fixnum, and <span class="monospaced">#f</span> otherwise.</p></div>
<div class="paragraph"><p><anchor id="fx+" xreflabel="fx+"></anchor>
<em>Procedure <var>fx+</var></em>
<br />
<code>(fx+ <em>fix1 fix2</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the fixnum sum of its arguments. If the result is not
representable as a fixnum, then an error is signalled (unless error
checking has been disabled).</p></div>
<div class="paragraph"><p><anchor id="fx-" xreflabel="fx-"></anchor>
<em>Procedure <var>fx-</var></em>
<br />
<br /></p></div>
<div class="paragraph"><p>Returns the fixnum difference of its arguments. If the result is not
representable as a fixnum, then an error is signalled.</p></div>
<div class="paragraph"><p><anchor id="fx--" xreflabel="fx--"></anchor>
<em>Procedure <var>fx--</var></em>
<br />
<code>(fx-- <em>fix1</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the fixnum negative of its argument. If the result is not
representable as a fixnum, then an error is signalled.</p></div>
<div class="paragraph"><p><anchor id="fx*" xreflabel="fx*"></anchor>
<em>Procedure <var>fx*</var></em>
<br />
<code>(fx* <em>fix1 fix2</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the fixnum product of its arguments. If the result is not
representable as a fixnum, then an error is signalled.</p></div>
<div class="paragraph"><p><anchor id="fx=" xreflabel="fx="></anchor>
<em>Procedure <var>fx=</var></em>
<br />
<code>(fx= <em>fix1 fix2</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if its arguments are equal, and <span class="monospaced">#f</span> otherwise.</p></div>
<div class="paragraph"><p><anchor id="fx&lt;" xreflabel="fx&lt;"></anchor>
<em>Procedure <var>fx&lt;</var></em>
<br />
<code>(fx&lt; <em>fix1 fix2</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if <em>fix1</em> is less than <em>fix2</em>, and <span class="monospaced">#f</span> otherwise.</p></div>
<div class="paragraph"><p><anchor id="fx&#8656;" xreflabel="fx&#8656;"></anchor>
<em>Procedure <var>fx&#8656;</var></em>
<br />
<code>(fx&#8656; <em>fix1 fix2</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if <em>fix1</em> is less than or equal to <em>fix2</em>, and <span class="monospaced">#f</span>
otherwise.</p></div>
<div class="paragraph"><p><anchor id="fx&gt;" xreflabel="fx&gt;"></anchor>
<em>Procedure <var>fx&gt;</var></em>
<br />
<code>(fx&gt; <em>fix1 fix2</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if <em>fix1</em> is greater than <em>fix2</em>, and <span class="monospaced">#f</span> otherwise.</p></div>
<div class="paragraph"><p><anchor id="fx&gt;=" xreflabel="fx&gt;="></anchor>
<em>Procedure <var>fx&gt;=</var></em>
<br />
<code>(fx&gt;= <em>fix1 fix2</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if <em>fix1</em> is greater than or equal to <em>fix2</em>, and <span class="monospaced">#f</span>
otherwise.</p></div>
<div class="paragraph"><p><anchor id="fxnegative?" xreflabel="fxnegative?"></anchor>
<em>Procedure <var>fxnegative?</var></em>
<br />
<code>(fxnegative? <em>fix</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if its argument is less than zero, and <span class="monospaced">#f</span> otherwise.</p></div>
<div class="paragraph"><p><anchor id="fxpositive?" xreflabel="fxpositive?"></anchor>
<em>Procedure <var>fxpositive?</var></em>
<br />
<code>(fxpositive? <em>fix</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if its argument is greater than zero, and <span class="monospaced">#f</span> otherwise.</p></div>
<div class="paragraph"><p><anchor id="fxzero?" xreflabel="fxzero?"></anchor>
<em>Procedure <var>fxzero?</var></em>
<br />
<code>(fxzero? <em>fix</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <span class="monospaced">#t</span> if its argument is zero, and <span class="monospaced">#f</span> otherwise.</p></div>
<div class="paragraph"><p><anchor id="fxlogand" xreflabel="fxlogand"></anchor>
<em>Procedure <var>fxlogand</var></em>
<br />
<code>(fxlogand <em>fix1 fix2</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the bitwise <em>and</em> of its arguments.</p></div>
<div class="paragraph"><p><anchor id="fxlogior" xreflabel="fxlogior"></anchor>
<em>Procedure <var>fxlogior</var></em>
<br />
<code>(fxlogior <em>fix1 fix2</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the bitwise <em>inclusive or</em> of its arguments.</p></div>
<div class="paragraph"><p><anchor id="fxlognot" xreflabel="fxlognot"></anchor>
<em>Procedure <var>fxlognot</var></em>
<br />
<code>(fxlognot <em>fix</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the bitwise <em>not</em> of its argument.</p></div>
<div class="paragraph"><p><anchor id="fxlogxor" xreflabel="fxlogxor"></anchor>
<em>Procedure <var>fxlogxor</var></em>
<br />
<code>(fxlogxor <em>fix1 fix2</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the bitwise <em>exclusive or</em> of its arguments.</p></div>
<div class="paragraph"><p><anchor id="fxlsh" xreflabel="fxlsh"></anchor>
<em>Procedure <var>fxlsh</var></em>
<br />
<code>(fxlsh <em>fix1 fix2</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <em>fix1</em> shifted left <em>fix2</em> places, shifting in zero bits at
the low end. If the shift count exceeds the number of bits in the
machine&#8217;s word size, then the results are machine-dependent.</p></div>
<div class="paragraph"><p><anchor id="most-positive-fixnum" xreflabel="most-positive-fixnum"></anchor>
<em>Procedure <var>most-positive-fixnum</var></em>
<br />
<code>(most-positive-fixnum <em></em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the largest representable positive fixnum.</p></div>
<div class="paragraph"><p><anchor id="most-negative-fixnum" xreflabel="most-negative-fixnum"></anchor>
<em>Procedure <var>most-negative-fixnum</var></em>
<br />
<code>(most-negative-fixnum <em></em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the smallest representable negative fixnum.</p></div>
<div class="paragraph"><p><anchor id="fxrsha" xreflabel="fxrsha"></anchor>
<em>Procedure <var>fxrsha</var></em>
<br />
<code>(fxrsha <em>fix1 fix2</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <em>fix1</em> shifted right <em>fix2</em> places, shifting in a copy of the
sign bit at the left end. If the shift count exceeds the number of
bits in the machine&#8217;s word size, then the results are
machine-dependent.</p></div>
<div class="paragraph"><p><anchor id="fxrshl" xreflabel="fxrshl"></anchor>
<em>Procedure <var>fxrshl</var></em>
<br />
<code>(fxrshl <em>fix1 fix2</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns <em>fix1</em> shifted right <em>fix2</em> places, shifting in zero bits at
the high end. If the shift count exceeds the number of bits in the
machine&#8217;s word size, then the results are machine-dependent.</p></div>
</div>
<div class="sect2">
<h3 id="_numbers">12.11. Numbers</h3>
<div class="paragraph"><p>Larceny has six representations for numbers: <em>fixnums</em> are small,
exact integers; <em>bignums</em> are unlimited-precision exact integers;
<em>ratnums</em> are exact rationals; <em>flonums</em> are inexact rationals;
<em>rectnums</em> are exact complexes; and <em>compnums</em> are inexact complexes.</p></div>
<div class="paragraph"><p><em>Number-representation predicates</em></p></div>
<div class="paragraph"><p><anchor id="fixnum?" xreflabel="fixnum?"></anchor>
<code>(fixnum? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="bignum?" xreflabel="bignum?"></anchor>
<code>(bignum? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="ratnum?" xreflabel="ratnum?"></anchor>
<code>(ratnum? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="flonum?" xreflabel="flonum?"></anchor>
<code>(flonum? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="rectnum?" xreflabel="rectnum?"></anchor>
<code>(rectnum? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br />
<anchor id="compnum?" xreflabel="compnum?"></anchor>
<code>(compnum? <em>obj</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>These predicates test whether an object is a number of a particular
representation and return <span class="monospaced">#t</span> if so, <span class="monospaced">#f</span> if not.</p></div>
<div class="paragraph"><p><anchor id="random" xreflabel="random"></anchor>
<em>Procedure <var>random</var></em>
<br />
<code>(random <em>limit</em>)  =&gt; <em>exact integer</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a pseudorandom nonnegative exact integer in the range 0
through <em>limit</em>-1.</p></div>
</div>
<div class="sect2">
<h3 id="_hashtables_and_hash_functions">12.12. Hashtables and hash functions</h3>
<div class="paragraph"><p>Hashtables represent finite mappings from keys to values.
If the hash function is a good one, then the value associated
with a key may be looked up in constant time (on the average).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Although R7RS Red Edition now includes a <span class="monospaced">(scheme hash-table)</span>
library, that library deprecates several of the procedures it
exports, and the efficiency of its <span class="monospaced">eq?</span> and <span class="monospaced">eqv?</span> hash tables
depends upon a fragile, implementation-dependent hack.</p></div>
<div class="paragraph"><p>We recommend programmers use <span class="monospaced">(srfi 126)</span> instead of
<span class="monospaced">(scheme hash-table)</span>.</p></div>
<div class="paragraph"><p>Larceny supports the following hash table libraries, which are
listed in decreasing order of quality:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">(srfi 126)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">(rnrs hashtables)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">(scheme hash-table)</span>
</p>
</li>
<li>
<p>
<span class="monospaced">(srfi 125)</span>
</p>
</li>
<li>
<p>
Larceny&#8217;s old-style hashtables, described below.
</p>
</li>
<li>
<p>
<span class="monospaced">(srfi 69)</span>
</p>
</li>
</ul></div>
<div class="paragraph"><p>In Larceny, hash tables created by those libraries are largely
interchangeable, but that is unlikely to be true in other
implementations of Scheme.  Even in Larceny, hash tables created
using the <span class="monospaced">(srfi 126)</span> and <span class="monospaced">(rnrs hashtables)</span> libraries may be
substantially more efficient than some of the hash tables created
by seemingly analogous mechanisms in the other libraries.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>To resolve a clash of names and semantics with the
R6RS <span class="monospaced">make-hashtable</span> procedure, Larceny&#8217;s traditional
<span class="monospaced">make-hashtable</span> procedure has been renamed to
<span class="monospaced">make-oldstyle-hashtable</span>.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The API described below is deprecated.  R6RS-style hashtables
are available even in Larceny&#8217;s R5RS mode, and should be used
instead of the procedures described below.</p></div>
</td>
</tr></table>
</div>
<div class="sect3">
<h4 id="_hash_tables">12.12.1. Hash tables</h4>
<div class="paragraph"><p><anchor id="make-oldstyle-hashtable" xreflabel="make-oldstyle-hashtable"></anchor>
<em>Procedure <var>make-oldstyle-hashtable</var></em>
<br />
<code>(make-oldstyle-hashtable <em>hash-function bucket-searcher size</em>)  =&gt; <em>hashtable</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a newly allocated mutable hash table using <em>hash-function</em> as
the hash function and <em>bucket-searcher</em>, e.g. <span class="monospaced">assq</span>, <span class="monospaced">assv</span>, <span class="monospaced">assoc</span>, to
search a bucket with <em>size</em> buckets at first, expanding the number of
buckets as needed. The <em>hash-function</em> must accept a key and return a
non-negative exact integer.</p></div>
<div class="paragraph"><p><anchor id="make-oldstyle-hashtable" xreflabel="make-oldstyle-hashtable"></anchor>
<code>(make-oldstyle-hashtable <em>hash-function bucket-searcher</em>)  =&gt; <em>hashtable</em></code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to <span class="monospaced">(make-oldstyle-hashtable <em>hash-function bucket-searcher n</em>)</span> for
some value of <em>n</em> chosen by the implementation.</p></div>
<div class="paragraph"><p><anchor id="make-oldstyle-hashtable" xreflabel="make-oldstyle-hashtable"></anchor>
<code>(make-oldstyle-hashtable <em>hash-function</em>)  =&gt; <em>hashtable</em></code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to <span class="monospaced">(make-oldstyle-hashtable <em>hash-function</em> assv)</span>.</p></div>
<div class="paragraph"><p><anchor id="make-oldstyle-hashtable" xreflabel="make-oldstyle-hashtable"></anchor>
<code>(make-oldstyle-hashtable <em></em>)  =&gt; <em>hashtable</em></code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to <span class="monospaced">(make-oldstyle-hashtable object-hash assv)</span>.</p></div>
<div class="paragraph"><p><anchor id="hashtable-contains?" xreflabel="hashtable-contains?"></anchor>
<em>Procedure <var>hashtable-contains?</var></em>
<br />
<code>(hashtable-contains? <em>hashtable key</em>)  =&gt; <em>bool</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns true iff the <em>hashtable</em> contains an entry for <em>key</em>.</p></div>
<div class="paragraph"><p><anchor id="hashtable-fetch" xreflabel="hashtable-fetch"></anchor>
<em>Procedure <var>hashtable-fetch</var></em>
<br />
<code>(hashtable-fetch <em>hashtable key flag</em>)  =&gt; <em>object</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the value associated with <em>key</em> in the <em>hashtable</em> if the
<em>hashtable</em> contains <em>key</em>; otherwise returns <em>flag</em>.</p></div>
<div class="paragraph"><p><anchor id="hashtable-get" xreflabel="hashtable-get"></anchor>
<em>Procedure <var>hashtable-get</var></em>
<br />
<code>(hashtable-get <em>hashtable key</em>)  =&gt; <em>object</em></code>
<br /></p></div>
<div class="paragraph"><p>Equivalent to <span class="monospaced">(hashtable-fetch  #f)</span>.</p></div>
<div class="paragraph"><p><anchor id="hashtable-put!" xreflabel="hashtable-put!"></anchor>
<em>Procedure <var>hashtable-put!</var></em>
<br />
<code>(hashtable-put! <em>hashtable key value</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Changes the <em>hashtable</em> to associate <em>key</em> with <em>value</em>, replacing any
existing association for <em>key</em>.</p></div>
<div class="paragraph"><p><anchor id="hashtable-remove!" xreflabel="hashtable-remove!"></anchor>
<em>Procedure <var>hashtable-remove!</var></em>
<br />
<code>(hashtable-remove! <em>hashtable key</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Removes any association for <em>key</em> within the <em>hashtable</em>.</p></div>
<div class="paragraph"><p><anchor id="hashtable-clear!" xreflabel="hashtable-clear!"></anchor>
<em>Procedure <var>hashtable-clear!</var></em>
<br />
<code>(hashtable-clear! <em>hashtable</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Removes all associations from the <em>hashtable</em>.</p></div>
<div class="paragraph"><p><anchor id="hashtable-size" xreflabel="hashtable-size"></anchor>
<em>Procedure <var>hashtable-size</var></em>
<br />
<code>(hashtable-size <em>hashtable</em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns the number of keys contained within the <em>hashtable</em>.</p></div>
<div class="paragraph"><p><anchor id="hashtable-for-each" xreflabel="hashtable-for-each"></anchor>
<em>Procedure <var>hashtable-for-each</var></em>
<br />
<code>(hashtable-for-each <em>procedure hashtable</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>The <em>procedure</em> must accept two arguments, a key and the value
associated with that key. Calls the <em>procedure</em> once for each
key-value association in <em>hashtable</em>. The order of these calls is
indeterminate.</p></div>
<div class="paragraph"><p><anchor id="hashtable-map" xreflabel="hashtable-map"></anchor>
<em>Procedure <var>hashtable-map</var></em>
<br />
<code>(hashtable-map <em>procedure hashtable</em>) </code>
<br /></p></div>
<div class="paragraph"><p>The <em>procedure</em> must accept two arguments, a key and the value
associated with that key. Calls the <em>procedure</em> once for each
key-value association in <em>hashtable</em>, and returns a list of the
results. The order of the calls is indeterminate.</p></div>
<div class="paragraph"><p><anchor id="hashtable-copy" xreflabel="hashtable-copy"></anchor>
<em>Procedure <var>hashtable-copy</var></em>
<br />
<code>(hashtable-copy <em>hashtable</em>)  =&gt; <em>hashtable</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a copy of the <em>hashtable</em>.</p></div>
</div>
<div class="sect3">
<h4 id="_hash_functions">12.12.2. Hash functions</h4>
<div class="paragraph"><p>The <em>hash values</em> returned by these functions are nonnegative exact
integer suitable as hash values for the hashtable functions.</p></div>
<div class="paragraph"><p><anchor id="equal-hash" xreflabel="equal-hash"></anchor>
<em>Procedure <var>equal-hash</var></em>
<br />
<code>(equal-hash <em>object</em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a hash value for <em>object</em> based on its contents.</p></div>
<div class="paragraph"><p><anchor id="object-hash" xreflabel="object-hash"></anchor>
<em>Procedure <var>object-hash</var></em>
<br />
<code>(object-hash <em>object</em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a hash value for <em>object</em> based on its identity.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This hash function performs extremely poorly on pairs,
vectors, strings, and bytevectors, which are the objects
with which it is mostly likely to be used.
For efficient hashing on object identity, create the
hashtable with <span class="monospaced">make-eq-hashtable</span> or <span class="monospaced">make-eqv-hashtable</span>
of the <span class="monospaced">(rnrs hashtables)</span> library.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><anchor id="string-hash" xreflabel="string-hash"></anchor>
<em>Procedure <var>string-hash</var></em>
<br />
<code>(string-hash <em>string</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a hash value for <em>string</em> based on its content.</p></div>
<div class="paragraph"><p><anchor id="symbol-hash" xreflabel="symbol-hash"></anchor>
<em>Procedure <var>symbol-hash</var></em>
<br />
<code>(symbol-hash <em>symbol</em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a hash value for <em>symbol</em> based on its print name.
The <span class="monospaced">symbol-hash</span>
is very fast, because the hash code is cached in the symbol data
structure.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_parameters">12.13. Parameters</h3>
<div class="paragraph"><p>Parameters are procedures that serve as containers for values.</p></div>
<div class="paragraph"><p>When called with no arguments, a parameter returns its current value.
The value of a parameter can be changed temporarily using the
<em>parameterize</em> syntax described below.</p></div>
<div class="paragraph"><p>The effect of passing arguments to a parameter is implementation-dependent.
In Larceny, passing one argument to a parameter changes the current value
of the parameter to the result of applying a <em>converter</em> procedure to that
argument, as described by SRFI 39.</p></div>
<div class="paragraph"><p><anchor id="make-parameter" xreflabel="make-parameter"></anchor>
<em>Procedure <var>make-parameter</var></em>
<br />
<code>(make-parameter <em>init</em>)  =&gt; <em>procedure</em></code>
<br />
<anchor id="make-parameter" xreflabel="make-parameter"></anchor>
<code>(make-parameter <em>init converter</em>)  =&gt; <em>procedure</em></code>
<br />
<anchor id="make-parameter" xreflabel="make-parameter"></anchor>
<code>(make-parameter <em>name init predicate</em>)  =&gt; <em>procedure</em></code>
<br /></p></div>
<div class="paragraph"><p>Creates a parameter.</p></div>
<div class="paragraph"><p>When <em>make-parameter</em> is called with one argument <em>init</em>,
the parameter&#8217;s initial value is <em>init</em>, and the parameter&#8217;s
<em>converter</em> will be the identity function.</p></div>
<div class="paragraph"><p>When <em>make-parameter</em> is called with two arguments,
<em>converter</em> must be a procedure that accepts one argument,
and the parameter&#8217;s initial value is the result of calling
<em>converter</em> on <em>init</em>.</p></div>
<div class="paragraph"><p>Larceny extends SRFI 39 and the R7RS specification of <em>make-parameter</em>
by allowing it to be called with three arguments.
The first argument, <em>name,</em> must be a symbol or string giving the
print name of the parameter.
The second argument, <em>init,</em> will be the initial value of the parameter.
The third argument is a <em>predicate</em> from which Larceny constructs a
<em>converter</em> procedure that acts like the identity function on arguments
that satisfy the <em>predicate</em> but raises an exception on arguments that
don&#8217;t.</p></div>
<div class="paragraph"><p><anchor id="make-parameter" xreflabel="make-parameter"></anchor>
<code>(make-parameter <em>name init</em>)  =&gt; <em>procedure</em></code>
<br /></p></div>
<div class="paragraph"><p>Larceny&#8217;s parameter objects predate SRFI 39.
For backward compatibility, Larceny&#8217;s <em>make-parameter</em> will
accept two arguments even if the second is not a procedure,
provided the first argument is a symbol or string.
In that special case, the two arguments will be treated as the
<em>name</em> and <em>init</em> arguments to Larceny&#8217;s three-argument version,
with the <em>predicate</em> defaulting to the identity function.
<em>This extension is strongly deprecated.</em></p></div>
<div class="paragraph"><p><em>Syntax parameterize</em></p></div>
<div class="paragraph"><p><span class="monospaced"> (parameterize ((parameter0 value0) &#8230;) expr0 expr1 &#8230;)</span></p></div>
<div class="paragraph"><p><em>Parameterize</em> temporarily overrides the values of a set of parameters
while the expressions in the body of the <em>parameterize</em> expression are
evaluated.
(It is like <em>fluid-let</em> for parameters instead of variables.)</p></div>
<div class="sect3">
<h4 id="_larceny_parameters">12.13.1. Larceny parameters</h4>
<div class="paragraph"><p>The following is a partial list of Larceny&#8217;s parameters.
The first three are described by the R7RS standard.
Most of the others are intended for use by developers of Larceny;
some are described in Wiki pages at Larceny&#8217;s GitHub site,
while others are described only by source code.</p></div>
<div class="paragraph"><p><a href="#current-input-port"><em>Parameter current-input-port</em></a></p></div>
<div class="paragraph"><p><a href="#current-output-port"><em>Parameter current-output-port</em></a></p></div>
<div class="paragraph"><p><a href="#current-error-port"><em>Parameter current-error-port</em></a></p></div>
<div class="paragraph"><p><a href="#console-input-port-factory"><em>Parameter console-input-port-factory</em></a></p></div>
<div class="paragraph"><p><a href="#console-output-port-factory"><em>Parameter console-output-port-factory</em></a></p></div>
<div class="paragraph"><p><em>Parameter print-level</em></p></div>
<div class="paragraph"><p><em>Parameter print-length</em></p></div>
<div class="paragraph"><p><em>Parameter herald</em></p></div>
<div class="paragraph"><p><em>Parameter issue-deprecated-warnings?</em></p></div>
<div class="paragraph"><p><em>Parameter case-sensitive?</em></p></div>
<div class="paragraph"><p><em>Parameter read-square-bracket-as-paren</em></p></div>
<div class="paragraph"><p><em>Parameter read-r6rs-flags?</em></p></div>
<div class="paragraph"><p><em>Parameter read-r7rs-weirdness?</em></p></div>
<div class="paragraph"><p><em>Parameter read-r6rs-weirdness?</em></p></div>
<div class="paragraph"><p><em>Parameter read-r5rs-weirdness?</em></p></div>
<div class="paragraph"><p><em>Parameter read-larceny-weirdness?</em></p></div>
<div class="paragraph"><p><em>Parameter read-traditional-weirdness?</em></p></div>
<div class="paragraph"><p><em>Parameter read-mzscheme-weirdness?</em></p></div>
<div class="paragraph"><p><em>Parameter load-verbose</em></p></div>
<div class="paragraph"><p><em>Parameter interaction-environment</em></p></div>
<div class="paragraph"><p><em>Parameter evaluator</em></p></div>
<div class="paragraph"><p><em>Parameter load-evaluator</em></p></div>
<div class="paragraph"><p><em>Parameter repl-evaluator</em></p></div>
<div class="paragraph"><p><em>Parameter repl-level</em></p></div>
<div class="paragraph"><p><em>Parameter repl-printer</em></p></div>
<div class="paragraph"><p><em>Parameter break-handler</em></p></div>
<div class="paragraph"><p><em>Parameter error-handler</em></p></div>
<div class="paragraph"><p><em>Parameter quit-handler</em></p></div>
<div class="paragraph"><p><em>Parameter reset-handler</em></p></div>
<div class="paragraph"><p><em>Parameter keyboard-interrupt-handler</em></p></div>
<div class="paragraph"><p><em>Parameter timer-interrupt-handler</em></p></div>
<div class="paragraph"><p><em>Parameter standard-timeslice</em></p></div>
<div class="paragraph"><p><em>Parameter structure-comparator</em></p></div>
<div class="paragraph"><p><em>Parameter structure-printer</em></p></div>
</div>
</div>
<div class="sect2">
<h3 id="_property_lists">12.14. Property Lists</h3>
<div class="paragraph"><p>The <em>property list</em> of a symbol is an association list that is
attached to that symbol. The association list maps <em>properties</em>, which
are themselves symbols, to arbitrary values.</p></div>
<div class="paragraph"><p><anchor id="putprop" xreflabel="putprop"></anchor>
<em>Procedure <var>putprop</var></em>
<br />
<code>(putprop <em>symbol property obj</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>If an association exists for <em>property</em> on the property list of
<em>symbol</em>, then its value is replaced by the new value
<em>obj</em>. Otherwise, a new association is added to the property list of
<em>symbol</em> that associates <em>property</em> with <em>obj</em>.</p></div>
<div class="paragraph"><p><anchor id="getprop" xreflabel="getprop"></anchor>
<em>Procedure <var>getprop</var></em>
<br />
<code>(getprop <em>symbol property</em>)  =&gt; <em>obj</em></code>
<br /></p></div>
<div class="paragraph"><p>If an association exists for <em>property</em> on the property list of
<em>symbol</em>, then its value is returned. Otherwise, <span class="monospaced">#f</span> is returned.</p></div>
<div class="paragraph"><p><anchor id="remprop" xreflabel="remprop"></anchor>
<em>Procedure <var>remprop</var></em>
<br />
<code>(remprop <em>symbol property</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>If an association exists for <em>property</em> on the property list of
<em>symbol</em>, then that association is removed. Otherwise, this is a
no-op.</p></div>
</div>
<div class="sect2">
<h3 id="_symbols">12.15. Symbols</h3>
<div class="paragraph"><p><anchor id="gensym" xreflabel="gensym"></anchor>
<em>Procedure <var>gensym</var></em>
<br />
<code>(gensym <em>string</em>)  =&gt; <em>symbol</em></code>
<br /></p></div>
<div class="paragraph"><p>Gensym returns a new uninterned symbol, the name of which contains the
given <em>string.</em></p></div>
<div class="paragraph"><p><anchor id="oblist" xreflabel="oblist"></anchor>
<em>Procedure <var>oblist</var></em>
<br />
<code>(oblist <em></em>)  =&gt; <em>list</em></code>
<br /></p></div>
<div class="paragraph"><p>Oblist returns the list of interned symbols.</p></div>
<div class="paragraph"><p><anchor id="oblist-set!" xreflabel="oblist-set!"></anchor>
<em>Procedure <var>oblist-set!</var></em>
<br />
<code>(oblist-set! <em>list</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="oblist-set!" xreflabel="oblist-set!"></anchor>
<code>(oblist-set! <em>list table-size</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><span class="monospaced">oblist-set!</span> sets the list of interned symbols to those in the given
<em>list</em> by clearing the symbol hash table and storing the symbols in
<em>list</em> in the hash table. If the optional <em>table-size</em> is given, it is
taken to be the desired size of the new symbol table.</p></div>
<div class="paragraph"><p>See also: <a href="#symbol-hash">[symbol-hash]</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_system_control_and_performance_measurement">12.16. System Control and Performance Measurement</h3>
<div class="paragraph"><p><anchor id="collect" xreflabel="collect"></anchor>
<em>Procedure <var>collect</var></em>
<br />
<code>(collect <em></em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="collect" xreflabel="collect"></anchor>
<code>(collect <em>generation</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="collect" xreflabel="collect"></anchor>
<code>(collect <em>generation method</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Collect initiates a garbage collection. If the system has multiple
generations, then the optional arguments are interpreted as
follows. The <em>generation</em> is the generation to collect, where 0 is the
youngest generation. The <em>method</em> determines how the collection is
performed. If <em>method</em> is the symbol collect, then a full collection
is performed in that generation, whatever that means&#8201;&#8212;&#8201;in a normal
multi-generational copying collector, it means that all live objects
in the generation&#8217;s current semispace and all live objects from all
younger generations are copied into the generation&#8217;s other
semispace. If <em>method</em> is the symbol promote, then live objects are
promoted from younger generations into the target generation&#8201;&#8212;&#8201;in our
example collector, that means that the objects are copied into the
target generation&#8217;s current semispace.</p></div>
<div class="paragraph"><p>The default value for <em>generation</em> is 0, and the default value for
<em>method</em> is collect.</p></div>
<div class="paragraph"><p>Note that the collector&#8217;s internal policy settings may cause it to
perform a more major type of collection than the one requested; for
example, an attempt to collect generation 2 could cause the collector
to promote all live data into generation 3.</p></div>
<div class="paragraph"><p><anchor id="gc-counter" xreflabel="gc-counter"></anchor>
<em>Procedure <var>gc-counter</var></em>
<br />
<code>(gc-counter <em></em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p><em>gc-counter</em> returns the number of garbage collections performed since
startup. On a 32-bit system, the counter wraps around every
1,073,741,824 collections.</p></div>
<div class="paragraph"><p><em>gc-counter</em> is a primitive and compiles to a single load instruction
on the x86 and ARM.</p></div>
<div class="paragraph"><p><anchor id="major-gc-counter" xreflabel="major-gc-counter"></anchor>
<em>Procedure <var>major-gc-counter</var></em>
<br />
<code>(major-gc-counter <em></em>)  =&gt; <em>fixnum</em></code>
<br /></p></div>
<div class="paragraph"><p><em>major-gc-counter</em> returns the number of major garbage collections
performed since startup, where a major collection is defined as a
collection that may change the address of objects that have already
survived a previous collection.
On a 32-bit system, the counter wraps around every
1,073,741,824 collections.</p></div>
<div class="paragraph"><p><em>major-gc-counter</em> is a primitive and compiles to a single load
instruction on the x86 and ARM.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Larceny uses <em>gc-counter</em> and <em>major-gc-counter</em> to implement
efficient hashtables that hash on object identity by using an
object&#8217;s current address to compute its hash code.  Hash tables
that use this kind of hash function (notably <span class="monospaced">make-eq-hashtable</span>
and <span class="monospaced">make-eqv-hashtable</span>) may have to rehash some of their keys
after a garbage collection that relocates objects.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p><anchor id="gcctl" xreflabel="gcctl"></anchor>
<em>Procedure <var>gcctl</var></em>
<br />
<code>(gcctl <em>heap-number operation operand</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><em>[GCCTL is largely obsolete in the new garbage collector but may be
resurrected in the future. It can still be used to control the
non-predictive collector.]</em></p></div>
<div class="paragraph"><p>gcctl controls garbage collection policy on a heap-wise basis. The
<em>heap-number</em> is the heap to operate on, like for the command line
switches: heap 1 is the youngest. If the given heap number does not
correspond to a heap, gcctl fails silently.</p></div>
<div class="paragraph"><p>The <em>operation</em> is a symbol that selects the operation to perform, and
the <em>operand</em> is the operand to that operation, always a number. For
the non-predictive garbage collector, the following operator/operand
pairs are meaningful:</p></div>
<div class="ulist"><ul>
<li>
<p>
j-fixed, <em>n</em>: after a collection, the collector parameter <em>j</em> should be set to the value <em>n</em>, if possible. (Non-predictive heaps only.)
</p>
</li>
<li>
<p>
j-percent, <em>n</em>: after a collection, the collector parameter <em>j</em> should be set to be <em>n</em> percent of the number of free steps. (Non-predictive heaps only.)
</p>
</li>
<li>
<p>
incr-fixed, <em>n</em>: when growing the heap, the growing should be done in increments of <em>n</em>. In the non-predictive heap, <em>n</em> is the number of steps. In other heaps, <em>n</em> denotes kilobytes.
</p>
</li>
<li>
<p>
incr-percent, <em>n</em>: when growing the heap, the growing should be done in increments of <em>n</em> percent.
</p>
</li>
</ul></div>
<div class="paragraph"><p><strong>Example:</strong> if the non-predictive heap is heap number 2, then the expressions</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(gcctl 2 'j-fixed 0)
(gcctl 2 'incr-fixed 1)</pre>
</div></div>
<div class="paragraph"><p>makes the non-predictive collector simulate a normal stop-and-copy
collector (because <em>j</em> is always set to 0), and grows the heap only
one step at a time as necessary. This may be useful for certain kinds
of experiments.</p></div>
<div class="paragraph"><p><strong>Example:</strong> ditto, the expressions</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(gcctl 2 'j-percent 50)
(gcctl 2 'incr-percent 20)</pre>
</div></div>
<div class="paragraph"><p>selects the default policy settings.</p></div>
<div class="paragraph"><p><strong>Note</strong>: The gcctl facility is experimental. A more developed
  facility will allow controlling heap contraction policy, as well as
  setting all the watermarks. Certainly one can envision other uses,
  too. Finally, it needs to be possible to get current values.</p></div>
<div class="paragraph"><p><strong>Note</strong>: Currently the non-predictive heap (np-sc-heap.c) and the
  standard stop-and-copy "old" heap (old-heap.c) are supported, but
  not the standard "young" heap (young-heap.c), nor the stop-and-copy
  collector (sc-heap.c).</p></div>
<div class="paragraph"><p><anchor id="sro" xreflabel="sro"></anchor>
<em>Procedure <var>sro</var></em>
<br />
<code>(sro <em>pointer-tag type-tag limit</em>)  =&gt; <em>vector</em></code>
<br /></p></div>
<div class="paragraph"><p>SRO ("standing room only") is a system primitive that traverses the
entire heap and returns a vector that contains all live objects in the
heap that satisfy the constraints imposed by its parameters:</p></div>
<div class="ulist"><ul>
<li>
<p>
If <em>pointer-tag</em> is -1, then object type is unconstrained;
    otherwise, the object type is constrained to have a pointer tag
    that matches <em>pointer-tag</em>. You can read all about pointer tags
    <a href="#LarcenyNoteRepr">here</a>, but the short story is that 1=pair, 3=vector-like,
    5=bytevector-like, and 7=procedure-like.
</p>
</li>
<li>
<p>
If <em>type-tag</em> is -1, then object type is unconstrained by
    type-tag; otherwise, only objects with a matching type-tag are
    selected (after selection by pointer tag). Pairs don&#8217;t have
    type-tags, but other objects do. You can read all about type-tags
    <a href="#LarcenyNoteRepr">here</a>.
</p>
</li>
<li>
<p>
<em>Limit</em> constrains the selected objects by the number of
    references. If <em>limit</em> is -1, then no constraints are imposed;
    otherwise, only objects (selected by pointer-tag and type-tag)
    with no more than <em>limit</em> references to them are selected.
</p>
</li>
</ul></div>
<div class="paragraph"><p>For example, (sro -1 -1 -1) returns a vector that contains all live
objects (not including the vector), and (sro 5 2 3) returns a vector
containing all live flonums (bytevector-like, with typetag 2) that are
referred to in no more than 3 places.</p></div>
<div class="paragraph"><p><anchor id="stats-dump-on" xreflabel="stats-dump-on"></anchor>
<em>Procedure <var>stats-dump-on</var></em>
<br />
<code>(stats-dump-on <em>filename</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Stats-dump-on turns on garbage collection statistics dumping. After
each collection, a complete RTS statistics dump is appended to the
file named by <em>filename</em>.</p></div>
<div class="paragraph"><p>The file format and contents are documented in a banner written at the
top of the output file. In addition, accessor procedures for the
output structure are defined in the program Util/process-stats.sch.</p></div>
<div class="paragraph"><p>Stats-dump-on does not perform an initial dump when the file is first
opened; only at the first collection is the first set of statistics
dumped. The user might therefore want to initiate a minor collection
just after turning on dumping in order to have a baseline set of data.</p></div>
<div class="paragraph"><p><anchor id="stats-dump-off" xreflabel="stats-dump-off"></anchor>
<em>Procedure <var>stats-dump-off</var></em>
<br />
<code>(stats-dump-off <em></em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Stats-dump-off turns off garbage collection statistics dumping (which
was turned on with <a href="#stats-dump-on">[stats-dump-on]</a>). It does not dump a final set
of statistics before closing the file; therefore, the user may wish to
initiate a minor collection before calling this procedure.</p></div>
<div class="paragraph"><p><anchor id="system-features" xreflabel="system-features"></anchor>
<em>Procedure <var>system-features</var></em>
<br />
<code>(system-features <em></em>)  =&gt; <em>alist</em></code>
<br /></p></div>
<div class="paragraph"><p>System-features returns an association lists of system features. Most
entries are self-explanatory. The following are more subtle:</p></div>
<div class="ulist"><ul>
<li>
<p>
The value of architecture-name is Larceny&#8217;s notion of the architecture for which it was compiled, not the architecture the program is currently running on. For example, the value of this feature is "Standard-C" if you&#8217;re running Petit Larceny.
</p>
</li>
<li>
<p>
The value of heap-area-info is a vector of vectors, one subvector for each heap area in the running system. The subvector has four entries: the generation number, the area type, the current size, and additional information.
</p>
</li>
</ul></div>
<div class="paragraph"><p><anchor id="display-memstats" xreflabel="display-memstats"></anchor>
<em>Procedure <var>display-memstats</var></em>
<br />
<code>(display-memstats <em>vector</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="display-memstats" xreflabel="display-memstats"></anchor>
<code>(display-memstats <em>vector minimal</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="display-memstats" xreflabel="display-memstats"></anchor>
<code>(display-memstats <em>vector full</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>Display-memstats takes as its argument a vector as returned by
<a href="#memstats">[memstats]</a> and displays the contents of the vector in
human-readable form on the current output port. By default, not all of
the values in the vector are displayed.</p></div>
<div class="paragraph"><p>If the symbol <span class="monospaced">minimal</span> is passed as the second argument, then only a
small number of statistics generally relevant to running benchmarks
are displayed.</p></div>
<div class="paragraph"><p>If the symbol <span class="monospaced">full</span> is passed as the second argument, then all
statistics are displayed.</p></div>
<div class="paragraph"><p><anchor id="memstats" xreflabel="memstats"></anchor>
<em>Procedure <var>memstats</var></em>
<br />
<code>(memstats <em></em>)  =&gt; <em>vector</em></code>
<br /></p></div>
<div class="paragraph"><p>Memstats returns a freshly allocated vector containing run-time-system
resource usage statistics. Many of these will make no sense whatsoever
to you unless you also study the RTS sources.</p></div>
<div class="paragraph"><p><anchor id="run-with-stats" xreflabel="run-with-stats"></anchor>
<em>Procedure <var>run-with-stats</var></em>
<br />
<code>(run-with-stats <em>thunk</em>)  =&gt; <em>obj</em></code>
<br /></p></div>
<div class="paragraph"><p>Run-with-stats evaluates <em>thunk</em>, then prints a short summary of
run-time statistics, as with</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(display-memstats ... 'minimal),</pre>
</div></div>
<div class="paragraph"><p>and then returns the result of evaluating <em>thunk</em>.</p></div>
<div class="paragraph"><p><anchor id="run-benchmark" xreflabel="run-benchmark"></anchor>
<em>Procedure <var>run-benchmark</var></em>
<br />
<code>(run-benchmark <em>name k thunk ok?</em>)  =&gt; <em>obj</em></code>
<br /></p></div>
<div class="paragraph"><p>Run-benchmark prints a short banner (including the identifying <em>name</em>)
to identify the benchmark, then runs <em>thunk</em> <em>k</em> times, and finally
tests the value returned from the last call to <em>thunk</em> by applying the
predicate <em>ok?</em> to it. If the predicate returns true, then
run-benchmark prints summary statistics, as with</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(display-memstats ... 'minimal).</pre>
</div></div>
<div class="paragraph"><p>If the predicate returns false, an error is signalled.</p></div>
</div>
<div class="sect2">
<h3 id="_srfi_support">12.17. SRFI Support</h3>
<div class="paragraph"><p>SRFIs (Scheme Requests For Implementations) describe and implement
additional Scheme libraries. The SRFI effort is open to anyone,
and is described at <a href="http://srfi.schemers.org">http://srfi.schemers.org</a>.</p></div>
<div class="paragraph"><p>SRFIs are numbered.  Importing SRFIs into an R7RS library or
program is straightforward:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(import (srfi 19)
        (srfi 27))</pre>
</div></div>
<div class="paragraph"><p>The R6RS forbids numbers within library names, so R6RS libraries
and programs must import SRFI libraries using the SRFI 97 naming
convention in which a colon precedes the number:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(import (srfi :19)
        (srfi :27))</pre>
</div></div>
<div class="paragraph"><p>To test whether particular SRFIs are available, use the R7RS
<span class="monospaced">cond-expand</span> feature:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(cond-expand
 ((and (library (srfi 19))
       (library (srfi 27)))
  (import (srfi 19))
  (import (srfi 27)))
 (else ...))</pre>
</div></div>
<div class="paragraph"><p><span class="monospaced">cond-expand</span> is not available to R6RS libraries or programs.</p></div>
<div class="sect3">
<h4 id="_using_srfis_in_r5rs_mode">12.17.1. Using SRFIs in R5RS mode</h4>
<div class="paragraph"><p>R5RS programs can use <span class="monospaced">cond-expand</span> as implemented by SRFI 0,
"Feature-based conditional expansion construct".  (SRFI 0 must
be loaded into Larceny before it can be used; see below.)
Larceny provides the following nonstandard key for use in SRFI 0:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    larceny</pre>
</div></div>
<div class="paragraph"><p>Some SRFIs are built into Larceny&#8217;s R5RS mode, but most must be
loaded dynamically using Larceny&#8217;s <span class="monospaced">require</span> procedure:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>    &gt; (require 'srfi-0)</pre>
</div></div>
<div class="paragraph"><p>In R5RS mode, Larceny does not support SRFIs numbered 99 and higher.</p></div>
<div class="paragraph"><p>The design documents for SRFI 0 and other SRFIs are available at
<a href="http://srfi.schemers.org">http://srfi.schemers.org</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_slib_support">12.18. SLIB support</h3>
<div class="paragraph"><p><a href="http://www-swiss.ai.mit.edu/~jaffer/SLIB.html">SLIB</a>
is a large collection of useful libraries that have been
written or collected by Aubrey Jaffer.</p></div>
<div class="paragraph"><p>Larceny supports SLIB via
<a href="http://srfi.schemers.org/srfi-96/">SRFI 96</a>,
but SLIB itself is not shipped with Larceny;
it must be downloaded separately and then installed.
For the most up-to-date information on installing and using
SLIB with Larceny, see <span class="monospaced">doc/HOWTO-SLIB</span>.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="FfiChapter">13. Foreign-Function Interface to C</h2>
<div class="sectionbody">
<div class="paragraph"><p>Larceny provides a general foreign-function interface (FFI) substrate
on which other FFIs can be built; see
<a href="LarcenyNotes/note7-ffi.html">Larceny Note #7</a>.
The FFI described in this chapter is a simple example of
a derived FFI.
It is not yet fully evolved, but it is useful.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>This chapter has undergone signficant revision, but
not all of the material has been properly vetted.
Some of the information in this chapter may be out of date.</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="FfiExamplesR7">13.1. Using the FFI in R7RS Libraries and Programs</h3>
<div class="paragraph"><p>Larceny&#8217;s FFI is implemented at the R5RS level, but can often be
used in R7RS libraries and programs by importing from Larceny&#8217;s
underlying R5RS environment.</p></div>
<div class="paragraph"><p>An R7RS program that needs Bessel functions of the first kind
can call the C function <span class="monospaced">jn</span> as shown:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(import (scheme base)
        (scheme write)
        (rename (primitives r5rs:require)
                (r5rs:require require))
        (primitives foreign-procedure))

(require 'std-ffi)    ; defines foreign-procedure at R5RS level

;;; double jn (int n, double x);

(define jn (foreign-procedure "jn" '(int double) 'double))

(write (jn 0 1.0))
(newline)</pre>
</div></div>
<div class="paragraph"><p>An R7RS program can call the C function <span class="monospaced">gettimeofday</span> as shown:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(import (scheme base)
        (scheme write)
        (except (rnrs bytevectors) bytevector-copy!)
        (rename (primitives r5rs:require)
                (r5rs:require require))
        (primitives foreign-procedure))

(require 'std-ffi)    ; defines foreign-function

;;; From &lt;sys/time.h&gt;:
;;;
;;; int gettimeofday(struct timeval *tv, struct timezone *tz);
;;;
;;; struct timeval {
;;;     time_t      tv_sec;     /* seconds */
;;;     suseconds_t tv_usec;    /* microseconds */
;;; };
;;;
;;; The second argument passed to gettimeofday should normally
;;; be NULL; passing a non-NULL argument is obsolete.
;;; The results are returned in tv-&gt;tv_sec and tv-&gt;tv_usec,
;;; as 32-bit unsigned integers.

(define timeval-size 8)      ; sizeof(struct timeval)
(define tv_sec-offset 0)     ; offset of tv_sec
(define tv_usec-offset 4)    ; offset of tv_usec

(define current-utc-time
  (let ((gettimeofday
         (foreign-procedure "gettimeofday" '(boxed boxed) 'int)))
    (lambda ()
      (let ((tv (make-bytevector timeval-size 0)))
        ;; the #f will be passed to C as NULL
        (gettimeofday tv #f)
        (values (bytevector-u32-native-ref tv tv_sec-offset)
                (bytevector-u32-native-ref tv tv_usec-offset))))))

(call-with-values
 current-utc-time
 (lambda (seconds microseconds)
   (write (list seconds microseconds))
   (newline)))</pre>
</div></div>
<div class="paragraph"><p>Larceny&#8217;s FFI can calculate the size of a C structure and the
offsets of its fields, but that calculation uses a macro that&#8217;s
available only in R5RS mode.  For example:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>#!r5rs

(require 'srfi-0)
(require 'std-ffi)    ; defines foreign-function
(require 'foreign-ctools)
(require 'foreign-cstructs)

;;; From &lt;sys/time.h&gt;:
;;;
;;; int gettimeofday(struct timeval *tv, struct timezone *tz);
;;;
;;; struct timeval {
;;;     time_t      tv_sec;     /* seconds */
;;;     suseconds_t tv_usec;    /* microseconds */
;;; };
;;;
;;; The second argument passed to gettimeofday should normally
;;; be NULL; passing a non-NULL argument is obsolete.

(define-c-info (include&lt;&gt; "sys/time.h")
  ;; defines timeval-size
  (sizeof timeval-size "struct timeval")
  (fields "struct timeval"
          ;; defines tv_sec-offset, tv_sec-size
          (tv_sec-offset "tv_sec" tv_sec-size)
          ;; defines tv_usec-offset, tv_usec-size
          (tv_usec-offset "tv_usec" tv_usec-size)))

(define current-utc-time
  (let ((gettimeofday
         (foreign-procedure "gettimeofday" '(boxed boxed) 'int)))
    (lambda ()
      (let ((tv (make-bytevector timeval-size 0)))
        (gettimeofday tv #f)
        (values (bytevector-u32-native-ref tv tv_sec-offset)
                (bytevector-u32-native-ref tv tv_usec-offset))))))</pre>
</div></div>
<div class="paragraph"><p>If the R5RS code above is in a file named <span class="monospaced">utc-time.scm</span>
that&#8217;s within one of the directories in Larceny&#8217;s library search
path, then an R7RS program can import the <span class="monospaced">current-utc-time</span>
procedure like this:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>(import (scheme base)
        (scheme write)
        (rename (primitives r5rs:require)
                (r5rs:require require)))

(require 'utc-time) ; defines current-utc-time at R5RS level

(import (primitives current-utc-time)) ; imports it from R5RS level

(call-with-values
 current-utc-time
 (lambda (seconds microseconds)
   (write (list seconds microseconds))
   (newline)))</pre>
</div></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Some of the text below is adapted from the 2008 Scheme Workshop
paper, &#8220;The Layers of Larceny&#8217;s Foreign Function Interface,&#8221;
by Felix S Klock II.  That paper may provide additional insight
for those searching for implementation details and motivations.</p></div>
</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="FfiOverview">13.2. Introducing the FFI</h3>
<div class="paragraph"><p>There are a number of different potential ways to use the FFI.
One client may want to develop code in C and load it into Larceny.
Another client may want to load native libraries
provided by the host operating system, enabling invocation
of foreign code from Scheme expressions without developing
any C code or even running a C compiler.
Larceny&#8217;s FFI can be used for both of these cases,
but many of its facilities target a third client
in between the two extremes: a client with a C compiler and
the header files and object code for the foreign libraries,
but who wishes to avoid writing glue code in C to interface
with the libraries.</p></div>
<div class="paragraph"><p>There are four main steps to interacting with foreign code:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
identifying the space of values manipulated by the
   foreign code that will also be manipulated in Scheme,
</p>
</li>
<li>
<p>
describing how to marshal values between foreign and
   Scheme code,
</p>
</li>
<li>
<p>
loading library file(s) holding foreign object code, and
</p>
</li>
<li>
<p>
linking procedures from the loaded library.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Step 1 is conceptual, while steps 2 through 4
yield artifacts in Scheme source code.</p></div>
</div>
<div class="sect2">
<h3 id="FfiForeignValues">13.3. The space of foreign values</h3>
<div class="paragraph"><p>At the machine code level, foreign values are uninterpreted
sequences of bits.  Often foreign object code is oriented
around manipulating word-sized bit-sequences (<em>words</em>)
or arrays and tuples of words.</p></div>
<div class="paragraph"><p>Many libraries are written with a particular
interpretation of such values.  In C code, explicit types are
often used as hints to guide such interpretation; for example,
a <span class="monospaced">0</span> of type <span class="monospaced">bool</span> is usually interpreted as <em>false</em>,
while a <span class="monospaced">1</span> (or other non-zero value) of type <span class="monospaced">bool</span> is
usually interpreted as <em>true</em>.
Another example are C enumerations (or <em>enums</em>).
An enum declaration defines a set of named
integral constants.  After the C declaration:</p></div>
<div class="listingblock">
<div class="content monospaced">
<pre>enum months { JAN = 1, FEB, MAR, APR, MAY, JUN, JUL, AUG, SEP, OCT, NOV, DEC };</pre>
</div></div>
<div class="paragraph"><p>a <span class="monospaced">JAN</span> in C code now denotes <span class="monospaced">1</span>, <span class="monospaced">FEB</span> is <span class="monospaced">2</span>, and so on.
Furthermore, tools like debuggers may render a variable <span class="monospaced">x</span>
dynamically assigned the value <span class="monospaced">2</span> (and of static type <span class="monospaced">enum months</span>)
as <span class="monospaced">FEB</span>.  Thus the enum declaration
intoduces a new interpretation for a finite set of integers.</p></div>
<div class="paragraph"><p>This leads to questions for a client of an FFI;
we explore some below.</p></div>
<div class="ulist"><ul>
<li>
<p>
Should foreign words be passed over to
the Scheme world as uninterpreted numbers (and thus
be converted into Scheme integers, usually fixnums),
or should they be marshaled into interpreted values, such as
<span class="monospaced">#f</span> and <span class="monospaced">#t</span> for the <span class="monospaced">bool</span> type, or the Scheme symbols
{<span class="monospaced">JAN</span>, <span class="monospaced">FEB</span>, <span class="monospaced">MAR</span>, <span class="monospaced">APR</span>, <span class="monospaced">MAY</span>, <span class="monospaced">JUN</span>,
 <span class="monospaced">JUL</span>, <span class="monospaced">AUG</span>, <span class="monospaced">SEP</span>, <span class="monospaced">OCT</span>, <span class="monospaced">NOV</span>, <span class="monospaced">DEC</span>}
for the <span class="monospaced">enum months</span> type?
</p>
</li>
<li>
<p>
Similarly, how should Scheme values be marshaled into
foreign words?
</p>
</li>
<li>
<p>
A foreign library might leave the mapping
of names like <span class="monospaced">FEB</span> to words like <span class="monospaced">2</span> <em>unspecified</em>
in the library interface.
That is, while the C compiler will know <span class="monospaced">FEB</span> maps to <span class="monospaced">2</span>
according to a particular version of the library&#8217;s header file,
the library designer may intend to change this mapping
in the future, and clients writing C code should <em>only</em> use
the names to refer to a <span class="monospaced">enum months</span> value, and <em>not</em> integer
expressions.
</p>
<div class="ulist"><ul>
<li>
<p>
How should this constraint be handled in the FFI; should
 the library client revise their code in reaction to
 such changes to the mapping?
</p>
</li>
<li>
<p>
Or should the system derive
 the mapping from the header files, in the same manner that
 the C compiler does?
</p>
</li>
</ul></div>
</li>
<li>
<p>
Foreign libraries often manipulate
mutable entities, like arrays of words where
modifications can be observed (often by design).
</p>
<div class="ulist"><ul>
<li>
<p>
How should such values be marshaled?
</p>
</li>
<li>
<p>
Is it sound to copy such values to the Scheme heap?
  If so, is a shallow copy sufficient?
</p>
</li>
</ul></div>
</li>
<li>
<p>
Will the foreign code hold references to heap-allocated
objects?  Heap-allocated objects that <em>leak</em> out to
foreign memory must be treated with care;
garbage collection presents two main problems.
</p>
<div class="ulist"><ul>
<li>
<p>
First, such objects must not move during a garbage collection;
Larceny supports this via special-purpose allocation routines:
 <span class="monospaced">cons-nonrelocatable</span>, <span class="monospaced">make-nonrelocatable-bytevector</span>,
 and <span class="monospaced">make-nonrelocatable-vector</span>.
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="ulist"><ul>
<li>
<p>
Second, the garbage collector must know to hold on to
(i.e. trace)
such values as long as they are needed by foreign code;
otherwise the objects or their referents may be
collected without the knowledge of the foreign code.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Answering these questions may require deep knowledge
of the intended usage of the foreign library.</p></div>
<div class="paragraph"><p>The Larceny FFI attempts to ease interfacing with
foreign code in the presence of the above concerns,
but the nature of the header files included with
most foreign libraries means that the FFI cannot infer
the answers unassisted.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Foreign C code developed to work in concert with Larceny
could hypothetically be written to cope with holding
handles for objects managed by the the garbage collector,
but there is currently no significant support
for this use-case.</p></div>
</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>One class of foreign values is not addressed
by the Larceny FFI: structures passed by value (as
opposed to by reference, ie pointers to structures).
There is no way to describe the interface to a
foreign procedure that accepts or produces a
C <span class="monospaced">struct</span> (at least not properly nor portably).</p></div>
<div class="paragraph"><p>This tends to not matter for many foreign libraries
(since many C programmers eschew passing structures
by value), but it can arise.</p></div>
<div class="paragraph"><p>If the foreign library of interest has procedures that
accept or produce a C <span class="monospaced">struct</span>, we currently recommend
either avoiding such procedures, or writing
adapter code in C that marshals between values handled
by the FFI and the C <span class="monospaced">struct</span>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>The conclusion is: when designing an interface to a foreign
library, you should analyze the values manipulated on the
foreign side and identify their relationship with values
on the Scheme side.
After you have identified the domains of interest,
you then describe how the values will be marshaled
back and forth between the two domains.</p></div>
</div>
<div class="sect2">
<h3 id="FfiMarshalling">13.4. Marshalling via ffi-attributes</h3>
<div class="paragraph"><p>This section describes the marshalling protocol defined in
<span class="monospaced">lib/Base/std-ffi.sch</span>.</p></div>
<div class="paragraph"><p>Foreign functions automatically marshal their inputs and outputs
according to type-descriptors attached to each foreign
function.</p></div>
<div class="paragraph"><p>Type-descriptors are S-expressons formed according to the following
grammar:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>TypeDesc ::= CoreAttr | ArrowT | MaybeT | OneOfT

CoreAttr ::= PrimAttr | VoidStar | ---

PrimAttr ::= CurrentPrimAttr | DeprecatedPrimAttr

CurrentPrimAttr
         ::= int | uint | byte | short | ushort | char | uchar
          |  long | ulong | longlong | ulonglong
          |  size_t | float | double |  bool | string | void

DeprecatedPrimAttr
         ::= unsigned | boxed

VoidStar ::= void* | ---

ArrowT   ::= (-&gt; (TypeDesc ...) TypeDesc)

MaybeT   ::= (maybe TypeDesc)

OneOfT   ::= (oneof (Any Fixnum) ... TypeDesc)</pre>
</div></div>
<div class="paragraph"><p>where <span class="monospaced">---</span> represents a user-extensible part of the grammar
(see below),
<span class="monospaced">Any</span> represents any Scheme value, and <span class="monospaced">Fixnum</span> represents
any word-sized integer.</p></div>
<div class="paragraph"><p>A central registry maps <span class="monospaced">CoreAttr</span>'s to a foreign
representation and two conversion routines:
one to convert a Scheme value to a foreign argument, and
another to convert a foreign result back back to a Scheme value.
The denoted components are collectively referred to as a <em>type</em>
within the FFI documentation.
The registry is extensible; the <span class="monospaced">ffi-add-attribute-core-entry!</span>
procedure adds new <span class="monospaced">CoreAttr&#8217;s</span> to the registry, and
one can alternatively add short-hands for
type-descriptors via the <span class="monospaced">ffi-add-alias-of-attribute-entry!</span>
procedure.
Finally, one can add new <span class="monospaced">VoidStar</span> productions
(subtypes of the <span class="monospaced">void*</span> type-descriptor)
via the <span class="monospaced">ffi-install-void*-subtype</span> procedure
(defined in the <span class="monospaced">lib/Standard/foreign-stdlib.sch</span> library).</p></div>
<div class="sect3">
<h4 id="_primitive_attribute_types">13.4.1. Primitive Attribute Types</h4>
<div class="paragraph"><p>The following is a list of the accepted types and their conversions
at the boundary between Scheme and foreign code:</p></div>
<div class="dlist"><dl>
<dt class="hdlist1">
<span class="monospaced">int</span>
</dt>
<dd>
<p>
  Exact integer values in the range [-2<sup>31</sup>,2<sup>31</sup>-1].
  Scheme integers in that range are converted to and from C "<span class="monospaced">int</span>".
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">uint</span>
</dt>
<dd>
<p>
  Exact integer values in the range [0,2<sup>32</sup>-1].
  Scheme integers in that ranges are converted to and from C "<span class="monospaced">unsigned int</span>".
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">byte</span>
</dt>
<dd>
<p>
  Synonymous with <span class="monospaced">int</span> in the current implementation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">short</span>
</dt>
<dd>
<p>
  Synonymous with <span class="monospaced">int</span> in the current implementation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">ushort</span>
</dt>
<dd>
<p>
  Synonymous with <span class="monospaced">unsigned</span> in the current implementation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">char</span>
</dt>
<dd>
<p>
  Scheme ASCII characters are converted to and from C "<span class="monospaced">char</span>".
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">uchar</span>
</dt>
<dd>
<p>
  Scheme ASCII characters are converted to and from C "<span class="monospaced">unsigned char</span>".
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">long</span>
</dt>
<dd>
<p>
  Synonymous with <span class="monospaced">int</span> in the current implementation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">ulong</span>
</dt>
<dd>
<p>
  Synonymous with <span class="monospaced">unsigned</span> in the current implementation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">longlong</span>
</dt>
<dd>
<p>
  Exact integer values in the range [-2<sup>63</sup>,2<sup>63</sup>-1].
  Scheme integers in that range are converted
  to and from C "<span class="monospaced">long long</span>".
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">ulonglong</span>
</dt>
<dd>
<p>
  Exact integer values in the range [0,2<sup>64</sup>-1].
  Scheme integers in that range are converted
  to and from C "<span class="monospaced">unsigned long long</span>".
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">size_t</span>
</dt>
<dd>
<p>
  Synonymous with <span class="monospaced">uint</span> in the current implementation.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">float</span>
</dt>
<dd>
<p>
  Scheme flonums are converted to and from C "<span class="monospaced">float</span>".
  The conversion to <span class="monospaced">float</span> is performed via
  a C <span class="monospaced">(float)</span> cast from a C <span class="monospaced">double</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">double</span>
</dt>
<dd>
<p>
  Scheme flonums are converted to and from C "double".
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">bool</span>
</dt>
<dd>
<p>
  Scheme objects are converted to C "<span class="monospaced">int</span>";
  <span class="monospaced">#f</span> is converted to 0, and all other objects to 1.
  In the reverse direction, 0 is converted to <span class="monospaced">#f</span> and
  all other integers to <span class="monospaced">#t</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">string</span>
</dt>
<dd>
<p>
  A Scheme string holding ASCII characters
  is <em>copied</em> into a NUL-terminated bytevector,
  passing a pointer to its first byte to the foreign procedure;
  <span class="monospaced">#f</span> is converted to a C "<span class="monospaced">(char*)0</span>" value.
  In the reverse direction, a pointer to a NUL-terminated sequence
  of bytes interpreted as ASCII characters is
  copied into a freshly allocated Scheme string; a NULL pointer is
  converted to <span class="monospaced">#f</span>.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">void</span>
</dt>
<dd>
<p>
  No return value.
  (Only used in return position for foreign functions;
  all Scheme procedures passed to the FFI are invoked in a context
  expecting one value.)
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">unsigned</span>
</dt>
<dd>
<p>
  Synonymous with <span class="monospaced">uint</span>; deprecated.
</p>
</dd>
<dt class="hdlist1">
<span class="monospaced">boxed</span>
</dt>
<dd>
<p>
  Any heap-allocated data structure (pair,
  bytevector-like, vector-like, procedure) is converted to
  a C "<span class="monospaced">void*</span>" to the first element of the structure. The
  value <span class="monospaced">#f</span> is also acceptable. It is converted to a C "<span class="monospaced">(void*)0</span>"
  value.
  (Only used in argument position for foreign functions; foreign
   functions are not expected to return direct references
   to heap-allocated values.)
</p>
</dd>
</dl></div>
</div>
<div class="sect3">
<h4 id="_extending_the_core_attribute_registry">13.4.2. Extending the Core Attribute Registry</h4>
<div class="paragraph"><p>The public interface to many foreign libraries is written
in terms of types defined within that foreign library.
One can introduce new types to the Larceny FFI
by extending the core attribute entry table.</p></div>
<div class="paragraph"><p><anchor id="ffi-add-attribute-core-entry!" xreflabel="ffi-add-attribute-core-entry!"></anchor>
<em>Procedure <var>ffi-add-attribute-core-entry!</var></em>
<br />
<code>(ffi-add-attribute-core-entry! <em>entry-name rep-sym marshal unmarshal</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><span class="monospaced">ffi-add-attribute-core-entry!</span> extends the
internal registry with the new entry specified by its arguments.</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>entry-name</em> is a symbol (the symbolic type name being
introduced to the ffi).
</p>
</li>
<li>
<p>
<em>rep-name</em> is a low-level type descriptor symbol, one of
<span class="monospaced">signed32</span>, <span class="monospaced">unsigned32</span>, <span class="monospaced">signed64</span>, <span class="monospaced">unsigned64</span>
(representing varieties of fixed width integers),
<span class="monospaced">ieee32</span> (representing &#8220;floats&#8221;),
<span class="monospaced">ieee64</span> (representing &#8220;doubles&#8221;), or
<span class="monospaced">pointer</span> (representing &#8220;+(void*)+&#8221; in C).
</p>
</li>
<li>
<p>
<em>marshal</em> is a marshaling function that accepts a Scheme object and a symbol
(the name of the invoking procedure); it is responsible for checking
the Scheme object&#8217;s validity and then producing a corresponding
instance of the low-level representation.
</p>
</li>
<li>
<p>
<em>unmarshal</em> is either <span class="monospaced">#f</span> or an unmarshalling function that
accepts an instance of the low-level representation
and produces a corresponding Scheme object.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_attribute_type_constructors">13.4.3. Attribute Type Constructors</h4>
<div class="paragraph"><p>Core attributes suffice for linking to simple
functions.
Constructured FFI attributes express more complex
marshaling protocols</p></div>
<div class="paragraph"><div class="title">Arrow Type Constructors</div><p>A structured FFI attribute
of the form <span class="monospaced">(&#8594; (<em>s<sub>1</sub></em> &#8230; <em>s<sub>n</sub></em>) <em>s<sub>r</sub></em>)</span>
(called an <em>arrow type</em>)
allows passing functions from Scheme to C
and back again.  Each of the <em>s<sub>1</sub></em>, &#8230;, <em>s<sub>n</sub></em>, <em>s<sub>r</sub></em>
is an FFI attribute.
When an arrow type describes an input to a foreign
function, it marshals a Scheme procedure to a
C function pointer by generating glue code to hook the two together
and marshal values as described by the FFI attributes
within the arrow type.
Likewise, when an arrow type describes an output from a
foreign function, it marshals a C function pointer
to a Scheme procedure, again by generating glue code.
These two mappings naturally generalize to arbitrary nesting
of arrow types, so one can create callbacks that consume
callouts, return callouts that consume callbacks, and so on.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph"><p>The current implementation of arrow types introduces an
unnecessary space leak, because none of Larceny&#8217;s current
garbage collectors attempt to reclaim some of the structure
allocated (in particular, the so-called trampolines)
when functions are marshaled via arrow types.</p></div>
<div class="paragraph"><p>The FFI could be revised to reduce the leak
(e.g. it could keep a cache of generated trampolines and
reuse them, but currently do not do so).</p></div>
<div class="paragraph"><p>Many foreign libraries have a structure where one only
sets up a fixed set of callbacks, and then all further
computation does not require arrow type marshaling.
This is one reason why fixing this problem
has been a low priority item for the Larceny development
team.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><div class="title">Maybe Type Constructor</div><p><span class="monospaced">(maybe <em>t</em>)</span> captures the
pattern of passing <span class="monospaced">NULL</span> in C and <span class="monospaced">#f</span> in Scheme
to represent the absence of information.
The FFI attribute <em>t</em> within the maybe type
describes the typical information passed;
the constructed maybe type
marshals <span class="monospaced">#f</span> to the foreign null pointer or <span class="monospaced">0</span> (as appropriate),
and otherwise applies the marshaling of <em>t</em>.
Likewise, it unmarshals the foreign
null pointer and <span class="monospaced">0</span> to <span class="monospaced">#f</span>, and otherwise applies the
unmarshaling of <em>t</em>.</p></div>
<div class="paragraph"><p>(There are a few other built-in type constructors, such as
 the <span class="monospaced">oneof</span> type constructor, but they
 are not as fully-developed as the two above, and are intended
 for use only for internal development for now.)</p></div>
</div>
<div class="sect3">
<h4 id="_void_type_hierarchies">13.4.4. void* Type Hierarchies</h4>
<div class="paragraph"><p>Using the <span class="monospaced">void*</span> attribute
wraps foreign addresses up in a Larceny record,
so that standard numeric
operations cannot be directly applied by accident.
The FFI uses two features of Larceny&#8217;s record system:
the record type descriptor is a first class
value with an inspectable name, and
record types are extensible via single-inheritance.</p></div>
<div class="paragraph"><div class="title">Basic Operations on <span class="monospaced">void*</span></div><p>The FFI provides <span class="monospaced">void*-rt</span>, a record type
descriptor with a single field (a wrapped address).
There is also a family of functions for dereferencing the
pointer within a <span class="monospaced">void*-rt</span> and manipulating the
state it references.</p></div>
<div class="paragraph"><p><anchor id="void*&#8594;address" xreflabel="void*&#8594;address"></anchor>
<em>Procedure <var>void*&#8594;address</var></em>
<br />
<code>(void*&#8594;address <em>x</em>)  =&gt; <em>number</em></code>
<br />
Extracts the underlying address held in a <span class="monospaced">void*</span>.</p></div>
<div class="paragraph"><p><anchor id="void*?" xreflabel="void*?"></anchor>
<em>Procedure <var>void*?</var></em>
<br />
<code>(void*? <em>x</em>)  =&gt; <em>boolean</em></code>
<br />
Distinquishes <span class="monospaced">void*</span>'s from other Scheme values.</p></div>
<div class="paragraph"><p><anchor id="void*-byte-ref" xreflabel="void*-byte-ref"></anchor>
<em>Procedure <var>void*-byte-ref</var></em>
<br />
<code>(void*-byte-ref <em>x idx</em>)  =&gt; <em>number</em></code>
<br />
Extracts byte at offset from address within <em>x</em>.</p></div>
<div class="paragraph"><p><anchor id="void*-byte-set!" xreflabel="void*-byte-set!"></anchor>
<em>Procedure <var>void*-byte-set!</var></em>
<br />
<code>(void*-byte-set! <em>x idx val</em>)  =&gt; <em>unspecified</em></code>
<br />
Modifies byte at offset from address within <em>x</em>.</p></div>
<div class="paragraph"><p><anchor id="void*-word-ref" xreflabel="void*-word-ref"></anchor>
<em>Procedure <var>void*-word-ref</var></em>
<br />
<code>(void*-word-ref <em>x idx</em>)  =&gt; <em>number</em></code>
<br />
Extracts word-sized integer at offset from address within <em>x</em>.</p></div>
<div class="paragraph"><p><anchor id="void*-word-set!" xreflabel="void*-word-set!"></anchor>
<em>Procedure <var>void*-word-set!</var></em>
<br />
<code>(void*-word-set! <em>x idx val</em>)  =&gt; <em>unspecified</em></code>
<br />
Modifies word-sized integer at offset from address within <em>x</em>.</p></div>
<div class="paragraph"><p><anchor id="void*-void*-ref" xreflabel="void*-void*-ref"></anchor>
<em>Procedure <var>void*-void*-ref</var></em>
<br />
<code>(void*-void*-ref <em>x idx</em>)  =&gt; <em>void*</em></code>
<br />
Extracts address (and wraps it in a <span class="monospaced">void*</span>) at offset from address within <em>x</em>.</p></div>
<div class="paragraph"><p><anchor id="void*-void*-set!" xreflabel="void*-void*-set!"></anchor>
<em>Procedure <var>void*-void*-set!</var></em>
<br />
<code>(void*-void*-set! <em>x idx val</em>)  =&gt; <em>unspecified</em></code>
<br />
Modifies address at offset from address within <em>x</em>.</p></div>
<div class="paragraph"><p><anchor id="void*-double-ref" xreflabel="void*-double-ref"></anchor>
<em>Procedure <var>void*-double-ref</var></em>
<br />
<code>(void*-double-ref <em>x idx</em>)  =&gt; <em>number</em></code>
<br />
Extracts 64-bit flonum at offset from address within <em>x</em>.</p></div>
<div class="paragraph"><p><anchor id="void*-double-set!" xreflabel="void*-double-set!"></anchor>
<em>Procedure <var>void*-double-set!</var></em>
<br />
<code>(void*-double-set! <em>x idx val</em>)  =&gt; <em>unspecified</em></code>
<br />
Modifies 64-bit flonum at offset from address within <em>x</em>.</p></div>
<div class="paragraph"><div class="title">Type Hierarchies</div><p>Procedures for establishing type hierarchies are provided by the
<span class="monospaced">lib/Standard/foreign-stdlib.sch</span> library; see
<a href="#ffi-install-void*-subtype">[ffi-install-void*-subtype]</a> and <a href="#establish-void*-subhierarchy!">[establish-void*-subhierarchy!]</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FfiCompiliing">13.5. Creating loadable modules</h3>
<div class="paragraph"><p>You must first compile your C code and create one or more loadable object modules. These object modules may then be loaded into Larceny, and Scheme foreign functions may link to specific functions in the loaded module. Defining foreign functions in Scheme is covered in a later section.</p></div>
<div class="paragraph"><p>The method for creating a loadable object module varies from platform to platform. In the following, assume you have to C source files file1.c and file2.c that define functions that you want to make available as foreign functions in Larceny.</p></div>
<div class="sect3">
<h4 id="_sunos_4">13.5.1. SunOS 4</h4>
<div class="paragraph"><p>Compile your source files and create a shared library. Using GCC, the command line might look like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>gcc -fPIC -shared file1.c file2.c -o my-library.so</pre>
</div></div>
<div class="paragraph"><p>The command creates my-library.so in the current directory. This library can now be loaded into Larceny using <a href="#foreign-file">[foreign-file]</a>. Any other shared libraries used by your library files should also be loaded into Larceny using <a href="#foreign-file">[foreign-file]</a> before any procedures are linked using <a href="#foreign-procedure">[foreign-procedure]</a>.</p></div>
<div class="paragraph"><p>By default, /lib/libc.so is made available to the dynamic linker and to the foreign function interface, so there is no need for you to load that library explicitly.</p></div>
</div>
<div class="sect3">
<h4 id="_sunos_5">13.5.2. SunOS 5</h4>
<div class="paragraph"><p>Compile your source files and create a shared library, linking with all the necessary libraries. Using GCC, the command line might look like this:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>gcc -fPIC -shared file1.c file2.c -lc -lm -lsocket -o my-library.so</pre>
</div></div>
<div class="paragraph"><p>Now you can use foreign-file to load my-library.so into Larceny.</p></div>
<div class="paragraph"><p>By default, /lib/libc.so is made available to the foreign function interface, so there is no need for you to load that library explicitly.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FfiInterface">13.6. The Interface</h3>
<div class="sect3">
<h4 id="_procedures_2">13.6.1. Procedures</h4>
<div class="paragraph"><p><anchor id="foreign-file" xreflabel="foreign-file"></anchor>
<em>Procedure <var>foreign-file</var></em>
<br />
<code>(foreign-file <em>filename</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><span class="monospaced">foreign-file</span> loads the named object file into Larceny and
makes it available for dynamic linking.</p></div>
<div class="paragraph"><p>Larceny uses the operating system provided dynamic linker to
do dynamic linking. The operation of the dynamic linker varies
from platform to platform:</p></div>
<div class="ulist"><ul>
<li>
<p>
On some versions of SunOS 4, if the linker is given a file that does not exist, it will terminate the process. (Most likely this is a bug.) This means you should never call foreign-file with the name of a file that does not exist.
</p>
</li>
<li>
<p>
On SunOS 5, if a foreign file is given to foreign-file without a directory specification, then the dynamic linker will search its load path (the <span class="monospaced">LD_LIBRARY_PATH</span> environment variable) for the file. Hence, a foreign file in the current directory should be "./file.so", not "file.so".
</p>
</li>
</ul></div>
<div class="paragraph"><p><anchor id="foreign-procedure" xreflabel="foreign-procedure"></anchor>
<em>Procedure <var>foreign-procedure</var></em>
<br />
<code>(foreign-procedure <em>name (arg-type &#8230;) return-type</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>FIXME: The interface to this function has been extended to support
hooking into Windows procedures that use the Pascal calling convention
instead of the C one.  The way to select which convention to use
should be documented.</p></div>
<div class="paragraph"><p>Returns a Scheme procedure <em>p</em> that calls the foreign procedure whose
name is <em>name</em>. When <em>p</em> is called, it will convert its parameters to
representations indicated by the <em>arg-type</em>s and invoke the foreign
procedure, passing the converted values as parameters. When the
foreign procedure returns, its return value is converted to a Scheme
value according to <em>return-type</em>.</p></div>
<div class="paragraph"><p>Types are described below.</p></div>
<div class="paragraph"><p>The address of the foreign procedure is obtained by searching for <em>name</em> in the symbol tables of the foreign files that have been loaded with <em>foreign-file</em>.</p></div>
<div class="paragraph"><p><anchor id="foreign-null-pointer" xreflabel="foreign-null-pointer"></anchor>
<em>Procedure <var>foreign-null-pointer</var></em>
<br />
<code>(foreign-null-pointer <em></em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p>Returns a foreign null pointer.</p></div>
<div class="paragraph"><p><anchor id="foreign-null-pointer?" xreflabel="foreign-null-pointer?"></anchor>
<em>Procedure <var>foreign-null-pointer?</var></em>
<br />
<code>(foreign-null-pointer? <em>integer</em>)  =&gt; <em>boolean</em></code>
<br /></p></div>
<div class="paragraph"><p>Tests whether its argument is a foreign null pointer.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FfiAccess">13.7. Foreign Data Access</h3>
<div class="sect3">
<h4 id="_raw_memory_access">13.7.1. Raw memory access</h4>
<div class="paragraph"><p>The two primitives <em>peek-bytes</em> and <em>poke-bytes</em> are provided for reading and writing memory at specific addresses. These procedures are typically used for copying data from foreign data structures into Scheme bytevectors for subsequent decoding.</p></div>
<div class="paragraph"><p>(The use of <em>peek-bytes</em> and <em>poke-bytes</em> can often be avoided by keeping foreign data in a Scheme bytevector and passing the bytevector to a call-out using the <strong>boxed</strong> parameter type. However, this technique is inappropriate if the foreign code retains a pointer to the Scheme datum, which may be moved by the garbage collector.)</p></div>
<div class="paragraph"><p><anchor id="peek-bytes" xreflabel="peek-bytes"></anchor>
<em>Procedure <var>peek-bytes</var></em>
<br />
<code>(peek-bytes <em>addr bytevector count</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><em>Addr</em> must be an exact nonnegative integer. <em>Count</em> must be a fixnum. The bytes in the range from <em>addr</em> through <em>addr+count-1</em> are copied into <em>bytevector</em>, which must be long enough to hold that many bytes.</p></div>
<div class="paragraph"><p>If any address in the range is not an address accessible to the process, unpredictable things may happen. Typically, you&#8217;ll get a segmentation fault. Larceny does not yet catch segmentation faults.</p></div>
<div class="paragraph"><p><anchor id="poke-bytes" xreflabel="poke-bytes"></anchor>
<em>Procedure <var>poke-bytes</var></em>
<br />
<code>(poke-bytes <em>addr bytevector count</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><em>Addr</em> must be an exact nonnegative integer. <em>Count</em> must be a fixnum. The <em>count</em> first bytes from <em>bytevector</em> are copied into memory in the range from <em>addr</em> through <em>addr+count-1</em>.</p></div>
<div class="paragraph"><p>If any address in the range is not an address accessible to the process, unpredictable things may happen. Typically, you&#8217;ll get a segmentation fault. Larceny does not yet catch segmentation faults.</p></div>
<div class="paragraph"><p>Also, it&#8217;s possible to corrupt memory with <em>poke-bytes</em>. Don&#8217;t do that.</p></div>
</div>
<div class="sect3">
<h4 id="_foreign_data_sizes">13.7.2. Foreign data sizes</h4>
<div class="paragraph"><p>The following variables constants define the sizes of basic C data types:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>sizeof:short</strong> The size of a "short int".
</p>
</li>
<li>
<p>
<strong>sizeof:int</strong> The size of an "int".
</p>
</li>
<li>
<p>
<strong>sizeof:long</strong> The size of a "long int".
</p>
</li>
<li>
<p>
<strong>sizeof:pointer</strong> The size of any pointer type.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_decoding_foreign_data">13.7.3. Decoding foreign data</h4>
<div class="paragraph"><p>Foreign data is visible to a Scheme program either as an object pointed to by a memory address (which is itself represented as an integer), or as a bytevector that contains the bytes of the foreign datum.</p></div>
<div class="paragraph"><p>A number of utility procedures that make reading and writing data of common C primitive types have been written for both these kinds of foreign objects.</p></div>
<div class="paragraph"><p><em>Bytevector accessor procedures</em></p></div>
<div class="paragraph"><p><anchor id="%get16" xreflabel="%get16"></anchor>
<code>(%get16 <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get16u" xreflabel="%get16u"></anchor>
<code>(%get16u <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get32" xreflabel="%get32"></anchor>
<code>(%get32 <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get32u" xreflabel="%get32u"></anchor>
<code>(%get32u <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get-int" xreflabel="%get-int"></anchor>
<code>(%get-int <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get-unsigned" xreflabel="%get-unsigned"></anchor>
<code>(%get-unsigned <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get-short" xreflabel="%get-short"></anchor>
<code>(%get-short <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get-ushort" xreflabel="%get-ushort"></anchor>
<code>(%get-ushort <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get-long" xreflabel="%get-long"></anchor>
<code>(%get-long <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get-ulong" xreflabel="%get-ulong"></anchor>
<code>(%get-ulong <em>bv i</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%get-pointer" xreflabel="%get-pointer"></anchor>
<code>(%get-pointer <em>bv i</em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p>These procedures decode bytevectors that contain the bytes of foreign objects. In each case, <em>bv</em> is a bytevector and <em>i</em> is the offset of the first byte of a field in that bytevector. The field is fetched and returned as an integer (signed or unsigned as appropriate).</p></div>
<div class="paragraph"><p><em>Bytevector updater procedures</em></p></div>
<div class="paragraph"><p><anchor id="%set16" xreflabel="%set16"></anchor>
<code>(%set16 <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set16u" xreflabel="%set16u"></anchor>
<code>(%set16u <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set32" xreflabel="%set32"></anchor>
<code>(%set32 <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set32u" xreflabel="%set32u"></anchor>
<code>(%set32u <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set-int" xreflabel="%set-int"></anchor>
<code>(%set-int <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set-unsigned" xreflabel="%set-unsigned"></anchor>
<code>(%set-unsigned <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set-short" xreflabel="%set-short"></anchor>
<code>(%set-short <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set-ushort" xreflabel="%set-ushort"></anchor>
<code>(%set-ushort <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set-long" xreflabel="%set-long"></anchor>
<code>(%set-long <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set-ulong" xreflabel="%set-ulong"></anchor>
<code>(%set-ulong <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%set-pointer" xreflabel="%set-pointer"></anchor>
<code>(%set-pointer <em>bv i val</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>These procedures update bytevectors that contain the bytes of foreign objects. In each case, <em>bv</em> is a bytevector, <em>i</em> is an offset of the first byte of a field in that bytevector, and <em>val</em> is a value to be stored in that field. The values must be exact integers in a range implied by the data type.</p></div>
<div class="paragraph"><p><em>Foreign-pointer accessor procedures</em></p></div>
<div class="paragraph"><p><anchor id="%peek8" xreflabel="%peek8"></anchor>
<code>(%peek8 <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek8u" xreflabel="%peek8u"></anchor>
<code>(%peek8u <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek16" xreflabel="%peek16"></anchor>
<code>(%peek16 <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek16u" xreflabel="%peek16u"></anchor>
<code>(%peek16u <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek32" xreflabel="%peek32"></anchor>
<code>(%peek32 <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek32u" xreflabel="%peek32u"></anchor>
<code>(%peek32u <em>addr</em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="%peek-int" xreflabel="%peek-int"></anchor>
<code>(%peek-int <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek-long" xreflabel="%peek-long"></anchor>
<code>(%peek-long <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek-unsigned" xreflabel="%peek-unsigned"></anchor>
<code>(%peek-unsigned <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek-ulong" xreflabel="%peek-ulong"></anchor>
<code>(%peek-ulong <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek-short" xreflabel="%peek-short"></anchor>
<code>(%peek-short <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek-ushort" xreflabel="%peek-ushort"></anchor>
<code>(%peek-ushort <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek-pointer" xreflabel="%peek-pointer"></anchor>
<code>(%peek-pointer <em>addr</em>)  =&gt; <em>integer</em></code>
<br />
<anchor id="%peek-string" xreflabel="%peek-string"></anchor>
<code>(%peek-string <em>addr</em>)  =&gt; <em>integer</em></code>
<br /></p></div>
<div class="paragraph"><p>These procedures read raw memory. In each case, <em>addr</em> is an address, and the value stored at that address (the size of which is indicated by the name of the procedure) is fetched and returned as an integer.</p></div>
<div class="paragraph"><p><em>%Peek-string</em> expects to find a NUL-terminated string of 8-bit bytes at the given address. It is returned as a Scheme string.</p></div>
<div class="paragraph"><p><em>Foreign-pointer updater procedures</em></p></div>
<div class="paragraph"><p><anchor id="%poke8" xreflabel="%poke8"></anchor>
<code>(%poke8 <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke8u" xreflabel="%poke8u"></anchor>
<code>(%poke8u <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke16" xreflabel="%poke16"></anchor>
<code>(%poke16 <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke16u" xreflabel="%poke16u"></anchor>
<code>(%poke16u <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke32" xreflabel="%poke32"></anchor>
<code>(%poke32 <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke32u" xreflabel="%poke32u"></anchor>
<code>(%poke32u <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><anchor id="%poke-int" xreflabel="%poke-int"></anchor>
<code>(%poke-int <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke-long" xreflabel="%poke-long"></anchor>
<code>(%poke-long <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke-unsigned" xreflabel="%poke-unsigned"></anchor>
<code>(%poke-unsigned <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke-ulong" xreflabel="%poke-ulong"></anchor>
<code>(%poke-ulong <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke-short" xreflabel="%poke-short"></anchor>
<code>(%poke-short <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke-ushort" xreflabel="%poke-ushort"></anchor>
<code>(%poke-ushort <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br />
<anchor id="%poke-pointer" xreflabel="%poke-pointer"></anchor>
<code>(%poke-pointer <em>addr val</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p>These procedures update raw memory. In each case, <em>addr</em> is an address, and <em>val</em> is a value to be stored at that address.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="FfiDumping">13.8. Heap dumping and the FFI</h3>
<div class="paragraph"><p>If foreign functions are linked into Larceny using the FFI, and a
Larceny heap image is subsequently dumped (with
<a href="#dump-interactive-heap">[dump-interactive-heap]</a> or
<a href="#dump-heap">[dump-heap]</a>), then the foreign functions are not saved as
part of the heap image. When the heap image is subsequently loaded
into Larceny at startup, the FFI will attempt to re-link all the
foreign functions in the heap image.</p></div>
<div class="paragraph"><p>During the relinking phase, foreign files will again be loaded into Larceny, and Larceny&#8217;s FFI will use the file names <em>as they were originally given to the FFI</em> when it tries to load the files. In particular, if relative pathnames were used, Larceny will not have converted them to absolute pathnames.</p></div>
<div class="paragraph"><p>An error during relinking will result in Larceny aborting with an error message and returning to the operating system. This is considered a feature.</p></div>
</div>
<div class="sect2">
<h3 id="FfiExamples">13.9. Examples</h3>
<div class="sect3">
<h4 id="_change_directory">13.9.1. Change directory</h4>
<div class="paragraph"><p>This procedure uses the chdir() system call to set the process&#8217;s current working directory. The string parameter type is used to pass a Scheme string to the C procedure.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(define cd
  (let ((chdir (foreign-procedure "chdir" '(string) 'int)))
    (lambda (newdir)
      (if (not (zero? (chdir newdir)))
      (error "cd: " newdir " is not a valid directory name."))
      (unspecified))))</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_print_working_directory">13.9.2. Print Working Directory</h4>
<div class="paragraph"><p>This procedure uses the getcwd() (get current working directory) system call to retrieve the name of the process&#8217;s current working directory. A bytevector is created and passed in as a buffer in which to store the return value&#8201;&#8212;&#8201;a 0-terminated ASCII string. Then the FFI utility function ffi/asciiz&#8594;string is called to convert the bytevector to a string.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(define pwd
  (let ((getcwd (foreign-procedure "getcwd" '(boxed int) 'int)))
    (lambda ()
      (let ((s (make-bytevector 1024)))
    (getcwd s 1024)
    (ffi/asciiz-&gt;string s)))))</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_quicksort">13.9.3. Quicksort</h4>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">this example is bogus.  It is not safe to pass a collectable
object into a C procedure when the callback invocation might cause a
garbage collection, thus moving the object and invalidating the
address stored in the C machine context.</td>
</tr></table>
</div>
<div class="paragraph"><p>This demonstrates how to use a callback such as the comparator argument to qsort.
It is specified in the type signature using &#8594; as a type constructor.
(Note that one should probably use the built-in sort routines rather than call out
 like this; this example is for demonstrating callbacks, not how to sort.)</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(define qsort!
  (foreign-procedure "qsort" '(boxed ushort ushort (-&gt; (void* void*) int)) 'void))</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(let ((bv (list-&gt;vector '(40 10 30 20 1 2 3 4))))
  (qsort! bv 8 4
          (lambda (x y)
            (let ((x (/ (void*-word-ref x 0) 4))
                  (y (/ (void*-word-ref y 0) 4)))
              (- x y))))
  bv)</pre>
</div></div>
<div class="literalblock">
<div class="content monospaced">
<pre>(let ((bv (list-&gt;bytevector '(40 10 30 20 1 2 3 4))))
  (qsort! bv 8 1
          (lambda (x y)
            (let ((x (void*-byte-ref x 0))
                  (y (void*-byte-ref y 0)))
              (- x y))))
  bv)</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_other_examples">13.9.4. Other examples</h4>
<div class="paragraph"><p>The Experimental directory contains several examples of use of the FFI. See in particular the files unix.sch (Unix system calls) and socket.sch (procedures for communicating over sockets).</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_higher_level_layers">13.10. Higher level layers</h3>
<div class="paragraph"><p>The general foreign-function interface functionality described above
is powerful but awkward to use in practice.  A user might be tempted
to hard code values of offsets or constants that are compiler
dependent.  Also, the FFI will marshall some low-level values such
as strings or integers, but other values such as enumerations
which could be naturally mapped to sets of symbols are not marshalled
since the host environment does not provide the necessary type
information to the FFI.</p></div>
<div class="paragraph"><p>This section documents a collection of libraries to mitigate these and
other problems.</p></div>
<div class="sect3">
<h4 id="_foreign_ctools">13.10.1. foreign-ctools</h4>
<div class="paragraph"><p>Foreign data access is performed by peeking at manually calculated
addresses, but in practice one often needs to inspect fields of C
structures, whose offsets are dependant on the application binary
interface (ABI) of the host environment.  Similarly, C programs often
use refer to values via constant macro definitions; since the values
of such names are not provided by the object code and Scheme programs
do not have a C preprocessor run on them prior to execution, it is
difficult to refer to the same value without encoding "magic numbers"
into the Scheme source code.</p></div>
<div class="paragraph"><p>The foreign-ctools library is meant to mitigate problems like the two
described above.  It provides special forms for introducing global
definitions of values typically available at compile-time for a C
program.  The library assumes the presence of a C compiler (such as
<em>cc</em> on Unix systems or <em>cl.exe</em> on Windows systems).  The special
forms work by dynamically generating, compiling, and running C code at
expansion time to determine the desired values of structure offsets or
macro constants.</p></div>
<div class="paragraph"><p>Here is a grammar for the <span class="monospaced">define-c-info</span> form provided by
the <span class="monospaced">foreign-ctools</span> library.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>&lt;exp&gt;     ::= (define-c-info &lt;c-decl&gt; ... &lt;c-defn&gt; ...)

&lt;c-decl&gt;  ::= (compiler &lt;cc-spec&gt;)
           |  (path &lt;include-path&gt;)
           |  (include &lt;header&gt;)
           |  (include&lt;&gt; &lt;header&gt;)

&lt;cc-spec&gt; ::= cc | cl

&lt;c-defn&gt;  ::= (const &lt;id&gt; &lt;c-type&gt; &lt;c-expr&gt;)
           |  (sizeof &lt;id&gt; &lt;c-type-expr&gt;)
           |  (struct &lt;c-name&gt; &lt;field-clause&gt; ...)
           |  (fields &lt;c-name&gt; &lt;field-clause&gt; ...)
           |  (ifdefconst &lt;id&gt; &lt;c-type&gt; &lt;c-name&gt;)

&lt;c-type&gt;  ::= int | uint | long | ulong

&lt;include-path&gt;
          ::= &lt;string-literal&gt;

&lt;header&gt;  ::= &lt;string-literal&gt;

&lt;field-clause&gt;
          ::= (&lt;offset-id&gt; &lt;c-field&gt;)
           |  (&lt;offset-id&gt; &lt;c-field&gt; &lt;size-id&gt;)

&lt;c-expr&gt;  ::= &lt;string-literal&gt;

&lt;c-type-expr&gt;
          ::= &lt;string-literal&gt;

&lt;c-name&gt;  ::= &lt;string-literal&gt;

&lt;c-field&gt; ::= &lt;string-literal&gt;</pre>
</div></div>
<div class="paragraph"><p><em>Syntax define-c-info</em></p></div>
<div class="paragraph"><p><span class="monospaced"> (define-c-info &lt;c-decl&gt; &#8230; &lt;c-defn&gt; &#8230;)</span></p></div>
<div class="paragraph"><p>The <span class="monospaced">&lt;c-decl&gt;</span> clauses of <span class="monospaced">define-c-info</span>
control how header files are processed.
The <span class="monospaced">compiler</span> clause selects between <span class="monospaced">cc</span>
(the default UNIX system compiler) and <span class="monospaced">cl</span>
(the compiler included with Microsoft&#8217;s Windows SDK).
The <span class="monospaced">path</span> clause adds a directory to search when
looking for header files.
The <span class="monospaced">include</span> and <span class="monospaced">include&lt;&gt;</span> clauses indicate
header files to include when executing the
<span class="monospaced">&lt;c-defn&gt;</span> clauses;
the two variants correspond to the quoted and bracketed
forms of the C preprocessor&#8217;s <span class="monospaced">#include</span> directive.</p></div>
<div class="paragraph"><p>The <span class="monospaced">&lt;c-defn&gt;</span> clauses bind identifiers.
A <span class="monospaced">(const <em>x</em> <em>t</em> "<em>ae</em>")</span> clause binds <em>x</em> to
the integer value of <em>ae</em> according to the C language;
<em>ae</em> can be any C arithmetic expression that evaluates
to a value of type <em>t</em>.
(The expected usage is for <em>ae</em> to be an
expression that the C preprocessor expands to an arithmetic expression.)</p></div>
<div class="paragraph"><p>The remaining clauses provide similar functionality:</p></div>
<div class="ulist"><ul>
<li>
<p>
<span class="monospaced">(sizeof <em>x</em> "<em>te</em>")</span>
 binds <em>x</em> to the size occupied by values
 of type <em>te</em>, where <em>te</em> is any C type expression.
</p>
</li>
<li>
<p>
<span class="monospaced">(struct "<em>cn</em>" &#8230; (<em>x</em> "<em>cf</em>" <em>y</em>) &#8230;)</span>
 binds <em>x</em> to the offset from the start of a
 structure of type <span class="monospaced">struct <em>cn</em></span> to its
 <em>cf</em> field, and binds <em>y</em>, if present, to the field&#8217;s size.
 A <span class="monospaced">fields</span> clause is similar, but it applies
 to structures of type <span class="monospaced"><em>cn</em></span> rather than <span class="monospaced">struct <em>cn</em></span>.
</p>
</li>
<li>
<p>
<span class="monospaced">(ifdefconst <em>x</em> <em>t</em> "<em>cn</em>")</span>
 binds <em>x</em> to the value of <span class="monospaced"><em>cn</em></span> if <span class="monospaced"><em>cn</em></span> is defined;
 <em>x</em> is otherwise bound to Larceny&#8217;s unspecified value.
</p>
</li>
</ul></div>
</div>
<div class="sect3">
<h4 id="_foreign_sugar">13.10.2. foreign-sugar</h4>
<div class="paragraph"><p>The <a href="#foreign-procedure">[foreign-procedure]</a> function is sufficient to link in
dynamically loaded C procedures, but it can be annoying to
use when there are many procedures to define that all follow
a regular pattern where one could infer a mapping between
Scheme identifiers and C function names.</p></div>
<div class="paragraph"><p>For example, some libraries follow a naming convention where a words
within a name are separated by underscores; such functions could be
immediately mapped to Scheme names where the underscores have been
replaced by dashes.</p></div>
<div class="paragraph"><p>The foreign-sugar library provides a special form, <span class="monospaced">define-foreign</span>,
which gives the user a syntax for defining foreign functions using
a syntax where one provides only the Scheme name, the argument types,
and the return type.  The <span class="monospaced">define-foreign</span> form then attempts to
infer what C function the name was meant to refer to.</p></div>
<div class="paragraph"><p><em>Syntax define-foreign</em></p></div>
<div class="paragraph"><p><span class="monospaced"> (define-foreign (name arg-type &#8230;) result-type)</span></p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">There is other functionality provided allowing the user to
introduce new rules for inferring C function names, but they are
undocumented because they will probably have to change when we switch
to an R6RS macro expander.</td>
</tr></table>
</div>
</div>
<div class="sect3">
<h4 id="_foreign_stdlib">13.10.3. foreign-stdlib</h4>
<div class="paragraph"><p><anchor id="stdlib/malloc" xreflabel="stdlib/malloc"></anchor>
<em>Procedure <var>stdlib/malloc</var></em>
<br />
<code>(stdlib/malloc <em>rtd</em> <em>[ctor]</em>)  =&gt; <em>procedure</em></code>
<br /></p></div>
<div class="paragraph"><p>Given a record extension of <em>void*-rt</em>, returns an allocator that uses
the C <span class="monospaced">malloc</span> procedure to allocate instances of such an object.
Note that the client is responsible for eventually freeing such
objects with <a href="#stdlib/free">[stdlib/free]</a>.</p></div>
<div class="paragraph"><p><anchor id="stdlib/free" xreflabel="stdlib/free"></anchor>
<em>Procedure <var>stdlib/free</var></em>
<br />
<code>(stdlib/free <em>void*-obj</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Frees objects produced by allocators returned from <a href="#stdlib/malloc">[stdlib/malloc]</a>.</p></div>
<div class="paragraph"><p><anchor id="ffi-install-void*-subtype" xreflabel="ffi-install-void*-subtype"></anchor>
<em>Procedure <var>ffi-install-void*-subtype</var></em>
<br />
<br />
<anchor id="ffi-install-void*-subtype" xreflabel="ffi-install-void*-subtype"></anchor>
<code>(ffi-install-void*-subtype <em>rtd</em>)  =&gt; <em>rtd</em></code>
<br />
<anchor id="ffi-install-void*-subtype" xreflabel="ffi-install-void*-subtype"></anchor>
<code>(ffi-install-void*-subtype <em>string</em> <em>[parent-rtd]</em>)  =&gt; <em>rtd</em></code>
<br />
<anchor id="ffi-install-void*-subtype" xreflabel="ffi-install-void*-subtype"></anchor>
<code>(ffi-install-void*-subtype <em>symbol</em> <em>[parent-rtd]</em>)  =&gt; <em>rtd</em></code>
<br /></p></div>
<div class="paragraph"><p><a href="#ffi-install-void*-subtype">[ffi-install-void*-subtype]</a>
extends the core attribute registry with a new primitive
entry for <em>subtype</em>.
The <em>parent-rtd</em> argument should be a subtype of <span class="monospaced">void*-rt</span>
and defaults to <span class="monospaced">void*-rt</span>.
In the case of the <em>symbol</em> or <em>string</em> inputs, the
procedure constructs a new record type subtyping the <em>parent</em> argument.
In the case of the <em>rtd</em> input, the <em>rtd</em> record type
must extend <span class="monospaced">void*-rt</span>.
<a href="#ffi-install-void*-subtype">[ffi-install-void*-subtype]</a> returns the subtype record type.</p></div>
<div class="paragraph"><p>The returned record type represents a tagged wrapped C pointer,
allowing one to encode type hierarchies.</p></div>
<div class="paragraph"><p><anchor id="establish-void*-subhierarchy!" xreflabel="establish-void*-subhierarchy!"></anchor>
<em>Procedure <var>establish-void*-subhierarchy!</var></em>
<br />
<code>(establish-void*-subhierarchy! <em>symbol-tree</em>)  =&gt; <em>unspecified</em></code>
<br /></p></div>
<div class="paragraph"><p><a href="#establish-void*-subhierarchy!">[establish-void*-subhierarchy!]</a> is a convenience function
for constructing large object hierarchies.
It descends the <em>symbol-tree</em>,
creates a record type descriptor for each symbol
(where the root of the tree has the parent <span class="monospaced">void*-rt</span>),
and invokes <a href="#ffi-install-void*-subtype">[ffi-install-void*-subtype]</a> on all
of the introduced types.</p></div>
<div class="paragraph"><p><em>Type char*</em> extends <em>void*</em>
<anchor id="string&#8594;char*" xreflabel="string&#8594;char*"></anchor>
<em>Procedure <var>string&#8594;char*</var></em>
<br />
<code>(string&#8594;char* <em>string</em>)  =&gt; <em>char*</em></code>
<br />
<anchor id="char*-strlen" xreflabel="char*-strlen"></anchor>
<em>Procedure <var>char*-strlen</var></em>
<br />
<code>(char*-strlen <em>char*</em>)  =&gt; <em>fixnum</em></code>
<br />
<anchor id="char*&#8594;string" xreflabel="char*&#8594;string"></anchor>
<em>Procedure <var>char*&#8594;string</var></em>
<br />
<code>(char*&#8594;string <em>char*</em>)  =&gt; <em>string</em></code>
<br />
<anchor id="char*&#8594;string" xreflabel="char*&#8594;string"></anchor>
<code>(char*&#8594;string <em>char* len</em>)  =&gt; <em>string</em></code>
<br />
<anchor id="CallWithCharStar" xreflabel="CallWithCharStar"></anchor>
<em>Procedure <var>CallWithCharStar</var></em>
<br />
<code>(call-with-char* <em>string string-function</em>)  =&gt; <em>value</em></code>
<br />
<em>Type char**</em> extends <em>void*</em>
<anchor id="CallWithCharStarStar" xreflabel="CallWithCharStarStar"></anchor>
<em>Procedure <var>CallWithCharStarStar</var></em>
<br />
<code>(call-with-char** <em>string-vector function</em>)  =&gt; <em>value</em></code>
<br />
<em>Type int*</em> extends <em>void*</em>
<anchor id="CallWithIntStar" xreflabel="CallWithIntStar"></anchor>
<em>Procedure <var>CallWithIntStar</var></em>
<br />
<code>(call-with-int* <em>fixnum-vector function</em>)  =&gt; <em>value</em></code>
<br />
<em>Type short*</em> extends <em>void*</em>
<anchor id="CallWithShortStar" xreflabel="CallWithShortStar"></anchor>
<em>Procedure <var>CallWithShortStar</var></em>
<br />
<code>(call-with-short* <em>fixnum-vector function</em>)  =&gt; <em>value</em></code>
<br />
<em>Type double*</em> extends <em>void*</em>
<anchor id="CallWithDoubleStar" xreflabel="CallWithDoubleStar"></anchor>
<em>Procedure <var>CallWithDoubleStar</var></em>
<br />
<code>(call-with-double* <em>num-vector function</em>)  =&gt; <em>value</em></code>
<br /></p></div>
<div class="paragraph"><p>FIXME: (There are other functions, but I want to test and document the
ones above first&#8230;)</p></div>
</div>
<div class="sect3">
<h4 id="_foreign_cstructs">13.10.4. foreign-cstructs</h4>
<div class="paragraph"><p>The <span class="monospaced">foreign-cstructs</span> library provides a
more direct interface to C structures.
It provides the <span class="monospaced">define-c-struct</span> special form.
This form is layered on top of <span class="monospaced">define-c-info</span>;
the latter provides the structure field offsets
and sizes used to generate constructors
(which produce appropriately sized bytevectors,
not record instances).
The <span class="monospaced">define-c-struct</span> form combines these
with marshaling and unmarshaling procedures to
provide high-level access to a structure.</p></div>
<div class="paragraph"><p>The grammar for the <span class="monospaced">define-c-struct</span> form is presented below.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>&lt;exp&gt;    ::= (define-c-struct (&lt;struct-type&gt; &lt;ctor-id&gt; &lt;c-decl&gt; ...)
                &lt;field-clause&gt; ...)

&lt;field-clause&gt;
         ::= (&lt;c-field&gt; &lt;getter&gt;) | (&lt;c-field&gt; &lt;getter&gt; &lt;setter&gt;)

&lt;getter&gt; ::= (&lt;id&gt;) | (&lt;id&gt; &lt;unmarshal&gt;)

&lt;setter&gt; ::= (&lt;id&gt;) | (&lt;id&gt; &lt;marshal&gt;)

&lt;marshal&gt; ::= &lt;ffi-attr-symbol&gt; | &lt;marshal-proc-exp&gt;

&lt;unmarshal&gt; ::= &lt;ffi-attr-symbol&gt; | &lt;unmarshal-proc-exp&gt;

&lt;struct-type&gt; ::= &lt;string-literal&gt;</pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_foreign_cenums">13.10.5. foreign-cenums</h4>
<div class="paragraph"><p>This library provides the special forms
 <span class="monospaced">define-c-enum</span> and <span class="monospaced">define-c-enum-set</span>,
which associate the identifiers of
a C <span class="monospaced">enum</span> type declaration
with the integer values they denote.</p></div>
<div class="paragraph"><p>The <span class="monospaced">define-c-enum</span> form describes enums
encoding a discriminated sum;
<span class="monospaced">define-c-enum-set</span> describes bitmasks,
mapping them to R<sup>6</sup>RS enum-sets in Scheme.</p></div>
<div class="paragraph"><p>The <span class="monospaced">(define-c-enum <em>en</em> (&lt;c-decl&gt; &#8230;)  (<em>x</em> "<em>cn</em>") &#8230;)</span>
form adds the <span class="monospaced"><em>en</em></span> FFI attribute.
The attribute marshals each symbol <span class="monospaced"><em>x</em></span> to
the integer value that <span class="monospaced"><em>cn</em></span> denotes in C;
unmarshaling does the inverse translation.</p></div>
<div class="paragraph"><p>The <span class="monospaced">(define-c-enum-set <em>ens</em> (&lt;c-decl&gt; &#8230;) (<em>x</em> "<em>cn</em>") &#8230;)</span>
form binds <em>ens</em> to an R<sup>6</sup>RS enum-set constructor
with universe resulting from
<span class="monospaced">(make-enumeration '(<em>x</em> &#8230;))</span>; it also adds the <span class="monospaced"><em>ens</em></span>
FFI attribute.  The attribute marshals an
enum-set <em>s</em> constructed by <em>ens</em>
to the corresponding bitmask in C (that is,
the integer one would get by logically or&#8217;ing
all <em>cn</em> such that the corresponding <em>x</em> is in <em>s</em>).
Unmarshaling attempts to do the inverse translation.</p></div>
<div class="paragraph"><p>The grammar for the two forms is presented below.</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>&lt;exp&gt; ::= (define-c-enum &lt;enum-id&gt; (&lt;c-decl&gt; ...)
            (&lt;id&gt; &lt;c-name&gt;) ...)

&lt;exp&gt; ::= (define-c-enum-set &lt;enum-id&gt; (&lt;c-decl&gt; ...)
            (&lt;id&gt; &lt;c-name&gt;) ...)

&lt;enum-id&gt; ::= &lt;id&gt;</pre>
</div></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="DebuggingChapter">14. Debugging</h2>
<div class="sectionbody">
<div class="paragraph"><p>Larceny&#8217;s debugging functionality is implemented in Scheme, using some
of Larceny&#8217;s extensions for catching exceptions and inspecting the
continuation structure.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph"><p>Larceny&#8217;s debugger is most useful in R5RS mode because Larceny&#8217;s
R7RS/R6RS macro expander discards the file name and line number
information it is given by the <span class="monospaced">read</span> procedure.  The R7RS/R6RS
macro expander also mangles identifiers, and the debugger does
not currently un-mangle mangled identifiers.  To add to the
difficulty, R7RS/R6RS semantics allows compiler optimizations
that obscure the correspondence between source code and run-time
representations displayed by the debugger.</p></div>
</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_entering_the_debugger">14.1. Entering the debugger</h3>
<div class="paragraph"><p>When Larceny detects an error or a keyboard interrupt, or when it hits
a breakpoint, it signals the condition by printing a message on the
console. Larceny then enters the debugger, which signals its presence
with a short banner and the debugger prompt:</p></div>
<div class="literalblock">
<div class="content monospaced">
<pre>Entering debugger; type "?" for help.
debug&gt;</pre>
</div></div>
<div class="paragraph"><p>You can also re-enter the debugger by evaluating (debug).</p></div>
</div>
<div class="sect2">
<h3 id="_debugger_commands">14.2. Debugger commands</h3>
<div class="paragraph"><p>The debugger is still in an immature state. The following commands are available (commands can be typed in upper or lower case):</p></div>
<div class="paragraph"><p><strong>B</strong>     Print backtrace of continuation.</p></div>
<div class="paragraph"><p><strong>C</strong>     Print source code of procedure, if available.</p></div>
<div class="paragraph"><p><strong>D</strong>     Move down to previous (earlier) activation record.</p></div>
<div class="paragraph"><p><strong>E <em>n expr</em></strong>      <em>Expr</em> is evaluated in the current
interaction environment and must evaluate to a procedure.
It is passed the contents of slot <em>n</em> from the current
activation record, and the result, if not unspecified,
is printed.</p></div>
<div class="paragraph"><p><strong>E <em>(n1 &#8230; nk) expr</em></strong>      <em>Expr</em> is evaluated in the current
interaction environment and must evaluate to a procedure. It is
passed the contents of slots <em>n1</em> through <em>nk</em> from the current
activation record, and the result, if not unspecified, is printed.</p></div>
<div class="paragraph"><p><strong>I <em>n</em></strong>      Inspect the procedure in slot <em>n</em> of the current
activation record.</p></div>
<div class="paragraph"><p><strong>I @</strong>      Inspect the active procedure.</p></div>
<div class="paragraph"><p><strong>Q</strong>      Quit the debugger and abort the computation.</p></div>
<div class="paragraph"><p><strong>R</strong>      Return from the debugger and continue the computation.</p></div>
<div class="paragraph"><p><strong>S</strong>      Summarize the contents of the current activation record.</p></div>
<div class="paragraph"><p><strong>U</strong>      Up to the next (later) activation record.</p></div>
<div class="paragraph"><p><strong>X</strong>      Examine the contents of the current activation record.</p></div>
<div class="paragraph"><p>The <strong>B</strong>, <strong>D</strong>, and <strong>U</strong> commands can be prefixed with a count, for example, 5 U moves up five activation records, and 10 B displays the next 10 activation records. The default for <strong>B</strong> is to display all the activations; the default count for <strong>D</strong> and <strong>U</strong> is 1.</p></div>
</div>
<div class="sect2">
<h3 id="_breakpoints">14.3. Breakpoints</h3>
<div class="paragraph"><p>You can set breakpoints either in program text with the break primitive or interactively at the start of a procedure with the break-entry procedure. When Larceny reaches a breakpoint during execution, the program is suspended and the debugger is entered to allow you to inspect the program.</p></div>
<div class="paragraph"><p><anchor id="larceny-break" xreflabel="larceny-break"></anchor>
<em>Procedure <var>larceny-break</var></em>
<br />
<code>(larceny-break <em></em>) </code>
<br /></p></div>
<div class="paragraph"><p>Invokes the breakpoint handler.</p></div>
<div class="paragraph"><p><anchor id="break-entry" xreflabel="break-entry"></anchor>
<em>Procedure <var>break-entry</var></em>
<br />
<code>(break-entry <em>procedure</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Set a breakpoint at the start of the <em>procedure</em>.</p></div>
<div class="paragraph"><p><anchor id="unbreak" xreflabel="unbreak"></anchor>
<em>Procedure <var>unbreak</var></em>
<br />
<code>(unbreak <em>procedure &#8230;</em>) </code>
<br /></p></div>
<div class="paragraph"><p><anchor id="unbreak" xreflabel="unbreak"></anchor>
<code>(unbreak <em></em>) </code>
<br /></p></div>
<div class="paragraph"><p>In the first form, remove any breakpoint set by break-entry
at the start of the procedures.
In the second form, remove all breakpoints set by <em>break-entry</em>.</p></div>
</div>
<div class="sect2">
<h3 id="_tracing">14.4. Tracing</h3>
<div class="paragraph"><p><anchor id="trace-entry" xreflabel="trace-entry"></anchor>
<em>Procedure <var>trace-entry</var></em>
<br />
<code>(trace-entry <em>procedure</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Set a trace point on entry to the <em>procedure</em>, removing any other trace points on the procedure. When the <em>procedure</em> is entered, information about the call is printed on the console: the name of the procedure and the actual arguments.</p></div>
<div class="paragraph"><p><anchor id="trace-exit" xreflabel="trace-exit"></anchor>
<em>Procedure <var>trace-exit</var></em>
<br />
<code>(trace-exit <em>procedure</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Set a trace point on exit from the <em>procedure</em>, removing any other trace points on the procedure. When the <em>procedure</em> returns, information about the return is printed on the console: the name of the procedure and the returned values.</p></div>
<div class="paragraph"><p>Note that trace-exit destroys the tail recursion properties of the instrumented procedure. Where the <em>procedure</em> would normally "return" by tail-calling another procedure, the instrumented procedure will call the other procedure by a non-tail call and then return, at which point the procedure name and return values will be printed. Thus use of trace-exit may destroy the space properties of the program.</p></div>
<div class="paragraph"><p><anchor id="trace" xreflabel="trace"></anchor>
<em>Procedure <var>trace</var></em>
<br />
<code>(trace <em>procedure</em>) </code>
<br /></p></div>
<div class="paragraph"><p>Set trace points on <em>procedure</em> both at entry and exit.</p></div>
<div class="paragraph"><p><anchor id="untrace" xreflabel="untrace"></anchor>
<em>Procedure <var>untrace</var></em>
<br />
<code>(untrace <em>procedure &#8230;</em>) </code>
<br /></p></div>
<div class="paragraph"><p><anchor id="untrace" xreflabel="untrace"></anchor>
<code>(untrace <em></em>) </code>
<br /></p></div>
<div class="paragraph"><p>The first form removes any trace points from the specified procedures.
The second form removes all trace points.</p></div>
</div>
<div class="sect2">
<h3 id="_other_functionality">14.5. Other functionality</h3>
<div class="paragraph"><p><a id="break-handler"></a>

<em>Parameter break-handler</em></p></div>
<div class="paragraph"><p>The value of break-handler is a procedure that is called when a breakpoint or tracepoint is encountered. The procedure takes two arguments: the procedure in which the breakpoint was set, and the byte offset within the procedure&#8217;s code vector of the breakpoint.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Standards">15. Standards</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_scheme_standards">15.1. Scheme standards</h3>
<div class="paragraph"><p>IEEE Standard 1178-1990,
"IEEE Standard for the Scheme Programming Language",
IEEE, 1991. ISBN 1-55937-125-0.
May be ordered from IEEE by calling 1-800-678-IEEE or 908-981-1393
or writing
IEEE Service Center, 445 Hoes Lane, P.O. Box 1331,
Piscataway, NJ 08855-1331, and using order number SH14209.</p></div>
<div class="paragraph"><p>Richard Kelsey, William Clinger, and Jonathan Rees [editors].
<a href="http://www.brics.dk/~hosc/11-1/">Revised^5 Report
on the Algorithmic Language Scheme</a>.
<em>Journal of Higher Order and Symbolic Computation</em>,
11(1), 1998, pages 7-105.
Also appears in <em>ACM SIGPLAN Notices</em> 33(9), September 1998.
Available online
<a href="http://www.schemers.org/Documents/Standards/R5RS/">in various formats</a>.</p></div>
<div class="paragraph"><p>Michael Sperber, R Kent Dybvig, Matthew Flatt, and Anton van Straaten
[editors].
<a href="http://www.r6rs.org/">Revised^6 Report
on the Algorithmic Language Scheme</a>, 2007.
(This standard was approved by 66% of 102 votes.)</p></div>
<div class="paragraph"><p>Alex Shinn, John Cowan, and Arthur A Gleckler [editors].
<a href="http://www.scheme-reports.org/">Revised^7 Report
on the Algorithmic Language Scheme</a>, 2013.
(This standard was approved by 86% of 63 votes.)</p></div>
<div class="paragraph"><p>John Cowan [editor].
<a href="http://trac.sacrideo.us/wg/wiki/RedEdition">R7RS Red Edition</a>, 2016.</p></div>
</div>
<div class="sect2">
<h3 id="_other_relevant_standards">15.2. Other relevant standards</h3>
<div class="paragraph"><p>IEEE Standard 754-1985,
"IEEE Standard for Binary Floating-Point Arithmetic",
IEEE, 1985.</p></div>
<div class="paragraph"><p>IEEE Standard 754-2008,
"IEEE Standard for Floating-Point Arithmetic",
IEEE, 2008.
(<a href="http://en.wikipedia.org/wiki/IEEE_754r">Revision of IEEE Std 754-1985</a>
began in 2000.
The IEEE Microprocessor Standards Committee (MSC)
accepted a candidate draft on 9 October 2006.
The candidate draft 1.2.6 was approved by 79% of 70 votes,
which exceeded the required supermajority of 75%.
Because there were negative votes and several hundred comments,
however, a revised draft 1.3.0 was prepared and approved by
84% of 73 votes.
Since there were over a hundred comments on the
second candidate draft as well, a third candidate draft 1.4.0 was
prepared and another vote taken in April 2007.
After a total of eight ballots, with the last four being
approved by more than 90% of the voters, the Ballot Review
Committee decided in May 2008 that
<a href="http://www.validlab.com/754R/">maximum possible timely
consensus has been obtained</a>, and the consensus draft was
submitted to IEEE-SA RevCom.
IEEE-754-2008 was approved on 12 June 2008.)</p></div>
<div class="paragraph"><p>The Unicode Consortium.
<a href="http://www.unicode.org/">The Unicode Standard</a>.</p></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr></div>
<div id="footer">
<div id="footer-text">
Last updated 2017-08-06 05:30:22 EDT
</div>
</div>
</body>
</html>
